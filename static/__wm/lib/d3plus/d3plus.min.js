(function(){var d3plus=window.d3plus||{};window.d3plus=d3plus;d3plus.version="1.1.11 - Navy";d3plus.ie=false;d3plus.fontawesome=false;var sheets=document.styleSheets;for(var s=0;s<sheets.length;s++){if(sheets[s].href&&sheets[s].href.indexOf("font-awesome")>=0){d3plus.fontawesome=true;break}}d3plus.rtl=d3.select("html").attr("dir")=="rtl";d3plus.scrollbar=function(){var inner=document.createElement("p");inner.style.width="100%";inner.style.height="200px";var outer=document.createElement("div");outer.style.position="absolute";outer.style.top="0px";outer.style.left="0px";outer.style.visibility="hidden";outer.style.width="200px";outer.style.height="150px";outer.style.overflow="hidden";outer.appendChild(inner);document.body.appendChild(outer);var w1=inner.offsetWidth;outer.style.overflow="scroll";var w2=inner.offsetWidth;if(w1==w2)w2=outer.clientWidth;document.body.removeChild(outer);var val=w1-w2;d3plus.scrollbar=function(){return val};return val};d3.select(window).on("load.d3plus_scrollbar",function(){d3plus.scrollbar()});d3plus.evt={};if(window.Modernizr&&Modernizr.touch){d3plus.evt.click="touchend";d3plus.evt.down="touchstart";d3plus.evt.up="touchend";d3plus.evt.over="touchstart";d3plus.evt.out="touchend";d3plus.evt.move="touchmove"}else{d3plus.evt.click="click";d3plus.evt.down="mousedown";d3plus.evt.up="mouseup";if(d3plus.ie){d3plus.evt.over="mouseenter";d3plus.evt.out="mouseleave"}else{d3plus.evt.over="mouseover";d3plus.evt.out="mouseout"}d3plus.evt.move="mousemove"}d3plus.svg=true;if(window.Modernizr&&Modernizr.svg===false){d3plus.svg=false}d3plus.apps={};d3plus.color={};d3plus.console={};d3plus.data={};d3plus.forms={};d3plus.info={};d3plus.shape={};d3plus.styles={};d3plus.tooltip={};d3plus.utils={};d3plus.variable={};d3plus.zoom={};d3plus.console.print=function(type,message,style){if(d3plus.ie)console.log("[d3plus] "+message);else console[type]("%c[d3plus]%c "+message,"font-weight:bold;",style)};d3plus.console.log=function(message,style){if(!style)var style="font-weight:bold;";d3plus.console.print("log",message,style)};d3plus.console.group=function(message,style){if(!style)var style="font-weight:bold;";d3plus.console.print("group",message,style)};d3plus.console.warning=function(message,style){if(!style)var style="font-weight:bold;color:red;";message="WARNING: "+message;d3plus.console.print("log",message,style)};d3plus.console.groupEnd=function(){if(!d3plus.ie)console.groupEnd()};d3plus.console.time=function(message){if(!d3plus.ie)console.time(message)};d3plus.console.timeEnd=function(message){if(!d3plus.ie)console.timeEnd(message)};d3plus.public={};d3plus.public.active={key:null,mute:{value:[]},solo:{value:[]},spotlight:{accepted:[true,false],value:false,deprecates:["spotlight"]}};d3plus.public.aggs={value:{},deprecated:["nesting_aggs"]};d3plus.public.axes={mirror:{accepted:[true,false],value:false,deprecates:["mirror_axis","mirror_axes"]},values:["x","y"]};d3plus.public.attrs={value:{}};d3plus.public.color={deprecates:["color_var"],key:null,mute:{value:[]},solo:{value:[]}};d3plus.public.container={value:null};d3plus.public.coords={fit:{accepted:["auto","height","width"],value:"auto"},mute:{value:[]},padding:20,projection:{accepted:["mercator","equirectangular"],value:"mercator"},solo:{value:[]},value:null};d3plus.public.data={value:[]};d3plus.public.depth={value:0};d3plus.public.descs={value:{}};d3plus.public.dev={accepted:[true,false],value:false};d3plus.public.error={value:false};d3plus.public.focus={value:null,deprecates:["highlight"]};d3plus.public.footer={value:false};d3plus.public.height={small:250,value:null};d3plus.public.html={deprecates:["click_function"],value:null};d3plus.public.icon={deprecates:["icon_var"],key:"icon",style:{deprecates:["icon_style"],object:true,value:"default"}};d3plus.public.id={data_filter:true,deprecates:["id_var","nesting"],key:"id",mute:{value:[],deprecates:["filter"]},nesting:["id"],solo:{value:[],deprecates:["solo"]}};d3plus.public.labels={accepted:[true,false],value:true};d3plus.public.legend={accepted:[true,false],label:null,order:{accepted:["alpha","color"],sort:{accepted:["asc","desc"],value:"asc"},value:"color"},value:true};d3plus.public.links={arrows:{direction:{accepted:["source","target"],value:"target"},value:false},deprecates:["edges"],large:100,label:false,limit:false,value:null};d3plus.public.nodes={value:null};d3plus.public.number_format={value:function(number,key,vars){if(vars&&vars.time.key&&key==vars.time.key){return number}else if(number<10&&number>-10){return d3.round(number,2)}else if(number.toString().split(".")[0].length>4){var symbol=d3.formatPrefix(number).symbol;symbol=symbol.replace("G","B");number=d3.formatPrefix(number).scale(number);number=parseFloat(d3.format(".3g")(number));return number+symbol}else if(key=="share"){return d3.format(".2f")(number)}else{return d3.format(",f")(number)}}};d3plus.public.order={key:null,sort:{accepted:["asc","desc"],value:"asc",deprecates:["sort"]}};d3plus.public.shape={accepted:["circle","donut","line","square","area","coordinates"],value:null,interpolate:{accepted:["linear","step","step-before","step-after","basis","basis-open","cardinal","cardinal-open","monotone"],value:"linear",deprecates:["stack_type"]}};d3plus.public.size={data_filter:true,deprecates:["value"],key:null,mute:{value:[]},scale:{accepted:["sqrt","linear","log"],deprecates:["size_scale"],value:"sqrt"},solo:{value:[]},threshold:.03};d3plus.public.temp={deprecates:["else_var","else"],key:null,mute:{value:[]},solo:{value:[]}};d3plus.public.text={deprecates:["name_array","text_var"],key:null,mute:{value:[]},solo:{value:[]}};d3plus.public.text_format={value:function(text,key,vars){if(!text)return"";return text.replace(/\w\S*/g,function(txt){return txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase()})}};d3plus.public.time={data_filter:true,deprecates:["year","year_var"],fixed:{accepted:[true,false],value:true,deprecates:["static_axis","static_axes"]},key:null,mute:{value:[]},solo:{value:[]}};d3plus.public.timeline={accepted:[true,false],value:true,label:null};d3plus.public.title={value:null,sub:{value:null,deprecates:["sub_title"]},total:{value:false,deprecates:["total_bar"],object:true}};d3plus.public.tooltip={deprecates:["tooltip_info"],value:[],object:true};d3plus.public.total={deprecates:["total_var"],key:null,mute:{value:[]},solo:{value:[]}};d3plus.public.type={value:"tree_map"};d3plus.public.width={small:300,value:null};d3plus.public.x={data_filter:true,deprecates:["xaxis","xaxis_val","xaxis_var"],domain:null,key:null,lines:[],mute:{value:[]},reset:["x_range"],scale:{accepted:["linear","log","continuous","share"],value:"linear",deprecates:["layout","unique_axis","xaxis_scale"]},stacked:{accepted:[true,false],value:false},solo:{value:[]},zerofill:{accepted:[true,false],value:false}};d3plus.public.y={data_filter:true,deprecates:["yaxis","yaxis_val","yaxis_var"],domain:null,key:null,lines:[],mute:{value:[]},reset:["y_range"],scale:{accepted:["linear","log","continuous","share"],value:"linear",deprecates:["layout","unique_axis","yaxis_scale"]},stacked:{accepted:[true,false],value:false},solo:{value:[]},zerofill:{accepted:[true,false],value:false}};d3plus.public.zoom={scroll:{accepted:[true,false],value:false,deprecates:["scroll_zoom"]}};d3plus.ui=function(passed){var vars={before:null,callback:false,data:[],dev:false,enabled:false,filter:"",flipped:false,format:d3plus.public.text_format.value,highlight:false,hover:false,id:"default",init:false,"max-height":600,"max-width":600,parent:d3.select("body"),previous:false,propagation:true,selected:false,text:"text",timing:400};var styles={align:"left",border:"all",color:"#ffffff",corners:0,display:"inline-block","font-family":"'HelveticaNeue-Light', 'Helvetica Neue Light', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'","font-size":12,"font-spacing":0,"font-weight":"lighter",height:false,margin:0,padding:4,secondary:d3plus.color.darker("#ffffff",.05),shadow:5,stroke:1,width:false};styles["font-align"]=d3plus.rtl?"right":"left";styles.icon=d3plus.fontawesome?"fa-angle-down":"&#x27A4;";if(passed){styles=d3plus.utils.merge(styles,passed)}vars.ui=function(selection,timing){if(typeof timing!="number"){var timing=vars.init?vars.timing:0}if(vars.data instanceof Array&&typeof vars.data.select!="function"){vars.data={array:vars.data}}else if(typeof vars.data=="object"&&!vars.data.array&&!(vars.data instanceof Array)){if(!vars.data.array){vars.data.array=[]}if(vars.element){d3plus.forms.element(vars)}d3plus.forms.data(vars);var focus=vars.data.array.filter(function(d){return d.value==vars.focus})[0];if(!focus){vars.data.array[0].selected=true;vars.focus=vars.data.array[0].value}vars.data.changed}else if(vars.data&&!vars.data.array){var d3selection=d3plus.ie?typeof vars.data.select=="function":vars.data instanceof d3.selection;if(typeof vars.data=="string"&&!d3.select(vars.data).empty()){vars.element=d3.selectAll(vars.data);if(vars.data.charAt(0)=="#"){vars.before=vars.data}}else if(d3selection){vars.element=vars.data;if(vars.data.node().id){vars.before="#"+vars.data.node().id}}vars.data={array:[]}}if(vars.data.array.length==0&&vars.element){vars.parent=d3.select(vars.element.node().parentNode);d3plus.forms.element(vars)}if(typeof vars.data.array=="string"){d3plus.console.warning('Cannot create UI element for "'+vars.data.array+'", no data found.')}else if(!(vars.data.array instanceof Array)){d3plus.console.warning("Cannot create UI element, no data found.")}else{if(!vars.focus){vars.data.array[0].selected=true;vars.focus=vars.data.array[0].value;if(vars.dev)d3plus.console.log('"value" set to "'+vars.focus+'"')}if(vars.data.array.length>10&&!("search"in vars)){vars.search=true;if(vars.dev)d3plus.console.log("search enabled")}if(vars.element){vars.element.style("position","absolute").style("overflow","hidden").style("clip","rect(0 0 0 0)").style("width","1px").style("height","1px").style("margin","-1px").style("padding","0").style("border","0");if(vars.data.changed&&vars.type=="drop"){options=vars.element.selectAll("option").data(vars.data.array,function(d){return d?d.value:false});options.enter().append("option").each(function(d){for(k in d){if(["alt","value","text","selected"].indexOf(k)>=0){d3.select(this).attr(k,d[k])}else{d3.select(this).attr("data-"+k,d[k])}}});options.exit().remove()}}vars.container=vars.parent.selectAll("div#d3plus_"+vars.type+"_"+vars.id).data(["container"]);vars.container.enter().insert("div",vars.before).attr("id","d3plus_"+vars.type+"_"+vars.id).style("display","inline-block").style("position","relative").style("overflow","visible").style("vertical-align","top");vars.container.transition().duration(timing).each("start",function(){if(vars.type=="drop"&&vars.enabled){d3.select(this).style("z-index",9999)}}).style("margin",styles.margin+"px").each("end",function(){if(vars.type=="drop"&&!vars.enabled){d3.select(this).style("z-index","auto")}});vars.tester=d3.select("body").selectAll("div.d3plus_tester").data(["tester"]);vars.tester.enter().append("div").attr("class","d3plus_tester").style("position","absolute").style("left","-9999px").style("top","-9999px").style("visibility","hidden").style("display","block");if(vars.dev)d3plus.console.group('drawing "'+vars.type+'"');d3plus.forms[vars.type](vars,styles,timing);if(vars.dev)d3plus.console.groupEnd();if(!vars.init){vars.init=true}vars.data.changed=false}};var variables=["callback","data","dev","element","highlight","hover","id","parent","previous","propagation","search","selected","timing","text","type"];variables.forEach(function(v){vars.ui[v]=function(key){return function(value){if(vars.dev){var text=value.toString();if(text.length>50){var text=""}else{var text=' to "'+text+'"'}}if(!arguments.length)return vars[key];if(["element","parent"].indexOf(key)>=0){var d3selection=d3plus.ie?typeof value=="object"&&value instanceof Array:value instanceof d3.selection;if(typeof value=="string"&&!d3.select(value).empty()){if(vars.dev)d3plus.console.log('"'+key+'" set'+text);vars[key]=d3.selectAll(value)}else if(d3selection){if(vars.dev)d3plus.console.log('"'+key+'" set'+text);vars[key]=value}else{d3plus.console.warning('Cannot set "'+key+'" as "'+value.toString()+'"')}if(vars[key]&&key=="element"){if(vars[key].node().id){vars.before="#"+vars[key].node().id}vars.parent=d3.select(vars[key].node().parentNode)}}else{if(vars.dev)d3plus.console.log('"'+key+'" set'+text);vars[key]=value}return vars.ui}}(v)});var style_variables=["align","icon","border","color","corners","display","font","margin","padding","shadows"];style_variables.forEach(function(v){vars.ui[v]=function(key){return function(value){if(!arguments.length)return styles[key];if(vars.dev){var text=value.toString();if(text.length>50){var text=""}else{var text=' to "'+text+'"'}}if(key=="font"){if(typeof value=="string"){if(vars.dev)d3plus.console.log('"font-family" set'+text);styles["font-family"]=value}if(typeof value=="number"){if(vars.dev)d3plus.console.log('"font-size" set'+text);styles["font-size"]=value}else if(typeof value=="object"){for(style in value){if(style=="align"&&d3plus.rtl){if(value[style]=="left"){value[style]="right"}else if(value[style]=="right"){value[style]="left"}}if(vars.dev){var text=value[style].toString();if(text.length>50){var text=""}else{var text=' to "'+text+'"'}d3plus.console.log('"font-'+style+'" set'+text)}styles["font-"+style]=value[style]}}}else{if(key=="color"&&styles.secondary==d3plus.color.darker(styles.color,.05)){styles.secondary=d3plus.color.darker(value,.05)}if(vars.dev)d3plus.console.log('"'+key+'" set'+text);styles[key]=value}return vars.ui}}(v)});vars.ui.disable=function(){if(vars.dev)d3plus.console.log("disable");vars.enabled=false;if(vars.init){vars.parent.call(vars.ui)}return vars.ui};vars.ui.enable=function(){if(vars.dev)d3plus.console.log("enable");vars.enabled=true;if(vars.data.fetch&&(!vars.data.loaded||vars.data.continuous)){d3plus.forms.json(vars)}if(vars.init){vars.parent.call(vars.ui)}return vars.ui};vars.ui.draw=function(timing){vars.parent.call(vars.ui,timing);return vars.ui};vars.ui.height=function(value){if(!arguments.length)return vars.container[0][0].offsetHeight;if(vars.dev)d3plus.console.log('"height" set to "'+value+'"');styles.height=value;return vars.ui};vars.ui.remove=function(x){vars.container.remove()};vars.ui.select=function(selection){return vars.container.select(selection)};vars.ui.value=function(value){if(!arguments.length)return vars.focus;if(typeof value=="string"){value=vars.data.array.filter(function(d){return d.value==value})[0]}if(value.value!=vars.focus){if(vars.tag=="select"){vars.element.selectAll("option").each(function(d,i){if(this.value==value.value){vars.element.node().selectedIndex=i}})}else if(vars.tag=="input"&&vars.element.attr("type")=="radio"){vars.element.each(function(){if(this.value==value.value){this.checked=true}else{this.checked=false}})}if(vars.callback){vars.callback(value.value)}if(vars.dev)d3plus.console.log('"value" set to "'+value.value+'"');vars.previous=vars.focus;vars.focus=value.value}vars.enabled=false;vars.highlight=false;if(vars.init){vars.parent.call(vars.ui)}return vars.ui};vars.ui.toggle=function(){if(vars.dev)d3plus.console.log("toggle");if(vars.enabled){vars.ui.disable()}else{vars.ui.enable()}return vars.ui};vars.ui.width=function(value){if(!arguments.length){var vals=[];vars.container.selectAll("div.d3plus_node").each(function(o){vals.push(this.offsetWidth)});if(vals.length>1){return vals.sort()}else if(vals.length==1){return vals[0]}else{return vars.container.node().offsetWidth}}if(vars.dev)d3plus.console.log('"width" set to "'+value+'"');styles.width=value;return vars.ui};return vars.ui};d3plus.viz=function(){var vars={autodraw:false,connections:function(focus,objects){var links=vars.links.restricted||vars.links.value,targets=[];if(!focus){return links}var connections=links.filter(function(link){var check=["source","target"],match=false;if(typeof link.source!="object"){var obj={};obj[vars.id.key]=link.source;link.source=obj}if(typeof link.target!="object"){var obj={};obj[vars.id.key]=link.target;link.target=obj}if(link.source[vars.id.key]==focus){match=true;if(objects){targets.push(link.target)}}else if(link.target[vars.id.key]==focus){match=true;if(objects){targets.push(link.source)}}return match});return objects?targets:connections},filtered:false,footer_text:function(){var text=vars.html.value||vars.tooltip.value.long?"Click for More Info":null;return vars.text_format.value(text)},format:function(value,key){if(typeof value==="number")return vars.number_format.value(value,key,vars);if(typeof value==="string")return vars.text_format.value(value,key,vars);else return JSON.stringify(value)},frozen:false,g:{apps:{}},graph:{},margin:{top:0,right:0,bottom:0,left:0},mute:[],solo:[],style:d3plus.styles.default};vars.viz=function(selection){selection.each(function(){vars.frozen=true;if(vars.container.changed){vars.parent=d3.select(vars.container.value);vars.parent.style("overflow","hidden").style("position",function(){var current=d3.select(this).style("position"),remain=["absolute","fixed"].indexOf(current)>=0;return remain?current:"relative"}).html("");var sizes=["width","height"];sizes.forEach(function(s){if(!vars[s].value){function check_parent(element){if(element.tagName=="BODY"){var val=window["inner"+s.charAt(0).toUpperCase()+s.slice(1)];if(s=="width"){val-=parseFloat(d3.select(element).style("margin-left"),10);val-=parseFloat(d3.select(element).style("margin-right"),10);val-=parseFloat(d3.select(element).style("padding-left"),10);val-=parseFloat(d3.select(element).style("padding-right"),10)}else if(s=="height"){val-=parseFloat(d3.select(element).style("margin-top"),10);val-=parseFloat(d3.select(element).style("margin-bottom"),10);val-=parseFloat(d3.select(element).style("padding-top"),10);val-=parseFloat(d3.select(element).style("padding-bottom"),10)}vars[s].value=val}else{var val=parseFloat(d3.select(element).style(s),10);if(typeof val=="number"&&val>0){vars[s].value=val}else if(element.tagName!="BODY"){check_parent(element.parentNode)}}}check_parent(vars.parent.node())}});vars.parent.style("width",vars.width.value+"px").style("height",vars.height.value+"px")}if(d3plus.apps[vars.type.value].setup){if(vars.dev.value)d3plus.console.group('Running setup function for "'+vars.type.value+'"');d3plus.apps[vars.type.value].setup(vars);if(vars.dev.value)d3plus.console.groupEnd()}d3plus.data.analyze(vars);d3plus.data.color(vars);if(vars.type.previous&&vars.type.value!=vars.type.previous){d3plus.tooltip.remove(vars.type.previous)}d3plus.tooltip.remove(vars.type.value);vars.svg=vars.parent.selectAll("svg#d3plus").data(["d3plus"]);vars.svg.enter().append("svg").attr("id","d3plus").attr("width",vars.width.value).attr("height",vars.height.value).attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:xmlns:xlink","http://www.w3.org/1999/xlink");vars.g.bg=vars.svg.selectAll("rect#bg").data(["bg"]);vars.g.bg.enter().append("rect").attr("id","bg").attr("fill",vars.style.background).attr("width",vars.width.value).attr("height",vars.height.value);vars.g.titles=vars.svg.selectAll("g#titles").data(["titles"]);vars.g.titles.enter().append("g").attr("id","titles");vars.g.timeline=vars.svg.selectAll("g#timeline").data(["timeline"]);vars.g.timeline.enter().append("g").attr("id","timeline").attr("transform","translate(0,"+vars.height.value+")");vars.g.key=vars.svg.selectAll("g#key").data(["key"]);vars.g.key.enter().append("g").attr("id","key").attr("transform","translate(0,"+vars.height.value+")");vars.g.footer=vars.svg.selectAll("g#footer").data(["footer"]);vars.g.footer.enter().append("g").attr("id","footer").attr("transform","translate(0,"+vars.height.value+")");vars.g.clipping=vars.svg.selectAll("#clipping").data(["clipping"]);vars.g.clipping.enter().append("clipPath").attr("id","clipping").append("rect").attr("width",vars.app_width).attr("height",vars.app_height);vars.g.container=vars.svg.selectAll("g#container").data(["container"]);vars.g.container.enter().append("g").attr("id","container").attr("clip-path","url(#clipping)").attr("transform","translate("+vars.margin.left+","+vars.margin.top+")");vars.g.zoom=vars.g.container.selectAll("g#zoom").data(["zoom"]);vars.g.zoom.enter().append("g").attr("id","zoom").attr("transform","translate("+vars.margin.left+","+vars.margin.top+")");vars.g.app=vars.g.zoom.selectAll("g#app").data(["app"]);vars.g.app.enter().append("g").attr("id","app");vars.g.apps[vars.type.value]=vars.g.app.selectAll("g#"+vars.type.value).data([vars.type.value]);vars.g.apps[vars.type.value].enter().append("g").attr("id",vars.type.value);vars.g.links=vars.g.zoom.selectAll("g#links").data(["links"]);vars.g.links.enter().append("g").attr("id","links");vars.g.link_focus=vars.g.zoom.selectAll("g#link_focus").data(["link_focus"]);vars.g.link_focus.enter().append("g").attr("id","link_focus").attr("opacity",0);vars.g.data=vars.g.zoom.selectAll("g#data").data(["data"]);vars.g.data.enter().append("g").attr("id","data");vars.defs=vars.svg.selectAll("defs").data(["defs"]);vars.defs.enter().append("defs");vars.app_width=vars.width.value;d3plus.info.titles(vars);d3plus.info.legend(vars);d3plus.info.timeline(vars);vars.app_height=vars.height.value-vars.margin.top-vars.margin.bottom;vars.graph.height=vars.app_height-vars.graph.margin.top-vars.graph.margin.bottom;vars.parent.transition().duration(vars.style.timing.transitions).style("width",vars.width.value+"px").style("height",vars.height.value+"px");vars.svg.transition().duration(vars.style.timing.transitions).attr("width",vars.width.value).attr("height",vars.height.value);vars.g.bg.transition().duration(vars.style.timing.transitions).attr("width",vars.width.value).attr("height",vars.height.value);vars.g.clipping.select("rect").transition().duration(vars.style.timing.transitions).attr("width",vars.app_width).attr("height",vars.app_height);vars.g.container.transition().duration(vars.style.timing.transitions).attr("transform","translate("+vars.margin.left+","+vars.margin.top+")");var reqs=["id"];if(d3plus.apps[vars.type.value].requirements){reqs=reqs.concat(d3plus.apps[vars.type.value].requirements)}var missing=[];reqs.forEach(function(r){var key="key"in vars[r]?"key":"value";if(!vars[r][key])missing.push(r)});if(missing.length){vars.internal_error="The following variables need to be set: "+missing.join(", ")}if(!vars.internal_error&&reqs.indexOf("links")>=0&&reqs.indexOf("focus")>=0){var connections=vars.connections(vars.focus.value);if(connections.length==0){vars.internal_error='No Connections Available for "'+d3plus.variable.text(vars,vars.focus.value,vars.depth.value)+'"'}}var reqs=["d3"];if(d3plus.apps[vars.type.value].libs){reqs=reqs.concat(d3plus.apps[vars.type.value].libs)}var missing=[];reqs.forEach(function(r){if(!window[r])missing.push(r)});if(missing.length){vars.internal_error="The following libraries need to be loaded: "+missing.join(", ")}if(!vars.shape.value){vars.shape.value=d3plus.apps[vars.type.value].shapes[0]}else if(d3plus.apps[vars.type.value].shapes.indexOf(vars.shape.value)<0){d3plus.console.warning('"'+vars.shape.value+'" is not an accepted shape for the "'+vars.type.value+'" app, please use one of the following: "'+d3plus.apps[vars.type.value].shapes.join('", "')+'"');vars.shape.previous=vars.shape.value;vars.shape.value=d3plus.apps[vars.type.value].shapes[0];d3plus.console.log('Defaulting shape to "'+vars.shape.value+'"')}if(vars.type.previous&&vars.type.value!=vars.type.previous&&vars.g.apps[vars.type.previous]){if(vars.dev.value)d3plus.console.group('Hiding "'+vars.type.previous+'"');vars.g.apps[vars.type.previous].transition().duration(vars.style.timing.transitions).attr("opacity",0);if(vars.dev.value)d3plus.console.groupEnd()}vars.group=vars.g.apps[vars.type.value];vars.group.transition().duration(vars.style.timing.transitions).attr("opacity",function(){if(vars.data.app.length==0||vars.internal_error)return 0;else return 1});vars.mouse={};if(!vars.internal_error){if(vars.dev.value)d3plus.console.group('Calculating "'+vars.type.value+'"');var returned=d3plus.apps[vars.type.value].draw(vars);if(vars.dev.value)d3plus.console.groupEnd()}else{var returned=null}vars.returned={nodes:null,links:null};if(returned instanceof Array){vars.returned.nodes=returned}else if(returned){if(returned.nodes){vars.returned.nodes=returned.nodes}if(returned.links){vars.returned.links=returned.links}}if(!vars.returned.nodes||!(vars.returned.nodes instanceof Array)||!vars.returned.nodes.length){if(vars.dev.value)d3plus.console.log("No data returned by app.");vars.returned.nodes=[]}d3plus.shape.links(vars,vars.returned.links);d3plus.shape.draw(vars,vars.returned.nodes);if(!vars.internal_error){if(!vars.error.value&&!vars.data.app||!vars.returned.nodes.length){vars.internal_error="No Data Available"}else if(vars.error.value){vars.data.app=null;if(vars.error.value===true){vars.internal_error="Error"}else{vars.internal_error=vars.error.value}}else{vars.internal_error=null}}d3plus.info.error(vars);function reset_change(obj){if(obj.changed)obj.changed=false;else{for(o in obj){if(Object.keys(d3plus.public).indexOf(o)>=0){if(o=="changed"&&obj[o])obj[o]=false;else if(obj[o]!=null&&typeof obj[o]=="object"){reset_change(obj[o])}}}}}reset_change(vars);setTimeout(function(){vars.frozen=false},vars.style.timing.transitions);vars.internal_error=null});return vars.viz};vars.viz.csv=function(x){if(x instanceof Array)var columns=x;var csv_to_return=[],titles=[],title=vars.title.value||"My D3plus App Data";title=d3plus.utils.strip(title);if(!columns){var columns=[vars.id.key];if(vars.time.key)columns.push(vars.time.key);if(vars.size.key)columns.push(vars.size.key);if(vars.text.key)columns.push(vars.text.key)}columns.forEach(function(c){titles.push(vars.format(c))});csv_to_return.push(titles);vars.returned.nodes.forEach(function(n){var arr=[];columns.forEach(function(c){arr.push(d3plus.variable.value(vars,n,c))});csv_to_return.push(arr)});var csv_data="data:text/csv;charset=utf-8,";csv_to_return.forEach(function(c,i){dataString=c.join(",");csv_data+=i<csv_to_return.length?dataString+"\n":dataString});if(d3plus.ie){var blob=new Blob([csv_data],{type:"text/csv;charset=utf-8;"});navigator.msSaveBlob(blob,title+".csv")}else{var encodedUri=encodeURI(csv_data);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download",title+".csv");link.click()}return csv_to_return};vars.viz.draw=function(x){if(x){if(typeof x=="boolean"){vars.autodraw=x}else{d3plus.console.warning('.draw() only accepts booleans to change the "autodraw" functionality.')}}if(!vars.container.value){d3plus.console.warning("Please define a container div using .container()")}else if(d3.select(vars.container.value).empty()){d3plus.console.warning('Cannot find <div> on page matching: "'+vars.container+'"')}else{d3.select(vars.container.value).call(vars.viz)}return vars.viz};vars.viz.style=function(x){if(!arguments.length)return vars.style;function check_depth(object,property,depth){if(typeof depth=="object"&&!(depth instanceof Array)){for(d in depth){if(object[property]===undefined){d3plus.console.warning('"'+property+'" cannot be set')}else{check_depth(object[property],d,depth[d])}}}else{if(object[property]===undefined){d3plus.console.warning('"'+property+'" cannot be set')}else{object[property]=depth}}}if(typeof x=="object"){check_depth(vars,"style",x)}else if(typeof x=="string"){if(d3plus.styles[x]){vars.style=plus.styles[x]}else{d3plus.console.warning('Style "'+x+'" does not exist. Installed styles are: "'+Object.keys(d3plus.styles).join('", "')+'"')}}else{d3plus.console.warning(".style() only accepts strings or keyed objects.")}return vars.viz};Object.keys(d3plus.public).forEach(function(p){vars[p]=d3plus.utils.copy(d3plus.public[p]);if(p=="type"){vars[p].accepted=Object.keys(d3plus.apps)}if(vars[p]){function deprecate(obj){for(o in obj){if(o=="deprecates"){obj[o].forEach(function(d){vars.viz[d]=function(dep,n){return function(x){d3plus.console.warning("."+dep+"() method has been deprecated, please use the new ."+n+"() method.");return vars.viz}}(d,p)})}else if(typeof obj[o]=="object"){deprecate(obj[o])}}}deprecate(vars[p])}vars.viz[p]=function(key){return function(user){if(!arguments.length)return vars[key];if(vars[key].reset){vars[key].reset.forEach(function(r){vars[r]=null})}if(vars[key].key!==undefined)var key_type="key";else if(vars[key].value!==undefined)var key_type="value";else var key_type=null;if(typeof user=="object"&&key_type&&!user[key_type]&&!(Object.keys(user)[0]in vars[key])||typeof user!="object"){set_value(vars[key],key_type,user)}else if(typeof user=="object"){check_object(vars,key,user)}else{d3plus.console.warning("Incompatible format for ."+key+"() method.")}function check_object(object,property,depth){if(object[property]===undefined){d3plus.console.warning('"'+property+'" cannot be set.')}else{if(typeof depth=="object"&&!(depth instanceof Array)){if(typeof object[property]=="object"&&object[property]!==null){if(object[property].key!==undefined)var key_type="key";else if(object[property].value!==undefined)var key_type="value";else var key_type=null}else var key_type=null;if(property==key_type){set_value(object,key_type,depth)}else if(["key","value"].indexOf(property)>=0){set_value(object,property,depth)}else if(typeof object[property]=="object"&&object[property]!==null&&object[property].object===true){set_value(object[property],key_type,depth)}else{for(d in depth){check_object(object[property],d,depth[d])}}}else{set_value(object,property,depth)}}}function update_array(arr,x){if(x instanceof Array){arr=x}else if(arr.indexOf(x)>=0){arr.splice(arr.indexOf(x),1)}else{arr.push(x)}return arr}function set_value(a,b,c){if(key=="type"){if(!a.accepted){a.accepted=Object.keys(d3plus.apps)}if(a.accepted.indexOf(c)<0){for(app in d3plus.apps){if(d3plus.apps[app].deprecates&&d3plus.apps[app].deprecates.indexOf(c)>=0){d3plus.console.warning(JSON.stringify(c)+" has been deprecated by "+JSON.stringify(app)+", please update your code.");c=app}}}}if(vars.dev.value||key=="dev"){if(b=="value"||b=="key"||!b){var text="."+key+"()"}else{var text='"'+b+'" of .'+key+"()"}}if((b=="value"||b=="key")&&a.accepted){var accepted=a.accepted}else if(typeof a[b]=="object"&&a[b]!==null&&a[b].accepted){var accepted=a[b].accepted}else{var accepted=false}if(accepted&&accepted.indexOf(c)<0){d3plus.console.warning(""+JSON.stringify(c)+" is not an accepted value for "+text+', please use one of the following: "'+accepted.join('", "')+'"')}else if(!(a[b]instanceof Array)&&a[b]==c||a[b]&&(a[b].key==c||a[b].value==c)){if(vars.dev.value)d3plus.console.log(text+" was not updated because it did not change.")}else{if(b=="solo"||b=="mute"){a[b].value=update_array(a[b].value,c);a[b].changed=true;var arr=a[b].value;if(key!="time"){if(arr.length&&vars[b].indexOf(key)<0){vars[b].push(key)}else if(!arr.length&&vars[b].indexOf(key)>=0){vars[b].splice(vars[b].indexOf(key),1)}}}else if(key=="id"&&b=="key"){if(c instanceof Array){vars.id.nesting=c;if(vars.depth.value<c.length)vars.id.key=c[vars.depth.value];else{vars.id.key=c[0];vars.depth.value=0}}else{vars.id.key=c;vars.id.nesting=[c];vars.depth.value=0}a.changed=true}else if(key=="text"&&b=="key"){if(!vars.text.array)vars.text.array={};if(typeof c=="string"){vars.text.array[vars.id.key]=[c]}else if(c instanceof Array){vars.text.array[vars.id.key]=c}else{vars.text.array=c;var n=c[vars.id.key]?c[vars.id.key]:c[Object.keys(c)[0]];vars.text.array[vars.id.key]=typeof n=="string"?[n]:n}vars.text.key=vars.text.array[vars.id.key][0];a.changed=true}else if(key=="depth"){if(c>=vars.id.nesting.length)vars.depth.value=vars.id.nesting.length-1;else if(c<0)vars.depth.value=0;else vars.depth.value=c;vars.id.key=vars.id.nesting[vars.depth.value];if(vars.text.array){var n=vars.text.array[vars.id.key];if(n){vars.text.array[vars.id.key]=typeof n=="string"?[n]:n;vars.text.key=vars.text.array[vars.id.key][0]}}a.changed=true}else if(key=="aggs"){for(agg in c){if(a[b][agg]&&a[b][agg]==c[agg]){if(vars.dev.value)d3plus.console.log('Aggregation for "'+agg+'" is already set to "'+c[agg]+'"')
}else{a[b][agg]=c[agg];a.changed=true}}}else{if(typeof a[b]=="object"&&a[b]!=null&&(a[b].key!==undefined||a[b].value!==undefined)){var k=a[b].key!==undefined?"key":"value";a=a[b];b=k}a.previous=a[b];a[b]=c;a.changed=true}if((vars.dev.value||key=="dev")&&(a.changed||["solo","mute"].indexOf(b)>=0)){if(typeof a[b]!="function"&&JSON.stringify(a[b]).length<260){d3plus.console.log(text+" has been set to "+JSON.stringify(a[b])+".")}else{d3plus.console.log(text+" has been set.")}}}}if(vars.autodraw){return vars.viz.draw()}else{return vars.viz}}}(p)});return vars.viz};d3plus.apps.bubbles={};d3plus.apps.bubbles.data="nested";d3plus.apps.bubbles.fill=true;d3plus.apps.bubbles.tooltip="static";d3plus.apps.bubbles.shapes=["circle","donut"];d3plus.apps.bubbles.scale=1.05;d3plus.apps.bubbles.draw=function(vars){var label_height=vars.labels.value&&!vars.small?50:0;var order=vars.order.key||vars.size.key;vars.data.app.sort(function(a,b){var a_value=d3plus.variable.value(vars,a,order);var b_value=d3plus.variable.value(vars,b,order);return vars.order.sort.value=="asc"?a_value-b_value:b_value-a_value});if(vars.data.app.length==1){var columns=1,rows=1}else if(vars.data.app.length<4){var columns=vars.data.app.length,rows=1}else{var rows=Math.ceil(Math.sqrt(vars.data.app.length/(vars.app_width/vars.app_height))),columns=Math.ceil(Math.sqrt(vars.data.app.length*(vars.app_width/vars.app_height)))}if(vars.data.app.length>0){while((rows-1)*columns>=vars.data.app.length)rows--}var column_width=vars.app_width/columns,column_height=vars.app_height/rows;if(!vars.data.app)vars.data.app=[];var domain_min=d3.min(vars.data.app,function(d){if(!vars.size.key)return 0;return d3plus.variable.value(vars,d,vars.size.key,null,"min")});var domain_max=d3.max(vars.data.app,function(d){if(!vars.size.key)return 0;return d3plus.variable.value(vars,d,vars.size.key)});var padding=5;var size_min=20;var size_max=d3.min([column_width,column_height])/2-padding*2;size_max-=label_height;var size=d3.scale[vars.size.scale.value]().domain([domain_min,domain_max]).range([size_min,size_max]);var pack=d3.layout.pack().size([column_width-padding*2,column_height-padding*2-label_height]).value(function(d){if(!vars.size.key)return 0;return d3plus.variable.value(vars,d,vars.size.key)}).padding(padding).radius(function(d){return size(d)});var data=[];var row=0;vars.data.app.forEach(function(d,i){var temp=pack.nodes(d);var xoffset=column_width*i%vars.app_width,yoffset=column_height*row;temp.forEach(function(t){if(!t.d3plus)t.d3plus={};if(!t.d3plus.depth)t.d3plus.depth=t.depth;t.xoffset=xoffset;t.yoffset=yoffset+label_height;if(t.depth<vars.depth.value){t.d3plus.static=true}else{t.d3plus.static=false}if(temp.length==1){t.d3plus.label=false}else{t.d3plus.label=true}});data=data.concat(temp);if((i+1)%columns==0){row++}});var downscale=size_max/d3.max(data,function(d){return d.r});data.forEach(function(d){d.x=(d.x-column_width/2)*downscale+column_width/2;d.d3plus.x=d.x+d.xoffset;d.y=(d.y-column_height/2)*downscale+column_height/2;d.d3plus.y=d.y+d.yoffset;d.r=d.r*downscale;d.d3plus.r=d.r});data.sort(function(a,b){return a.depth-b.depth});var label_data=data.filter(function(d){return d.depth==0});var labels=vars.group.selectAll("text.d3plus_bubble_label").data(label_data,function(d){if(!d.d3plus.label_height)d.d3plus.label_height=0;return d[vars.id.nesting[d.depth]]});function label_style(l){l.attr("x",function(d){return d.d3plus.x}).attr("y",function(d){return d.d3plus.y-d.r-d.d3plus.label_height-padding}).attr("text-anchor","middle").style("font-weight",vars.style.font.weight).attr("font-family",vars.style.font.family).attr("font-size","12px").style("fill",function(d){var color=d3plus.variable.color(vars,d);return d3plus.color.legible(color)}).each(function(d){if(d.r>10&&label_height>10){var names=d3plus.variable.text(vars,d,d.depth);d3plus.utils.wordwrap({text:names,parent:this,width:column_width-padding*2,height:label_height})}}).attr("y",function(d){d.d3plus.label_height=d3.select(this).node().getBBox().height;return d.d3plus.y-d.r-d.d3plus.label_height-padding}).selectAll("tspan").attr("x",function(d){return d.d3plus.x})}labels.enter().append("text").attr("class","d3plus_bubble_label").call(label_style).attr("opacity",0);labels.transition().duration(vars.style.timing.transitions).call(label_style).attr("opacity",1);labels.exit().attr("opacity",0).remove();return data};d3plus.apps.chart={};d3plus.apps.chart.data="grouped";d3plus.apps.chart.fill=true;d3plus.apps.chart.deprecates=["pie_scatter","scatter"];d3plus.apps.chart.requirements=["x","y"];d3plus.apps.chart.tooltip="static";d3plus.apps.chart.shapes=["circle","donut","line","square","area"];d3plus.apps.chart.scale={circle:1.1,donut:1.1,square:1.1};d3plus.apps.chart.draw=function(vars){if(vars.data.app.length){if(!vars.tickValues)vars.tickValues={};vars.continuous_axis=null;vars.opp_axis=null;vars.stacked_axis=null;vars.axes.values.forEach(function(axis){if(vars[axis].stacked.value){vars.stacked_axis=axis}if(!vars.continuous_axis&&vars[axis].scale.value=="continuous"){vars.continuous_axis=axis;vars.opp_axis=axis=="x"?"y":"x"}if(vars.data.changed||vars.depth.changed||!vars[axis+"_range"]||vars.time.fixed.value){if(vars.dev.value)d3plus.console.time("determining "+axis+"-axis");if(vars[axis].scale.value=="share"){vars[axis+"_range"]=[0,1];vars.tickValues[axis]=d3plus.utils.buckets([0,1],11);vars.stacked_axis=axis}else if(vars[axis].stacked.value){if(vars.time.fixed.value){var range_data=vars.data.app}else{var range_data=vars.data.restricted.all}var xaxis_sums=d3.nest().key(function(d){return d[vars.x.key]}).rollup(function(leaves){return d3.sum(leaves,function(d){return parseFloat(d3plus.variable.value(vars,d,vars[axis].key))})}).entries(range_data);vars[axis+"_range"]=[0,d3.max(xaxis_sums,function(d){return d.values})]}else if(vars[axis].domain instanceof Array){vars[axis+"_range"]=vars[axis].domain;vars.tickValues[axis]=d3plus.utils.uniques(vars.data.app,vars[axis].key);vars.tickValues[axis]=vars.tickValues[axis].filter(function(t){return t>=vars[axis+"_range"][0]&&t<=vars[axis+"_range"][1]})}else if(vars.time.fixed.value){vars[axis+"_range"]=d3.extent(vars.data.app,function(d){return parseFloat(d3plus.variable.value(vars,d,vars[axis].key))});vars.tickValues[axis]=d3plus.utils.uniques(vars.data.app,vars[axis].key)}else{var all_depths=[];for(id in vars.id.nesting){all_depths=all_depths.concat(vars.data.grouped[vars.id.nesting[id]].all)}vars[axis+"_range"]=d3.extent(all_depths,function(d){return parseFloat(d3plus.variable.value(vars,d,vars[axis].key))});vars.tickValues[axis]=d3plus.utils.uniques(vars.data.restricted.all,vars[axis].key)}if(vars[axis+"_range"][0]==vars[axis+"_range"][1]){vars[axis+"_range"][0]-=1;vars[axis+"_range"][1]+=1}if(axis=="y")vars.y_range=vars.y_range.reverse();if(vars.dev.value)d3plus.console.timeEnd("determining "+axis+"-axis")}else if(!vars[axis+"_range"]){vars[axis+"_range"]=[-1,1]}});if(vars.axes.mirror.value){var domains=vars.y_range.concat(vars.x_range);vars.x_range=d3.extent(domains);vars.y_range=d3.extent(domains).reverse()}if(vars.dev.value)d3plus.console.time("removing data outside of axes");var old_length=vars.data.app.length;if(vars.y.scale.value=="share"){var data=vars.data.app}else{var data=vars.data.app.filter(function(d){var val=parseFloat(d3plus.variable.value(vars,d,vars.y.key));var y_include=val!=null&&val<=vars.y_range[0]&&val>=vars.y_range[1];if(y_include){var val=parseFloat(d3plus.variable.value(vars,d,vars.x.key));return val!=null&&val>=vars.x_range[0]&&val<=vars.x_range[1]}else return false})}if(vars.dev.value)d3plus.console.timeEnd("removing data outside of axes");var removed=old_length-data.length;if(removed&&vars.dev.value)console.log("removed "+removed+" nodes");if(data){if(vars.dev.value)d3plus.console.time("determining size scale");if(vars.size.key){if(vars.time.fixed.value){var size_domain=d3.extent(vars.data.app,function(d){var val=d3plus.variable.value(vars,d,vars.size.key);return val==0?null:val})}else{var all_depths=[];for(id in vars.id.nesting){all_depths=all_depths.concat(vars.data.grouped[vars.id.nesting[id]].all)}var size_domain=d3.extent(all_depths,function(d){var val=d3plus.variable.value(vars,d,vars.size.key);return val==0?null:val})}if(!size_domain[0]||!size_domain[1])size_domain=[0,0]}else{var size_domain=[0,0]}var max_size=Math.floor(d3.max([d3.min([vars.graph.width,vars.graph.height])/15,10])),min_size=10;if(size_domain[0]==size_domain[1])var min_size=max_size;var size_range=[min_size,max_size];var radius=d3.scale[vars.size.scale.value]().domain(size_domain).range(size_range);if(vars.dev.value)d3plus.console.timeEnd("determining size scale")}vars.axes.values.forEach(function(axis){var range_max=axis=="x"?vars.graph.width:vars.graph.height;if(["continuous","share"].indexOf(vars[axis].scale.value)>=0){var s="linear"}else{var s=vars[axis].scale.value}vars[axis+"_scale"]=d3.scale[s]().domain(vars[axis+"_range"]).range([0,range_max]);var continuous_buffer=["continuous","share"].indexOf(vars[axis].scale.value)>=0;if(["square","circle","donut"].indexOf(vars.shape.value)>=0&&!continuous_buffer){if(vars[axis].scale.value!="log"){var scale=vars[axis+"_scale"];var inverse_scale=d3.scale[s]().domain(scale.range()).range(scale.domain());var largest_size=radius.range()[1]*2;largest_size=inverse_scale(largest_size);var buffer=largest_size-scale.domain()[0];buffer=vars.stacked_axis?0:buffer;vars[axis+"_scale"].domain([scale.domain()[0]-buffer,scale.domain()[1]+buffer])}}var orient=axis=="x"?"bottom":"left";vars[axis+"_axis"]=d3.svg.axis().tickSize(10).tickPadding(5).orient(orient).scale(vars[axis+"_scale"]).tickFormat(function(d,i){var visible=true;if(vars[axis].key==vars.time.key&&d%1!=0){visible=false}if((vars[axis].scale.value=="log"&&d.toString().charAt(0)=="1"||vars[axis].scale.value!="log")&&visible){if(vars[axis].scale.value=="share"){var text=d*100+"%"}else{var text=vars.format(d,vars[axis].key)}d3.select(this).style("font-size",vars.style.ticks.font.size).style("fill",vars.style.ticks.font.color).attr("font-family",vars.style.font.family).attr("font-weight",vars.style.font.weight).text(text);if(axis=="x"){var w=this.getBBox().width,h=this.getBBox().height;d3.select(this).attr("transform","translate(18,8)rotate(70)");var height=Math.cos(25)*w+5;if(height>vars.graph.yoffset&&!vars.small){vars.graph.yoffset=height}var width=Math.cos(25)*h+5;if(width>vars.graph.rightoffset&&!vars.small){vars.graph.rightoffset=width}}else{var width=this.getBBox().width;if(width>vars.graph.offset&&!vars.small){vars.graph.offset=width}}}else{var text=null}return text});if(vars[axis].scale.value=="continuous"&&vars.tickValues[axis]){vars[axis+"_axis"].tickValues(vars.tickValues[axis])}})}if(!data){var data=[]}function tick_style(t,axis){t.attr("stroke",vars.style.ticks.color).attr("stroke-width",vars.style.ticks.width).attr("shape-rendering",vars.style.rendering).style("opacity",function(d){var lighter=vars[axis].scale.value=="log"&&d.toString().charAt(0)!="1";return lighter?.25:1})}function tick_position(t,axis){t.attr("x1",function(d){return axis=="x"?vars.x_scale(d):0}).attr("x2",function(d){return axis=="x"?vars.x_scale(d):vars.graph.width}).attr("y1",function(d){return axis=="y"?vars.y_scale(d):0}).attr("y2",function(d){return axis=="y"?vars.y_scale(d):vars.graph.height})}var plane=vars.group.selectAll("g#plane").data(["plane"]);plane.enter().append("g").attr("id","plane").attr("transform","translate("+vars.graph.margin.left+","+vars.graph.margin.top+")");var bg=plane.selectAll("rect#background").data(["background"]);bg.enter().append("rect").attr("id","background").attr("x",0).attr("y",0).attr("width",vars.graph.width).attr("height",vars.graph.height).attr("stroke-width",1).attr("stroke","#ccc").attr("shape-rendering",vars.style.rendering).style("fill","#fafafa");var mirror=plane.selectAll("path#mirror").data(["mirror"]);mirror.enter().append("path").attr("id","mirror").attr("fill","#000").attr("fill-opacity",.03).attr("stroke-width",1).attr("stroke","#ccc").attr("stroke-dasharray","10,10").attr("opacity",0);var axes=vars.group.selectAll("g#axes").data(["axes"]);axes.enter().append("g").attr("id","axes");var xgrid=plane.selectAll("g#xgrid").data(["xgrid"]);xgrid.enter().append("g").attr("id","xgrid");var ygrid=plane.selectAll("g#ygrid").data(["ygrid"]);ygrid.enter().append("g").attr("id","ygrid");var xaxis=plane.selectAll("g#xaxis").data(["xaxis"]);xaxis.enter().append("g").attr("id","xaxis").attr("transform","translate(0,"+vars.graph.height+")");var yaxis=plane.selectAll("g#yaxis").data(["yaxis"]);yaxis.enter().append("g").attr("id","yaxis");var xlabel=axes.selectAll("text#xlabel").data(["xlabel"]);xlabel.enter().append("text").attr("id","xlabel").attr("x",vars.app_width/2).attr("y",vars.app_height-10).text(vars.format(vars.x.key)).attr("font-family",vars.style.font.family).attr("font-weight",vars.style.font.weight).attr("font-size",vars.style.labels.size).attr("fill",vars.style.labels.color).attr("text-anchor",vars.style.labels.align);var ylabel=axes.selectAll("text#ylabel").data(["ylabel"]);ylabel.enter().append("text").attr("id","ylabel").attr("y",15).attr("x",-(vars.graph.height/2+vars.graph.margin.top)).text(vars.format(vars.y.key)).attr("transform","rotate(-90)").attr("font-family",vars.style.font.family).attr("font-weight",vars.style.font.weight).attr("font-size",vars.style.labels.size).attr("fill",vars.style.labels.color).attr("text-anchor",vars.style.labels.align);var mouseevents=vars.group.selectAll("g#mouseevents").data(["mouseevents"]);mouseevents.enter().append("g").attr("id","mouseevents");vars.graph.offset=0;yaxis.call(vars.y_axis).selectAll("line").call(tick_style,"y");vars.graph.margin.left+=vars.graph.offset;vars.graph.width-=vars.graph.offset;vars.x_scale.range([0,vars.graph.width]);vars.graph.yoffset=0;vars.graph.rightoffset=0;xaxis.call(vars.x_axis).selectAll("line").call(tick_style,"x");vars.graph.height-=vars.graph.yoffset;vars.graph.width-=vars.graph.rightoffset;vars.x_scale.range([0,vars.graph.width]);vars.y_scale.range([0,vars.graph.height]);yaxis.call(vars.y_axis);xaxis.call(vars.x_axis);plane.transition().duration(vars.style.timing.transitions).attr("transform","translate("+vars.graph.margin.left+","+vars.graph.margin.top+")");bg.attr("width",vars.graph.width).attr("height",vars.graph.height);mirror.transition().duration(vars.style.timing.transitions).attr("opacity",function(){return vars.axes.mirror.value?1:0}).attr("d",function(){var w=vars.graph.width,h=vars.graph.height;return"M "+w+" "+h+" L 0 "+h+" L "+w+" 0 Z"});yaxis.transition().duration(vars.style.timing.transitions).call(vars.y_axis.scale(vars.y_scale));yaxis.selectAll("line").transition().duration(vars.style.timing.transitions).call(tick_style,"y");yaxis.selectAll("path").style("fill","none");xaxis.transition().duration(vars.style.timing.transitions).attr("transform","translate(0,"+vars.graph.height+")").call(vars.x_axis.scale(vars.x_scale)).selectAll("g.tick").select("text").style("text-anchor","start");xaxis.selectAll("line").transition().duration(vars.style.timing.transitions).call(tick_style,"x");xaxis.selectAll("path").style("fill","none");var ylines=ygrid.selectAll("line").data(vars.y_scale.ticks());ylines.enter().append("line").style("opacity",0).call(tick_position,"y").call(tick_style,"y");ylines.transition().duration(vars.style.timing.transitions).style("opacity",1).call(tick_position,"y").call(tick_style,"y");ylines.exit().transition().duration(vars.style.timing.transitions).style("opacity",0).remove();var xlines=xgrid.selectAll("line").data(vars.x_scale.ticks());xlines.enter().append("line").style("opacity",0).call(tick_position,"x").call(tick_style,"x");xlines.transition().duration(vars.style.timing.transitions).style("opacity",1).call(tick_position,"x").call(tick_style,"x");xlines.exit().transition().duration(vars.style.timing.transitions).style("opacity",0).remove();xlabel.text(vars.format(vars.x.key)).attr("x",vars.app_width/2).attr("y",vars.app_height-10).attr("opacity",function(){if(vars.data.app.length==0)return 0;else return 1});ylabel.text(vars.format(vars.y.key)).attr("y",15).attr("x",-(vars.graph.height/2+vars.graph.margin.top)).attr("opacity",function(){if(vars.data.app.length==0)return 0;else return 1});function get_name(d){if(typeof d=="number"||typeof d=="string"){return null}else{return Object.keys(d)[0]}}function get_val(d){if(typeof d=="number"){return d}else if(typeof d=="string"){return parseFloat(d)}else{var v=d[Object.keys(d)[0]];if(typeof v=="string"){return parseFloat(v)}else{return v}}}vars.axes.values.forEach(function(axis){var lines=plane.selectAll("g.d3plus_"+axis+"line").data(vars[axis].lines,function(l){if(typeof l=="number"||typeof l=="string"){return l}else{return Object.keys(l)[0]}});var enter=lines.enter().append("g").attr("class","d3plus_"+axis+"line");var max=axis=="x"?"height":"width",pos=axis=="x"?vars.graph.height-8+"px":"10px",padding=axis=="x"?10:20;enter.append("line").attr(axis+"1",0).attr(axis+"2",vars.graph[max]).attr("stroke","#ccc").attr("stroke-width",3).attr("stroke-dasharray","10,10");enter.append("text").style("font-size",vars.style.ticks.font.size).style("fill",vars.style.ticks.font.color).attr("text-align","start").attr(axis,pos);lines.selectAll("line").transition().duration(vars.style.timing.transitions).attr(axis+"1",function(d){return get_val(d)?vars[axis+"_scale"](get_val(d)):0}).attr(axis+"2",function(d){return get_val(d)?vars[axis+"_scale"](get_val(d)):0}).attr("opacity",function(d){var yes=get_val(d)>vars[axis+"_scale"].domain()[1]&&get_val(d)<vars[axis+"_scale"].domain()[0];return get_val(d)!=null&&yes?1:0});lines.selectAll("text").transition().duration(vars.style.timing.transitions).text(function(){if(get_val(d)!=null){var v=vars.format(get_val(d),y_name);return get_name(d)?vars.format(get_name(d))+": "+v:v}else return null}).attr(axis,function(d){return vars[axis+"_scale"](get_val(d))+padding+"px"})});if(["line","area"].indexOf(vars.shape.value)>=0){radius.range([2,2])}vars.axis_offset={x:vars.graph.margin.left,y:vars.graph.margin.top};data.forEach(function(d){d.d3plus.x=vars.x_scale(d3plus.variable.value(vars,d,vars.x.key));d.d3plus.x+=vars.axis_offset.x;d.d3plus.r=radius(d3plus.variable.value(vars,d,vars.size.key));if(!vars.stacked_axis){d.d3plus.y=vars.y_scale(d3plus.variable.value(vars,d,vars.y.key));d.d3plus.y+=vars.axis_offset.y;if(vars.shape.value=="area"){d.d3plus[vars.opp_axis+"0"]=vars[vars.opp_axis+"_scale"].range()[1];d.d3plus[vars.opp_axis+"0"]+=vars.axis_offset[vars.opp_axis]}}});if(["line","area"].indexOf(vars.shape.value)>=0){data=d3.nest().key(function(d){var id=d3plus.variable.value(vars,d,vars.id.key),depth=d.d3plus.depth?d.d3plus.depth:0;return id+"_"+depth+"_"+vars.shape.value}).rollup(function(leaves){var availables=d3plus.utils.uniques(leaves,vars[vars.continuous_axis].key),previousMissing=false;vars.tickValues[vars.continuous_axis].forEach(function(v,i,arr){if(availables.indexOf(v)<0){var obj={};obj[vars[vars.continuous_axis].key]=v;obj[vars.id.key]=leaves[0][vars.id.key];obj[vars[vars.opp_axis].key]=vars[vars.opp_axis+"_scale"].domain()[1];obj.d3plus={};obj.d3plus.r=radius(radius.domain()[0]);obj.d3plus[vars.continuous_axis]+=vars.axis_offset[vars.continuous_axis];if(!vars.stacked_axis){obj.d3plus[vars.opp_axis]=vars[vars.opp_axis+"_scale"].range()[1];obj.d3plus[vars.opp_axis]+=vars.axis_offset[vars.opp_axis];obj.d3plus[vars.opp_axis+"0"]=obj.d3plus[vars.opp_axis]}if(vars[vars.continuous_axis].zerofill.value||vars[vars.opp_axis].stacked.value){var position=vars[vars.continuous_axis+"_scale"](v);position+=vars.axis_offset[vars.continuous_axis];obj.d3plus[vars.continuous_axis]=position;leaves.push(obj)}else if(vars.shape.value!="line"){if(!previousMissing&&i>0){var position=vars[vars.continuous_axis+"_scale"](arr[i-1]);position+=vars.axis_offset[vars.continuous_axis];obj.d3plus[vars.continuous_axis]=position;leaves.push(obj)}if(i<arr.length-1){var position=vars[vars.continuous_axis+"_scale"](arr[i+1]);position+=vars.axis_offset[vars.continuous_axis];var obj2=d3plus.utils.copy(obj);obj2.d3plus[vars.continuous_axis]=position;leaves.push(obj2)}}previousMissing=true}else{previousMissing=false}});leaves.sort(function(a,b){var xsort=a.d3plus[vars.continuous_axis]-b.d3plus[vars.continuous_axis];if(xsort)return xsort;var ksort=a[vars[vars.continuous_axis].key]-b[vars[vars.continuous_axis].key];return ksort});return leaves}).entries(data);data.forEach(function(d,i){vars.id.nesting.forEach(function(n,i){if(i<=vars.depth.value&&!d[n]){d[n]=d3plus.utils.uniques(d.values,n).filter(function(unique){return unique&&unique!="undefined"})[0]}})})}var sort=null;if(vars.order.key){sort=vars.order.key}else if(vars.continuous_axis){sort=vars[vars.opp_axis].key}else if(vars.size.key){sort=vars.size.key}if(sort){data.sort(function(a,b){if(a.values instanceof Array){a_value=0;a.values.forEach(function(v){var val=d3plus.variable.value(vars,v,sort);if(val){if(typeof val=="number"){a_value+=val}else{a_value=val}}})}else{a_value=d3plus.variable.value(vars,a,sort)}if(b.values instanceof Array){b_value=0;b.values.forEach(function(v){var val=d3plus.variable.value(vars,v,sort);if(val){if(typeof val=="number"){b_value+=val}else{b_value=val}}})}else{b_value=d3plus.variable.value(vars,b,sort)}if(vars.color.key&&sort==vars.color.key){a_value=d3plus.variable.color(vars,a);b_value=d3plus.variable.color(vars,b);a_value=d3.rgb(a_value).hsl();b_value=d3.rgb(b_value).hsl();if(a_value.s==0)a_value=361;else a_value=a_value.h;if(b_value.s==0)b_value=361;else b_value=b_value.h}if(a_value<b_value)return vars.order.sort.value=="desc"?-1:1;if(a_value>b_value)return vars.order.sort.value=="desc"?1:-1;return 0})}if(vars.stacked_axis){var stack=d3.layout.stack().values(function(d){return d.values}).x(function(d){return d.d3plus.x}).x(function(d){return d.d3plus.y}).y(function(d){var flip=vars.graph.height,val=d3plus.variable.value(vars,d,vars.y.key);return flip-vars.y_scale(val)}).out(function(d,y0,y){var flip=vars.graph.height;if(vars[vars.stacked_axis].scale.value=="share"){d.d3plus.y0=(1-y0)*flip;d.d3plus.y=d.d3plus.y0-y*flip}else{d.d3plus.y0=flip-y0;d.d3plus.y=d.d3plus.y0-y}d.d3plus.y+=vars.graph.margin.top;d.d3plus.y0+=vars.graph.margin.top});var offset=vars[vars.stacked_axis].scale.value=="share"?"expand":"zero";var data=stack.offset(offset)(data)}else if(["area","line"].indexOf(vars.shape.value)<0){function data_tick(l,axis){l.attr("x1",function(d){return axis=="y"?0:d.d3plus.x-vars.graph.margin.left}).attr("x2",function(d){return axis=="y"?-5:d.d3plus.x-vars.graph.margin.left}).attr("y1",function(d){return axis=="x"?vars.graph.height:d.d3plus.y-vars.graph.margin.top}).attr("y2",function(d){return axis=="x"?vars.graph.height+5:d.d3plus.y-vars.graph.margin.top}).style("stroke",function(d){return d3plus.color.legible(d3plus.variable.color(vars,d))}).style("stroke-width",vars.style.data.stroke.width).attr("shape-rendering",vars.style.rendering)}var data_ticks=plane.selectAll("g.d3plus_data_ticks").data(data,function(d){return d[vars.id.key]+"_"+d.d3plus.depth});var tick_enter=data_ticks.enter().append("g").attr("class","d3plus_data_ticks").attr("opacity",0);tick_enter.append("line").attr("class","d3plus_data_y").call(data_tick,"y");data_ticks.selectAll("line.d3plus_data_y").call(data_tick,"y");tick_enter.append("line").attr("class","d3plus_data_x").call(data_tick,"x");data_ticks.selectAll("line.d3plus_data_x").call(data_tick,"x");data_ticks.transition().duration(vars.style.timing.transitions).attr("opacity",1);data_ticks.exit().transition().duration(vars.style.timing.transitions).attr("opacity",0).remove()}function axis_lines(node){var click_remove=d3.event.type=="click"&&(vars.tooltip.value.long||vars.html.value),create=["mouseover","mousemove"].indexOf(d3.event.type)>=0;if(!click_remove&&create&&vars.shape.value!="area"){if(node.data)var node=node.data;var line_data=[d3plus.utils.copy(node.d3plus),d3plus.utils.copy(node.d3plus)];line_data[0].axis="x";line_data[1].axis="y"}else{var line_data=[]}function line_init(l){l.attr("x2",function(d){var ret=d.axis=="x"?d.x:d.x-d.r;return ret}).attr("y2",function(d){var ret=d.axis=="y"?d.y:d.y+d.r;return ret}).style("stroke-width",0).attr("opacity",0)}var lines=mouseevents.selectAll("line.d3plus_axis_label").data(line_data,function(d){return d.axis+"_"+d.id});lines.enter().append("line").attr("class","d3plus_axis_label").call(line_init).attr("x1",function(d){return d.axis=="x"?d.x:d.x-d.r}).attr("y1",function(d){return d.axis=="y"?d.y:d.y+d.r}).style("stroke",function(d){return d3plus.variable.color(vars,node)}).attr("shape-rendering",vars.style.rendering);lines.transition().duration(vars.style.timing.mouseevents).attr("class","d3plus_axis_label").attr("x2",function(d){return d.axis=="x"?d.x:vars.graph.margin.left}).attr("y2",function(d){return d.axis=="y"?d.y:vars.graph.height+vars.graph.margin.top}).style("stroke",function(d){return d3plus.color.legible(d3plus.variable.color(vars,node))}).style("stroke-width",vars.style.data.stroke.width).attr("opacity",1);lines.exit().transition().duration(vars.style.timing.mouseevents).call(line_init).remove();var texts=mouseevents.selectAll("text.d3plus_axis_label").data(line_data,function(d){return d.axis+"_"+d.id});texts.enter().append("text").attr("class","d3plus_axis_label").attr("id",function(d){return d.axis+"_"+d.id}).text(function(d){var val=d3plus.variable.value(vars,node,vars[d.axis].key);return vars.format(val,vars[d.axis].key)}).attr("x",function(d){return d.axis=="x"?d.x:vars.graph.margin.left-5}).attr("y",function(d){return d.axis=="y"?d.y:vars.graph.height+vars.graph.margin.top+5}).attr("dy",function(d){return d.axis=="y"?vars.style.ticks.font.size*.35:vars.style.ticks.font.size}).attr("text-anchor",function(d){return d.axis=="y"?"end":"middle"}).style("fill",function(d){return d3plus.color.legible(d3plus.variable.color(vars,node))}).style("font-size",vars.style.ticks.font.size).attr("font-family",vars.style.font.family).attr("font-weight",vars.style.font.weight).attr("opacity",0);texts.transition().duration(vars.style.timing.mouseevents).delay(vars.style.timing.mouseevents).attr("opacity",1);texts.exit().transition().duration(vars.style.timing.mouseevents).attr("opacity",0).remove();var rects=mouseevents.selectAll("rect.d3plus_axis_label").data(line_data,function(d){return d.axis+"_"+d.id});rects.enter().insert("rect","text").attr("class","d3plus_axis_label").attr("x",function(d){var width=d3.select("text#"+d.axis+"_"+d.id).node().getBBox().width;var ret=d.axis=="x"?d.x:vars.graph.margin.left;return d.axis=="x"?ret-width/2-5:ret-width-10}).attr("y",function(d){var height=d3.select("text#"+d.axis+"_"+d.id).node().getBBox().height;var ret=d.axis=="y"?d.y:vars.graph.height+vars.graph.margin.top;return d.axis=="x"?ret:ret-height/2-5}).attr("width",function(d){var text=d3.select("text#"+d.axis+"_"+d.id).node().getBBox();return text.width+10}).attr("height",function(d){var text=d3.select("text#"+d.axis+"_"+d.id).node().getBBox();return text.height+10}).style("stroke",function(d){return d3plus.color.legible(d3plus.variable.color(vars,node))}).style("fill","white").style("stroke-width",vars.style.data.stroke.width).attr("shape-rendering",vars.style.rendering).attr("opacity",0);rects.transition().duration(vars.style.timing.mouseevents).delay(vars.style.timing.mouseevents).attr("opacity",1);rects.exit().transition().duration(vars.style.timing.mouseevents).attr("opacity",0).remove()}vars.mouse=axis_lines;return data};d3plus.apps.geo_map={};d3plus.apps.geo_map.data="object";d3plus.apps.geo_map.libs=["topojson"];d3plus.apps.geo_map.requirements=["color","coords"];d3plus.apps.geo_map.tooltip="follow";d3plus.apps.geo_map.shapes=["coordinates"];d3plus.apps.geo_map.scale=1;d3plus.apps.geo_map.draw=function(vars){topojson.presimplify(vars.coords.value);var coords=vars.coords.value,key=Object.keys(coords.objects)[0];topo=topojson.feature(coords,coords.objects[key]),features=topo.features;var features=features.filter(function(f){f[vars.id.key]=f.id;if(vars.coords.solo.value.length){return vars.coords.solo.value.indexOf(f.id)>=0}else if(vars.coords.mute.value.length){return vars.coords.mute.value.indexOf(f.id)<0}return true});return features};d3plus.apps.line={};d3plus.apps.line.data="grouped";d3plus.apps.line.requirements=["x","y"];d3plus.apps.line.tooltip="static";d3plus.apps.line.shapes=["line"];d3plus.apps.line.setup=function(vars){vars.x.scale.value="continuous"};d3plus.apps.line.draw=function(vars){return d3plus.apps.chart.draw(vars)};d3plus.apps.network={};d3plus.apps.network.data="object";d3plus.apps.network.requirements=["nodes","links"];d3plus.apps.network.tooltip="static";d3plus.apps.network.shapes=["circle","square","donut"];d3plus.apps.network.scale=1.05;d3plus.apps.network.draw=function(vars){var nodes=vars.nodes.restricted||vars.nodes.value,links=vars.links.restricted||vars.links.value;var x_range=d3.extent(d3.values(nodes),function(d){return d.x}),y_range=d3.extent(d3.values(nodes),function(d){return d.y}),aspect=(x_range[1]-x_range[0])/(y_range[1]-y_range[0]);if(aspect>vars.app_width/vars.app_height){var network_height=vars.app_width/aspect,network_width=vars.app_width,offset_top=(vars.app_height-network_height)/2,offset_left=0}else{var network_width=vars.app_height*aspect,network_height=vars.app_height,offset_left=(vars.app_width-network_width)/2,offset_top=0}var scale={};scale.x=d3.scale.linear().domain(x_range).range([offset_left,vars.app_width-offset_left]);scale.y=d3.scale.linear().domain(y_range).range([offset_top,vars.app_height-offset_top]);var val_range=d3.extent(d3.values(vars.data.app),function(d){var val=d3plus.variable.value(vars,d,vars.size.key);return val==0?null:val});if(typeof val_range[0]=="undefined")val_range=[1,1];var distances=[];nodes.forEach(function(n1){nodes.forEach(function(n2){if(n1!=n2){var xx=Math.abs(scale.x(n1.x)-scale.x(n2.x));var yy=Math.abs(scale.y(n1.y)-scale.y(n2.y));distances.push(Math.sqrt(xx*xx+yy*yy))}})});var max_size=d3.min(distances,function(d){return d});max_size=max_size*(max_size/800);var min_size=4;scale.x.range([offset_left+max_size*1.5,vars.app_width-max_size*1.5-offset_left]);scale.y.range([offset_top+max_size*1.5,vars.app_height-max_size*1.5-offset_top]);scale.r=d3.scale[vars.size.scale.value]().domain(val_range).range([min_size,max_size]);var data=[],lookup={};nodes.forEach(function(n){if(vars.data.app[n[vars.id.key]]){var obj=d3plus.utils.merge(n,vars.data.app[n[vars.id.key]])}else{var obj=d3plus.utils.copy(n)}obj.d3plus={};obj.d3plus.x=scale.x(n.x);obj.d3plus.y=scale.y(n.y);lookup[obj[vars.id.key]]={x:obj.d3plus.x,y:obj.d3plus.y};var val=d3plus.variable.value(vars,obj,vars.size.key);obj.d3plus.r=val?scale.r(val):scale.r.range()[0];data.push(obj)});data.sort(function(a,b){return b.d3plus.r-a.d3plus.r});links.forEach(function(l,i){if(typeof l.source!="object"){var obj={};obj[vars.id.key]=l.source;l.source=obj}l.source.d3plus={};var id=l.source[vars.id.key];l.source.d3plus.x=lookup[id].x;l.source.d3plus.y=lookup[id].y;if(typeof l.target!="object"){var obj={};obj[vars.id.key]=l.target;l.target=obj}l.target.d3plus={};var id=l.target[vars.id.key];l.target.d3plus.x=lookup[id].x;l.target.d3plus.y=lookup[id].y});return{nodes:data,links:links}};d3plus.apps.rings={};d3plus.apps.rings.data="object";d3plus.apps.rings.requirements=["links","focus"];d3plus.apps.rings.tooltip="static";d3plus.apps.rings.shapes=["circle","square","donut"];d3plus.apps.rings.scale=1;d3plus.apps.rings.draw=function(vars){var radius=d3.min([vars.app_height,vars.app_width])/2,ring_width=vars.small||!vars.labels.value?radius/2.25:radius/3,links=[],nodes=[];if(vars.data.app){var center=vars.data.app[vars.focus.value];if(!center){center={d3plus:{}};center[vars.id.key]=vars.focus.value}center.d3plus.x=vars.app_width/2;center.d3plus.y=vars.app_height/2;center.d3plus.r=ring_width/2;var primaries=[],claimed=[];vars.connections(vars.focus.value).forEach(function(link){var c=link.source[vars.id.key]==vars.focus.value?link.target:link.source;
var n=vars.data.app[c[vars.id.key]];if(!n){n={d3plus:{}};n[vars.id.key]=c[vars.id.key]}n.d3plus.children=vars.connections(n[vars.id.key]).filter(function(c){return c.source[vars.id.key]!=vars.focus.value&&c.target[vars.id.key]!=vars.focus.value});n.d3plus.link=link;claimed.push(n[vars.id.key]);primaries.push(n)});var sort=null;if(vars.order.key){sort=vars.order.key}else if(vars.color.key){sort=vars.color.key}else if(vars.size.key){sort=vars.size.key}else{sort=vars.id.key}function sort_function(a,b){a_value=d3plus.variable.value(vars,a,sort);b_value=d3plus.variable.value(vars,b,sort);if(vars.color.key&&sort==vars.color.key){a_value=d3plus.variable.color(vars,a);b_value=d3plus.variable.color(vars,b);a_value=d3.rgb(a_value).hsl();b_value=d3.rgb(b_value).hsl();if(a_value.s==0)a_value=361;else a_value=a_value.h;if(b_value.s==0)b_value=361;else b_value=b_value.h}else{a_value=d3plus.variable.value(vars,a,sort);b_value=d3plus.variable.value(vars,b,sort)}if(a_value<b_value)return vars.order.sort.value=="desc"?-1:1;if(a_value>b_value)return vars.order.sort.value=="desc"?1:-1}primaries.sort(function(a,b){var lengthdiff=a.d3plus.children.length-b.d3plus.children.length;if(lengthdiff){return lengthdiff}else{return sort_function(a,b)}});if(typeof vars.links.limit=="number"){primaries=primaries.slice(0,vars.links.limit)}else if(typeof vars.links.limit=="function"){primaries=vars.links.limit(primaries)}var secondaries=[],total=0;primaries.forEach(function(p){p.d3plus.children=p.d3plus.children.filter(function(c){return claimed.indexOf(c.source[vars.id.key])<0&&c.target[vars.id.key]==p[vars.id.key]||claimed.indexOf(c.target[vars.id.key])<0&&c.source[vars.id.key]==p[vars.id.key]});total+=p.d3plus.children.length||1;p.d3plus.children.forEach(function(c){var claim=c.target[vars.id.key]==p[vars.id.key]?c.source:c.target;claimed.push(claim[vars.id.key])})});primaries.sort(sort_function);var offset=0,radian=Math.PI*2,start=0;primaries.forEach(function(p,i){var children=p.d3plus.children.length||1,space=radian/total*children;if(i==0){start=angle;offset-=space/2}var angle=offset+space/2;angle-=radian/4;p.d3plus.radians=angle;p.d3plus.x=vars.app_width/2+ring_width*Math.cos(angle);p.d3plus.y=vars.app_height/2+ring_width*Math.sin(angle);p.d3plus.r=8;var check=["source","target"];check.forEach(function(node){if(p.d3plus.link[node][vars.id.key]==center[vars.id.key]){p.d3plus.link[node].d3plus={x:vars.app_width/2+center.d3plus.r*Math.cos(angle),y:vars.app_height/2+center.d3plus.r*Math.sin(angle)}}else{p.d3plus.link[node].d3plus={x:p.d3plus.x-p.d3plus.r*Math.cos(angle),y:p.d3plus.y-p.d3plus.r*Math.sin(angle)}}});delete p.d3plus.link.d3plus;links.push(p.d3plus.link);offset+=space;p.d3plus.children.sort(function(a,b){var a=a.source[vars.id.key]==p[vars.id.key]?a.target:a.source,b=b.source[vars.id.key]==p[vars.id.key]?b.target:b.source;return sort_function(a,b)});p.d3plus.children.forEach(function(link,i){var c=link.source[vars.id.key]==p[vars.id.key]?link.target:link.source;var d=vars.data.app[c[vars.id.key]],s=radian/total;if(!d){d={d3plus:{}};d[vars.id.key]=c[vars.id.key]}a=angle-s*children/2+s/2+s*i;d.d3plus.radians=a;d.d3plus.x=vars.app_width/2+ring_width*2*Math.cos(a);d.d3plus.y=vars.app_height/2+ring_width*2*Math.sin(a);d.d3plus.r=4;secondaries.push(d)})});primaries.forEach(function(p,i){vars.connections(p[vars.id.key]).forEach(function(link){var c=link.source[vars.id.key]==p[vars.id.key]?link.target:link.source;if(c[vars.id.key]!=center[vars.id.key]){var target=secondaries.filter(function(s){return s[vars.id.key]==c[vars.id.key]})[0];if(!target){r=ring_width;target=primaries.filter(function(s){return s[vars.id.key]==c[vars.id.key]})[0]}if(target){link.d3plus={spline:true,translate:{x:vars.app_width/2,y:vars.app_height/2}};var check=["source","target"],r=ring_width*2;check.forEach(function(node){if(link[node][vars.id.key]==p[vars.id.key]){link[node].d3plus={a:p.d3plus.radians,r:ring_width+p.d3plus.r}}else{link[node].d3plus={a:target.d3plus.radians,r:r-target.d3plus.r}}});links.push(link)}}})});nodes=[center].concat(primaries).concat(secondaries);nodes.forEach(function(n){if(n[vars.id.key]!=vars.focus.value){if(vars.labels.value){var angle=n.d3plus.radians*(180/Math.PI),width=ring_width-vars.style.labels.padding*3-n.d3plus.r;if(angle<-90||angle>90){angle=angle-180;var buffer=-(n.d3plus.r+width/2+vars.style.labels.padding),anchor="end"}else{var buffer=n.d3plus.r+width/2+vars.style.labels.padding,anchor="start"}var background=primaries.indexOf(n)>=0?true:false;n.d3plus.label={x:buffer,y:0,w:width,h:30,angle:angle,anchor:anchor,valign:"center",color:d3plus.color.legible(d3plus.variable.color(vars,n[vars.id.key])),resize:false,background:background}}}else{delete n.d3plus.label}})}vars.mouse[d3plus.evt.click]=function(d){d3plus.tooltip.remove(vars.type.value);vars.viz.focus(d[vars.id.key]);if(!vars.autodraw){vars.viz.draw()}};return{links:links,nodes:nodes}};d3plus.apps.stacked={};d3plus.apps.stacked.data="grouped";d3plus.apps.stacked.requirements=["x","y"];d3plus.apps.stacked.tooltip="static";d3plus.apps.stacked.shapes=["area"];d3plus.apps.stacked.setup=function(vars){if(vars.dev.value)d3plus.console.time("setting local variables");vars.x.scale.value="continuous";if(vars.dev.value)console.log('"x" scale set to "continuous"');vars.x.zerofill.value=true;if(vars.dev.value)console.log('"x" zerofill set to "true"');vars.y.stacked.value=true;if(!vars.y.key&&vars.size.key||vars.size.changed&&vars.size.previous==vars.y.key){vars.y.key=vars.size.key;vars.y.changed=true}if(vars.dev.value)console.log('"y" stacked set to "true"');if(vars.dev.value)d3plus.console.timeEnd("setting local variables")};d3plus.apps.stacked.draw=function(vars){if(typeof vars.size.threshold=="number"&&vars.size.threshold>0){var allowed=[],cutoff=vars.depth.value==0?0:{},removed=[],largest={};d3.nest().key(function(d){return d3plus.variable.value(vars,d,vars.x.key)}).rollup(function(leaves){var total=leaves.length;if(vars.aggs[vars.y.key]){if(typeof vars.aggs[vars.y.key]=="function"){total=vars.aggs[vars.y.key](leaves)}else if(typeof vars.aggs[vars.y.key]=="string"){total=d3[vars.aggs[vars.y.key]](leaves,function(l){return d3plus.variable.value(vars,l,vars.y.key)})}}else{total=d3.sum(leaves,function(l){return d3plus.variable.value(vars,l,vars.y.key)})}var x=d3plus.variable.value(vars,leaves[0],vars.x.key);largest[x]=total;return total}).entries(vars.data.app);vars.data.app=vars.data.app.filter(function(d){var id=d3plus.variable.value(vars,d,vars.id.key),val=d3plus.variable.value(vars,d,vars.y.key),x=d3plus.variable.value(vars,d,vars.x.key);if(allowed.indexOf(id)<0){if(val/largest[x]>=vars.size.threshold){allowed.push(id)}}if(allowed.indexOf(id)<0){if(vars.depth.value==0){if(val>cutoff)cutoff=val}else{var parent=d[vars.id.nesting[vars.depth.value-1]];if(!(parent in cutoff))cutoff[parent]=0;if(val>cutoff[parent])cutoff[parent]=val}removed.push(d);return false}else{return true}});var levels=vars.id.nesting.slice(0,vars.depth.value);var nesting=levels.concat([vars.x.key]);var merged=d3plus.data.nest(vars,removed,nesting,true).filter(function(d){return d3plus.variable.value(vars,d,vars.y.key)>0});merged.forEach(function(m){var parent=vars.id.nesting[vars.depth.value-1];m.d3plus={};vars.id.nesting.forEach(function(d,i){if(vars.depth.value==i){var prev=m[vars.id.nesting[i-1]];if(prev){m[d]="d3plus_other_"+prev}else{m[d]="d3plus_other"}}else if(i>vars.depth.value){delete m[d]}});if(vars.color.key){if(vars.depth.value==0){m[vars.color.key]=vars.style.color.missing}else{m[vars.color.key]=d3plus.variable.color(vars,m[parent],parent)}}if(vars.icon.key&&vars.depth.value!=0){m[vars.icon.key]=d3plus.variable.value(vars,m[parent],vars.icon.key,parent);m.d3plus.depth=vars.id.nesting.indexOf(parent)}if(vars.text.key){if(vars.depth.value==0){if(vars.title.value){m[vars.text.key]=vars.title.value}else{m[vars.text.key]=vars.format("Values")}m[vars.text.key]+=" < "+vars.format(cutoff)}else{var name=d3plus.variable.value(vars,m,vars.text.key,parent);m[vars.text.key]=name;m[vars.text.key]+=" < "+vars.format(cutoff[m[parent]],vars.y.key)}m[vars.text.key]+=" ("+vars.format(vars.size.threshold*100)+"%)"}});vars.data.app=vars.data.app.concat(merged)}return d3plus.apps.chart.draw(vars)};d3plus.apps.tree_map={};d3plus.apps.tree_map.data="nested";d3plus.apps.tree_map.requirements=["size"];d3plus.apps.tree_map.tooltip="follow";d3plus.apps.tree_map.shapes=["square"];d3plus.apps.tree_map.draw=function(vars){var data=d3.layout.treemap().round(false).size([vars.app_width,vars.app_height]).children(function(d){return d.children}).padding(1).sort(function(a,b){return a.value-b.value}).value(function(d){return d3plus.variable.value(vars,d,vars.size.key)}).nodes({name:"root",children:vars.data.app}).filter(function(d){return!d.children&&d.area>0});if(data.length){var root=data[0];while(root.parent){root=root.parent}data.forEach(function(d){d.d3plus.x=d.x+d.dx/2;d.d3plus.y=d.y+d.dy/2;d.d3plus.width=d.dx;d.d3plus.height=d.dy;d.d3plus.share=d.value/root.value})}return data};d3plus.data.analyze=function(vars){vars.data.type=d3plus.apps[vars.type.value].data||"array";function get_keys(arr,add){if(arr instanceof Array){arr.forEach(function(d){if(add)d.d3plus={};get_keys(d)})}else if(typeof arr=="object"){for(var d in arr){if(typeof arr[d]=="object"){get_keys(arr[d],add)}else if(!vars.data.keys[d]&&arr[d]){vars.data.keys[d]=typeof arr[d]}}}}if(vars.data.changed){if(vars.dev.value)d3plus.console.group("New Data Detected");vars.data.filtered=null;vars.data.grouped=null;vars.data[vars.data.type]=null;vars.data.app=null;vars.data.restricted=null;vars.nodes.restricted=null;vars.links.restricted=null;if(vars.dev.value)d3plus.console.time("key analysis");vars.data.keys={};get_keys(vars.data.value,true);if(vars.dev.value)d3plus.console.timeEnd("key analysis");if(vars.dev.value)d3plus.console.groupEnd()}if(vars.attrs.changed){if(vars.dev.value)d3plus.console.group("New Attributes Detected");if(vars.dev.value)d3plus.console.time("key analysis");if(typeof vars.attrs.value=="object"){for(a in vars.attrs.value){get_keys(vars.attrs.value[a])}}else{get_keys(vars.attrs.value)}if(vars.dev.value)d3plus.console.timeEnd("key analysis");if(vars.dev.value)d3plus.console.groupEnd()}vars.check=[];for(k in vars){if(vars[k]&&vars[k]["data_filter"]&&vars[k].changed){vars.check.push(k)}}if(!vars.data.filtered||vars.check.length||vars.active.changed||vars.temp.changed||vars.total.changed){vars.data[vars.data.type]=null;vars.data.grouped=null;vars.data.app=null;d3plus.data.filter(vars)}if(vars.mute.length||vars.solo.length){vars.filtered=true;var key=vars.solo.length?"solo":"mute";if(vars.dev.value)d3plus.console.group('Filtering Data by "'+key+'" values');vars.data[vars.data.type]=null;vars.data.restricted={};var data="filtered";vars[key].forEach(function(v){if(vars.dev.value)d3plus.console.time(v);function test_value(val){if(!(vars[v][key]instanceof Array)){var arr=vars[v][key].value}else{var arr=vars[v][key]}var match=false;arr.forEach(function(f){if(typeof f=="function"){match=f(val)}else if(f==val){match=true}});return match}function nest_check(d){var match=false;if(vars[v].nesting){vars[v].nesting.forEach(function(n){if(!match){match=test_value(d3plus.variable.value(vars,d,n))}})}else{var k=vars[v].value?vars[v].value:vars[v].key;match=test_value(d3plus.variable.value(vars,d,k))}if(key=="solo"){return match}else if(key=="mute"){return!match}}for(y in vars.data[data]){vars.data.restricted[y]=vars.data[data][y].filter(nest_check)}if(v=="id"){if(vars.nodes.value){if(vars.dev.value)d3plus.console.log("Filtering Nodes");vars.nodes.restricted=vars.nodes.value.filter(nest_check)}if(vars.links.value){if(vars.dev.value)d3plus.console.log("Filtering Connections");vars.links.restricted=vars.links.value.filter(function(d){var first_match=nest_check(d.source),second_match=nest_check(d.target);return first_match&&second_match})}}data="restricted";if(vars.dev.value)d3plus.console.timeEnd(v)});if(vars.dev.value)d3plus.console.groupEnd()}else if(vars.filtered||!vars.data.restricted||vars.check.length){vars.data.restricted=d3plus.utils.copy(vars.data.filtered);vars.data.grouped=null;vars.data.app=null;vars.data[vars.data.type]=null;vars.nodes.restricted=null;vars.links.restricted=null;vars.filtered=false}if(!vars.data.grouped){vars.data.grouped=d3plus.data.format(vars,"grouped")}var year=!vars.time.fixed.value?["all"]:null;if(year===null&&vars.time.solo.changed||!vars.data.pool){vars.data.pool=d3plus.data.fetch(vars,"grouped",year)}if(!vars.data[vars.data.type]){vars.data[vars.data.type]=d3plus.data.format(vars,vars.data.type)}if(!vars.data.app||vars.depth.changed||vars.time.solo.changed||vars.time.mute.changed||vars.type.changed||vars.solo.length||vars.mute.length){vars.data.app=d3plus.data.fetch(vars,vars.data.type)}vars.check=[]};d3plus.data.color=function(vars){if(vars.color.key&&typeof vars.color.key=="object"){if(vars.color.key[vars.id.key]){var color_id=vars.color.key[vars.id.key]}else{var color_id=vars.color.key[Object.keys(vars.color.key)[0]]}}else{var color_id=vars.color.key}if(vars.data.value&&color_id&&vars.data.keys[color_id]=="number"&&(vars.color.changed||vars.data.changed||vars.depth.changed||vars.time.solo.changed||vars.time.mute.changed)){if(vars.dev.value)d3plus.console.group("Calculating Color Scale");if(vars.dev.value)d3plus.console.time("get data range");var data_range=[];vars.data.pool.forEach(function(d){var val=parseFloat(d3plus.variable.value(vars,d,color_id));if(typeof val=="number"&&!isNaN(val)&&data_range.indexOf(val)<0)data_range.push(val)});if(vars.dev.value)d3plus.console.timeEnd("get data range");if(data_range.length>1){var data_domain=null;if(vars.dev.value)d3plus.console.time("create color scale");data_range=d3.extent(data_range);if(data_range[0]<0&&data_range[1]>0){var color_range=vars.style.color.range;data_range.push(data_range[1]);data_range[1]=0}else if(data_range[1]>0||data_range[0]<0){var color_range=vars.style.color.heatmap;data_range=d3plus.utils.buckets(data_range,color_range.length)}else{var color_range=vars.style.color.range.slice(0)}vars.color_scale=d3.scale.sqrt().domain(data_range).range(color_range).interpolate(d3.interpolateRgb);if(vars.dev.value)d3plus.console.timeEnd("create color scale")}else{vars.color_scale=null}if(vars.dev.value)d3plus.console.groupEnd()}else{vars.color_scale=null}};d3plus.data.fetch=function(vars,format,years){if(!format){var format=vars.data.type}if(format=="object"){return_data={}}else{return_data=[]}if(vars.dev.value)d3plus.console.group('Fetching "'+format+'" data');if(!years){if(vars.time.solo.value.length){var years=[];vars.time.solo.value.forEach(function(y){if(typeof y=="function"){vars.data.time.forEach(function(t){if(y(t)){years.push(t)}})}else{years.push(y)}})}else if(vars.time.mute.value.length){var muted=[];vars.time.mute.value.forEach(function(y){if(typeof y=="function"){vars.data.time.forEach(function(t){if(y(t)){muted.push(t)}})}else{muted.push(y)}});var years=vars.data.time.filter(function(t){return muted.indexOf(t)<0})}else{var years=["all"]}}if(vars.dev.value)console.log("years: "+years.join(","));if(format=="restricted"){var data=vars.data.restricted}else if(format=="nested"&&years.length>1){var data=vars.data.grouped[vars.id.nesting[vars.depth.value]]}else{var data=vars.data[format][vars.id.nesting[vars.depth.value]]}if(years.length==1){return_data=data[years[0]]}else{var missing=[];years.forEach(function(y){if(data[y]){if(format=="object"){for(k in data[y]){if(!return_data[data[y][k][vars.id.key]]){return_data[data[y][k][vars.id.key]]=[]}return_data[data[y][k][vars.id.key]].push(data[y][k])}}else{return_data=return_data.concat(data[y])}}else{missing.push(y)}});if(return_data.length==0&&missing.length){vars.internal_error="No Data Available for "+missing.join(", ");d3plus.console.warning(vars.internal_error)}else{vars.internal_error=null}}if(years.length>1){var separated=false;vars.axes.values.forEach(function(a){if(vars[a].key==vars.time.key&&vars[a].scale.value=="continuous"){separated=true}});if(!separated){var nested=vars.id.nesting.slice(0,vars.depth.value+1);if(return_data instanceof Array){return_data=d3plus.data.nest(vars,return_data,nested,format=="grouped")}else if(typeof return_data=="object"){for(k in return_data){return_data[k]=d3plus.data.nest(vars,return_data[k],nested)[0]}}}}if(!return_data){if(format=="object"){return_data={}}else{return_data=[]}}if(vars.dev.value)d3plus.console.groupEnd();return return_data};d3plus.data.filter=function(vars){if(vars.check.indexOf("time")>=0){vars.check.splice(vars.check.indexOf("time"),1);if(vars.data.filtered){vars.data.filtered={all:vars.data.filtered.all}}}if(!vars.filters){vars.filters=vars.check.slice(0)}else{vars.check.forEach(function(k){var variable=vars[k].value?vars[k].value:vars[k].key;if(!variable&&vars.filters.indexOf(k)>=0){vars.filters.splice(vars.filters.indexOf(k),1)}})}if(vars.check.length>=1){if(vars.dev.value)d3plus.console.group("Filtering Data by Required Variables");var checking=vars.filters.join(", ");if(vars.dev.value)d3plus.console.time(checking);var data="value";vars.filters.forEach(function(key){if(key=="xaxis")vars.x_range=null;else if(key=="yaxis")vars.y_range=null;vars.data.filtered=vars.data[data].filter(function(d){var variable=vars[key].value?vars[key].value:vars[key].key;var val=d3plus.variable.value(vars,d,variable);if(key=="size"){return val>0?true:false}else{return val!=null}});data="filtered"});vars.data.filtered={all:vars.data.filtered};if(vars.dev.value)d3plus.console.timeEnd(checking);if(vars.dev.value)d3plus.console.groupEnd()}else if(!vars.data.filtered){vars.data.filtered={all:vars.data.value}}if(vars.time.key&&Object.keys(vars.data.filtered).length==1){if(vars.dev.value)d3plus.console.group("Disaggregating by Year");vars.data.time=d3plus.utils.uniques(vars.data.filtered.all,vars.time.key);vars.data.time.sort();if(vars.data.time.length){if(vars.dev.value)d3plus.console.time(vars.data.time.length+" years");vars.data.time.forEach(function(y){vars.data.filtered[y]=vars.data.filtered.all.filter(function(d){return d3plus.variable.value(vars,d,vars.time.key)==y})});if(vars.dev.value)d3plus.console.timeEnd(vars.data.time.length+" years")}if(vars.dev.value)d3plus.console.groupEnd()}};d3plus.data.format=function(vars,format){if(!format)var format="nested";return_data={};if(vars.dev.value)d3plus.console.group('Formatting "'+format+'" Data');vars.id.nesting.forEach(function(depth){if(vars.dev.value)d3plus.console.time(depth);var level=vars.id.nesting.slice(0,vars.id.nesting.indexOf(depth)+1);return_data[depth]={};for(y in vars.data.restricted){if(format=="nested"){return_data[depth][y]=d3plus.data.nest(vars,vars.data.restricted[y],level)}else if(format=="grouped"){return_data[depth][y]=d3plus.data.nest(vars,vars.data.restricted[y],level,true)}else if(format=="object"){return_data[depth][y]={};vars.data.restricted[y].forEach(function(d){return_data[depth][y][d[vars.id.key]]=d})}else{return_data[depth][y]=vars.data.restricted[y]}}if(vars.dev.value)d3plus.console.timeEnd(depth)});if(vars.dev.value)d3plus.console.groupEnd();return return_data};d3plus.data.nest=function(vars,flat_data,levels,grouped){var nested_data=d3.nest(),group_data=[];var checks=["active","temp","total"];levels.forEach(function(nest_key,i){nested_data.key(function(d){return d3plus.variable.value(vars,d,nest_key)});vars.axes.values.forEach(function(axis){if(d3plus.apps[vars.type.value].requirements&&d3plus.apps[vars.type.value].requirements.indexOf(axis)>=0&&vars[axis].key&&vars[axis].scale.value=="continuous"){nested_data.key(function(d){return d3plus.variable.value(vars,d,vars[axis].key)})}});if(i==levels.length-1){nested_data.rollup(function(leaves){to_return={d3plus:{depth:i}};checks.forEach(function(c){var key=vars[c].key?vars[c].key:c;to_return[key]=d3.sum(leaves,function(d){if(vars[c].key){var a=d3plus.variable.value(vars,d,vars[c].key);if(typeof a!="number"){var a=a?1:0}}else if(c=="total"){var a=1}else{var a=0}return a});to_return.d3plus[key]=to_return[key]});var nest_obj=d3plus.variable.value(vars,leaves[0],nest_key);to_return[nest_key]=nest_obj;for(key in vars.data.keys){if((levels.indexOf(nest_key)>=0&&levels.indexOf(key)<=levels.indexOf(nest_key)||vars.id.nesting.indexOf(nest_key)>=0&&vars.id.nesting.indexOf(key)<=vars.id.nesting.indexOf(nest_key))&&key in leaves[0]&&(!vars.active.key||key!=vars.active.key)&&key!="d3plus"){if(typeof vars.aggs.value[key]=="function"){to_return[key]=vars.aggs.value[key](leaves)}else if(typeof vars.aggs.value[key]=="string"){to_return[key]=d3[vars.aggs.value[key]](leaves,function(d){return d[key]})}else if([vars.time.key,vars.icon].indexOf(key)>=0||key==nest_key&&!to_return[key]){to_return[key]=leaves[0][key]}else if(vars.data.keys[key]==="number"&&vars.id.nesting.indexOf(key)<0){to_return[key]=d3.sum(leaves,function(d){return d[key]})}else if(key){to_return[key]=leaves[0][key]}}}if(grouped){group_data.push(to_return)}return to_return})}});rename_key_value=function(obj){if(obj.values&&obj.values.length){obj.children=obj.values.map(function(obj){return rename_key_value(obj)});delete obj.values;return obj}else if(obj.values){return obj.values}else{return obj}};find_keys=function(obj,depth,keys){if(obj.children){if(vars.data.keys[levels[depth]]=="number"){obj.key=parseFloat(obj.key)}keys[levels[depth]]=obj.key;delete obj.key;for(k in keys){obj[k]=keys[k]}depth++;obj.children.forEach(function(c){find_keys(c,depth,keys)})}};nested_data=nested_data.entries(flat_data).map(rename_key_value).map(function(obj){find_keys(obj,0,{});return obj});if(grouped){return group_data}return nested_data};d3plus.forms.button=function(vars,styles,timing){if(vars.dev)d3plus.console.time("calculating borders and padding");if(styles.border=="all"){var border_width=styles.stroke+"px",padding=styles.padding+"px"}else{var sides=["top","right","bottom","left"];var border_width="",padding="";sides.forEach(function(s,i){if(styles.border.indexOf(s)>=0){border_width+=styles.stroke+"px";padding+=styles.padding+"px"}else{border_width+="0px";padding+=styles.padding+styles.stroke+"px"}if(i<sides.length-1){border_width+=" ";padding+=" "}})}var reversed=styles["font-align"]=="right"&&!d3plus.rtl||d3plus.rtl&&styles["font-align"]=="right";if(vars.dev)d3plus.console.timeEnd("calculating borders and padding");var background_color=function(d){if(vars.highlight!=d.value){if(vars.hover==d.value){if(vars.highlight){var background=d3plus.color.lighter(styles.secondary,.025)}else{var background=d3plus.color.lighter(styles.secondary,.1)}}else{var background=styles.secondary}}else{if(vars.hover==d.value&&vars.enabled){var background=d3plus.color.darker(styles.color,.025)}else{var background=styles.color}}return background};var color=function(elem){elem.each(function(d){d.bg=background_color(d)}).style("color",function(d){var text_color=d3plus.color.text(d.bg);if(text_color!="#fff"&&vars.selected==d.value&&d.color&&!d.image){return d3plus.color.legible(d.color)}return text_color}).style("background-color",function(d){return d.bg}).style("border-color",styles.secondary)};var style=function(elem){elem.style("position","relative").style("margin",styles.margin+"px").style("display",styles.display).style("opacity",function(d){if([vars.selected,vars.highlight].indexOf(d.value)<0){return.75}return 1}).style("border-style","solid").style("border-width",border_width).style("font-family",styles["font-family"]).style("font-size",styles["font-size"]+"px").style("font-weight",styles["font-weight"]).style("text-align",styles["font-align"]).style("letter-spacing",styles["font-spacing"]+"px")};var icons=function(elem){elem.text(function(d){return d[vars.text]}).each(function(d,i){var children=[];if(d.image){children.push("image")}if(styles.icon){d.icon=d3plus.utils.copy(styles.icon);children.push("icon")}else if(d.value===vars.selected){if(d3plus.fontawesome){d.icon={"class":"fa fa-check",content:""}}else{d.icon={"class":"",content:"&#x2713;"}}children.push("icon")}var buffer=0;var items=d3.select(this).selectAll("div.d3plus_button_element").data(children,function(c,i){return c});items.enter().append("div").style("display","absolute").attr("id",function(c){return"d3plus_button_element_"+vars.id+"_"+c}).attr("class",function(c){var extra="";if(c=="icon"&&d.icon.class){extra=" "+d[c].class}return"d3plus_button_element"+extra});items.order().html(function(c){if(c=="icon"){return d.icon.content}else{return""}}).style("background-image",function(c){if(c=="image"){return"url('"+d.image+"')"}return"none"}).style("background-color",function(c){if(c=="image"&&d.style=="knockout"){return d.color||vars.color}return"transparent"}).style("background-size","100%").style("text-align","center").style("position",function(c){return c=="text"?"static":"absolute"}).style("width",function(c){if(styles.height){buffer=styles.height-styles.padding*2-styles.stroke*2}else{buffer=parseFloat(d3.select(this.parentNode).style("height"),10)}return buffer+"px"}).style("height",function(c){if(c=="image"){return buffer+"px"}return"auto"}).style("margin-top",function(c){if(this.offsetHeight){var h=this.offsetHeight}else{var h=buffer;if(c=="icon")h-=3}return-h/2+"px"}).style("top","50%").style("left",function(c){if(c=="image"&&!reversed||c=="icon"&&reversed){return styles.padding+"px"}return"auto"}).style("right",function(c){if(c=="image"&&reversed||c=="icon"&&!reversed){return styles.padding+"px"}return"auto"});items.exit().remove();if(buffer>0){buffer+=styles.padding*2;var p=styles.padding;if(children.length==2){var padding=p+"px "+buffer+"px"}else if(children[0]=="image"&&!d3plus.rtl||children[0]=="icon"&&d3plus.rtl){var padding=p+"px "+p+"px "+p+"px "+buffer+"px"}else{var padding=p+"px "+buffer+"px "+p+"px "+p+"px"}d3.select(this).style("padding",padding)}else{d3.select(this).style("padding",styles.padding+"px")}if(typeof styles.width=="number"){var width=styles.width;width-=parseFloat(d3.select(this).style("padding-left"),10);width-=parseFloat(d3.select(this).style("padding-right"),10);width-=styles.stroke*2;width+="px"}else{var width="auto"}d3.select(this).style("width",width)})};var button=vars.container.selectAll("div.d3plus_node").data(vars.data.array,function(d){return d.id||d.value});if(vars.dev)d3plus.console.time("update");button.transition().duration(vars.timing).call(color).call(style);if(vars.dev)d3plus.console.timeEnd("update");if(vars.dev)d3plus.console.time("enter");button.enter().append("div").attr("id","d3plus_button_"+vars.id).attr("class","d3plus_node").call(color).call(style).call(icons);if(vars.dev)d3plus.console.timeEnd("enter");if(button.size()<2){button.call(icons)}else{if(vars.previous){var previous=button.filter(function(b){return b.value==vars.previous});previous.call(icons)}if(vars.selected){var focus=button.filter(function(b){return b.value==vars.selected});focus.call(icons)}}if(vars.dev)d3plus.console.time("events");button.order().on(d3plus.evt.over,function(d,i){vars.hover=d.value;if(vars.data.array.length==1||d.value!=vars.highlight){if(d3plus.ie){d3.select(this).style("cursor","pointer").call(color)}else{d3.select(this).style("cursor","pointer").transition().duration(100).call(color)}}}).on(d3plus.evt.out,function(d){vars.hover=false;if(vars.data.array.length==1||d.value!=vars.highlight){if(d3plus.ie){d3.select(this).style("cursor","auto").call(color)}else{d3.select(this).style("cursor","auto").transition().duration(100).call(color)}}}).on("click",function(d){if(!vars.propagation){d3.event.stopPropagation()}if(vars.callback&&d.value){vars.callback(d)}});if(vars.dev)d3plus.console.timeEnd("events");button.exit().remove()};d3plus.forms.data=function(vars){if(vars.data.data){if(!vars.data.array||"replace"in vars.data&&vars.data.replace===true||!("replace"in vars.data)){vars.data.array=[]}var defaults=["value","alt","keywords","image","style","color","selected","text"],vals=vars.data.map||{};defaults.forEach(function(d){if(!(d in vals)){vals[d]=d}});vars.data.data.forEach(function(d){var obj={};for(key in vals){if(vals[key]in d){obj[key]=d[vals[key]]}}vars.data.array.push(obj)});var sort="sort"in vars.data?vars.data.sort:"text";if(sort){vars.data.array.sort(function(a,b){a=a[sort];b=b[sort];if(sort=="color"){a=d3.rgb(a_value).hsl();b=d3.rgb(b_value).hsl();if(a.s==0)a=361;else a=a.h;if(b.s==0)b=361;else b=b.h}if(a<b)return-1;if(a>b)return 1})}}vars.data.changed=true;vars.loading=false};d3plus.forms.drop=function(vars,styles,timing){if(vars.element){vars.element.on("focus."+vars.id,function(){vars.ui.hover(true).draw()});vars.element.on("blur."+vars.id,function(){var search=vars.search?d3.event.relatedTarget!=vars.container.select("input").node():true;if(search){vars.ui.hover(false).draw()}});vars.element.on("change."+vars.id,function(){vars.ui.value(vars.data.array[this.selectedIndex])});vars.element.on("keydown.cancel_"+vars.id,function(){var key=d3.event.keyCode;if(key!=9){d3.event.preventDefault()}})}d3.select(document).on("keydown."+vars.id,function(){if(vars.enabled||vars.hover===true){var key=d3.event.keyCode,options=list.select("div").selectAll("div.d3plus_node"),index=0;if(typeof vars.hover=="boolean"){options.each(function(d,i){if(d.value==vars.focus){index=i}})}else{options.each(function(d,i){if(d.value==vars.hover){index=i}})}if([9].indexOf(key)>=0&&(!vars.search||vars.search&&!d3.event.shiftKey)){vars.ui.disable()}else if([40].indexOf(key)>=0){if(vars.enabled){if(index>=options.size()-1){index=0}else{index+=1}}if(typeof vars.hover!="boolean"){var hover=options.data()[index].value}else{var hover=vars.focus}if(vars.enabled){vars.ui.hover(hover).draw(60)}else{vars.ui.hover(hover).enable()}}else if([38].indexOf(key)>=0){if(vars.enabled){if(index<=0){index=options.size()-1}else{index-=1}}if(typeof vars.hover!="boolean"){var hover=options.data()[index].value}else{var hover=vars.focus}if(vars.enabled){vars.ui.hover(hover).draw(60)}else{vars.ui.hover(hover).enable()}}else if([13].indexOf(key)>=0){if(typeof vars.hover!="boolean"){vars.ui.value(vars.hover).hover(true).draw()}else{vars.ui.hover(vars.focus).toggle()}}else if([27].indexOf(key)>=0){if(vars.enabled){vars.ui.hover(true).disable()}else if(vars.hover===true){vars.ui.hover(false).draw()}}}});function parent_click(elem){d3.select(elem).on("click."+vars.id,function(){var element=d3.event.target||d3.event.toElement;element=element.id;var child="_"+vars.id;if(element.indexOf(child)<0&&vars.enabled){vars.ui.disable()}});if(elem.self!==window.top){parent_click(elem.parent)}}parent_click(window);if(styles.icon){if(styles.icon.indexOf("fa-")==0){var icon={"class":"d3plus_drop_icon fa "+styles.icon,content:""}}else{var icon={"class":"d3plus_drop_icon",content:styles.icon}}}else{var icon=false}var drop_width=d3plus.forms.value(styles.width,["drop","button"]);if(!drop_width||typeof drop_width!="number"){if(vars.dev)d3plus.console.time("calculating width");var data=d3plus.utils.copy(styles);if(!icon){if(d3plus.fontawesome){data.icon={"class":"fa fa-check",content:""}}else{data.icon={"class":"",content:"&#x2713;"}}}else{data.icon=icon}data.display="inline-block";data.border="none";data.width=false;data.margin=0;var text=d3plus.forms.value(vars.text,["drop","button"]);if(!text){text="text"}var button=d3plus.ui(data).type("button").text(text).data(vars.data.array).parent(vars.tester).id(vars.id).timing(0).draw();var w=button.width();drop_width=d3.max(w);button.remove();if(vars.dev)d3plus.console.timeEnd("calculating width")}if(typeof styles.width!="object"){styles.width={}}styles.width.drop=drop_width;var button_width=d3plus.forms.value(styles.width,["button","drop"]);if(!button_width||typeof button_width!="number"){button_width=drop_width}styles.width.button=button_width;if(vars.dev)d3plus.console.time("creating main button");var style=d3plus.utils.copy(styles);style.icon=icon;style.width=button_width;style.margin=0;if(vars.enabled){style.shadow=0}var text=d3plus.forms.value(vars.text,["button","drop"]);if(!text){text="text"}var data=d3plus.utils.copy(vars.data.array.filter(function(d){return d.value==vars.focus
})[0]);data.id="drop_button";var test_data=d3plus.utils.copy(data);test_data.text="Test";var hover=vars.hover===true?vars.focus:false;if(vars.dev)d3plus.console.group("main button");var button=d3plus.ui(style).type("button").text(text).parent(vars.container).id(vars.id).timing(timing).hover(hover).data([test_data]).callback(vars.ui.toggle).highlight(vars.focus).enable().draw();var line_height=button.height();button.data([data]).height(line_height).draw();if(vars.dev)d3plus.console.groupEnd();if(vars.dev)d3plus.console.timeEnd("creating main button");if(vars.dev)d3plus.console.time("creating dropdown");var selector=vars.container.selectAll("div.d3plus_drop_selector").data(["selector"]);selector.enter().append("div").attr("class","d3plus_drop_selector").style("position","absolute").style("top","0px").style("padding",styles.stroke+"px").style("z-index","-1").style("overflow","hidden");if(vars.dev)d3plus.console.timeEnd("creating dropdown");if(vars.dev&&vars.search)d3plus.console.time("creating search");var search_data=vars.search?["search"]:[];var search=selector.selectAll("div.d3plus_drop_search").data(search_data);var search_width=styles.width.drop;search_width-=styles.padding*4;search_width-=styles.stroke*2;search.transition().duration(timing).style("padding",styles.padding+"px").style("display","block").style("background-color",styles.secondary);function search_style(elem){elem.style("padding",styles.padding+"px").style("width",search_width+"px").style("border-style","solid").style("border-width","0px").style("font-family",styles["font-family"]).style("font-size",styles["font-size"]+"px").style("font-weight",styles["font-weight"]).style("text-align",styles["font-align"]).attr("placeholder",vars.format("Search")).style("outline","none").style("-webkit-border-radius","0").style("border-radius","0")}search.select("input").transition().duration(timing).call(search_style);search.enter().insert("div","#d3plus_drop_list_"+vars.id).attr("class","d3plus_drop_search").attr("id","d3plus_drop_search_"+vars.id).style("padding",styles.padding+"px").style("display","block").style("background-color",styles.secondary).append("input").attr("id","d3plus_drop_input_"+vars.id).style("-webkit-appearance","none").call(search_style);search.select("input").on("keyup."+vars.id,function(d){if(vars.filter!=this.value){vars.filter=this.value;vars.ui.draw()}});search.exit().remove();if(vars.dev&&vars.search)d3plus.console.timeEnd("creating search");if(vars.dev)d3plus.console.time("populating list");var list=selector.selectAll("div.d3plus_drop_list").data(["list"]);list.enter().append("div").attr("class","d3plus_drop_list").attr("id","d3plus_drop_list_"+vars.id).style("overflow-y","auto").style("overflow-x","hidden");if(vars.loading){var data=[{text:vars.format("Loading...")}]}else if(vars.enabled){var search_text=d3plus.utils.strip(vars.filter.toLowerCase()).split("_"),tests=["value","text","alt","keywords"],search_text=search_text.filter(function(t){return t!=""});if(vars.filter==""){var data=vars.data.array}else{var data=vars.data.array.filter(function(d){var match=false;for(key in tests){if(tests[key]in d&&d[tests[key]]){var text=d3plus.utils.strip(d[tests[key]].toLowerCase()).split("_");for(t in text){for(s in search_text){if(text[t].indexOf(search_text[s])==0){match=true;break}}}}}return match})}if(data.length==0){data=[{text:vars.format("No results match")+' "'+vars.filter+'"'}]}}if(vars.dev)d3plus.console.timeEnd("populating list");var position=vars.container.node().getBoundingClientRect();var max=window.innerHeight-position.top;max-=button.height();max-=10;if(max<button.height()*2){max=position.top-10;vars.flipped=true}var scrolling=false;if(max>vars["max-height"]){max=vars["max-height"]}if(vars.enabled){if(vars.dev)d3plus.console.time("updating list items");if(vars.dev)d3plus.console.group("list buttons");var style=d3plus.utils.copy(styles);style.icon=false;style.display="block";style.border="none";style.width=drop_width;style.margin=0;var text=d3plus.forms.value(vars.text,["drop","button"]);if(!text){text="text"}var buttons=d3plus.ui(style).type("button").text(text).data(data).height(line_height).parent(list).id(vars.id+"_option").timing(timing).callback(vars.ui.value).previous(vars.previous).selected(vars.focus).hover(vars.hover).draw();if(vars.dev)d3plus.console.groupEnd();if(vars.dev)d3plus.console.timeEnd("updating list items");if(vars.dev)d3plus.console.time("calculating height");var hidden=false;if(selector.style("display")=="none"){var hidden=true}if(hidden)selector.style("display","block");var search_height=vars.search?search[0][0].offsetHeight:0;var old_height=selector.style("height"),old_scroll=selector.property("scrollTop"),list_height=list.style("max-height"),list_scroll=list.property("scrollTop");selector.style("height","auto");list.style("max-height","200000px");var height=parseFloat(selector.style("height"),10);list.style("max-height",list_height).property("scrollTop",list_scroll);selector.style("height",old_height).property("scrollTop",old_scroll);if(height>max){height=max;scrolling=true}if(hidden)selector.style("display","none");if(vars.dev)d3plus.console.timeEnd("calculating height");if(vars.dev)d3plus.console.time("calculating scroll position");if(scrolling){style.width-=d3plus.scrollbar();buttons.width(style.width).draw();var index=0;var options=list.select("div").selectAll("div.d3plus_node");if(typeof vars.hover=="boolean"){options.each(function(d,i){if(d.value==vars.focus){index=i}})}else{options.each(function(d,i){if(d.value==vars.hover){index=i}})}var hidden=false;if(selector.style("display")=="none"){hidden=true}var option=options[0][index];if(hidden)selector.style("display","block");var button_top=option.offsetTop,button_height=option.offsetHeight,list_top=list.property("scrollTop");if(hidden)selector.style("display","none");if(hidden||vars.data.changed){var scroll=button_top}else{var scroll=list_top;if(button_top<list_top){var scroll=button_top}else if(button_top+button_height>list_top+max-search_height){var scroll=button_top-(max-button_height-search_height)}}}else{var scroll=0}if(vars.dev)d3plus.console.timeEnd("calculating scroll position")}else{var scroll=list.property("scrollTop"),height=0}if(vars.dev)d3plus.console.time("rotating arrow");var offset=icon.content=="&#x27A4;"?90:0;if(vars.enabled!=vars.flipped){var rotate="rotate(-"+(180-offset)+"deg)"}else{var rotate="rotate("+offset+"deg)"}button.select("div#d3plus_button_element_"+vars.id+"_icon").data(["icon"]).style("transition",timing/1e3+"s").style("-webkit-transition",timing/1e3+"s").style("transform",rotate).style("-ms-transform",rotate).style("-webkit-transform",rotate).style("opacity",function(){return vars.enabled?.5:1});if(vars.dev)d3plus.console.timeEnd("rotating arrow");if(vars.dev)d3plus.console.time("drawing list");selector.transition().duration(timing).each("start",function(){d3.select(this).style("display",vars.enabled?"block":null)}).style("left",function(){if(styles.align=="left"){return"0px"}else if(styles.align=="center"){return-((drop_width-button_width)/2)+"px"}else{return"auto"}}).style("right",function(){return styles.align=="right"?"0px":"auto"}).style("height",height+"px").style("padding",styles.stroke+"px").style("background-color",styles.secondary).style("z-index",function(){return vars.enabled?"9999":"-1"}).style("width",drop_width-styles.stroke*2+"px").style("top",function(){return vars.flipped?"auto":button.height()+"px"}).style("bottom",function(){return vars.flipped?button.height()+"px":"auto"}).style("opacity",vars.enabled?1:0).each("end",function(){d3.select(this).transition().duration(timing).style("top",function(){return vars.flipped?"auto":button.height()+"px"}).style("bottom",function(){return vars.flipped?button.height()+"px":"auto"}).style("display",!vars.enabled?"none":null);if(vars.search&&vars.enabled){selector.select("div.d3plus_drop_search input").node().focus()}});function scrollTopTween(scrollTop){return function(){var i=d3.interpolateNumber(this.scrollTop,scrollTop);return function(t){this.scrollTop=i(t)}}}list.transition().duration(timing).style("max-height",max-search_height+"px").tween("scroll",scrollTopTween(scroll));if(vars.dev)d3plus.console.timeEnd("drawing list")};d3plus.forms.element=function(vars){function get_attributes(obj,elem){var attributes=["value","alt","keywords","image","style","color"];[].forEach.call(elem.attributes,function(attr){if(/^data-/.test(attr.name)){var camelCaseName=attr.name.substr(5).replace(/-(.)/g,function($0,$1){return $1.toUpperCase()});obj[camelCaseName]=attr.value}});attributes.forEach(function(a){if(elem.getAttribute(a)!==null){obj[a]=elem.getAttribute(a)}})}vars.tag=vars.element.node().tagName.toLowerCase();if(vars.tag=="select"){if(vars.element.attr("id")&&vars.id=="default"){vars.id=vars.element.attr("id")}vars.element.selectAll("option").each(function(o,i){var data_obj={selected:this.selected,text:this.innerHTML};get_attributes(data_obj,this);if(this.selected){vars.focus=this.value}vars.data.array.push(data_obj)})}else if(vars.tag=="input"&&vars.element.attr("type")=="radio"){vars.element.each(function(o,i){var data_obj={selected:this.checked};get_attributes(data_obj,this);if(this.id){var label=d3.select("label[for="+this.id+"]");if(!label.empty()){data_obj.text=label.style("display","none").html()}}if(this.checked){vars.focus=this.value}vars.data.array.push(data_obj)})}if(!vars.focus&&vars.data.array.length){vars.element.node().selectedIndex=0;vars.focus=vars.data.array[0].value}if(!vars.type){if(vars.data.array.length>4){vars.type="drop"}else{vars.type="radio"}}};d3plus.forms.json=function(vars){if(vars.dev)d3plus.console.time('loading data from "'+vars.data.fetch+'"');vars.loading=true;d3.json(vars.data.fetch,function(d){if(d&&Object.keys(d).length==1){vars.data.data=d[Object.keys(d)[0]]}else if(d&&vars.data.key&&d[key]){vars.data.data=d[key]}else{vars.data.data=[]}if(typeof vars.data.callback=="function"){vars.data.data=vars.data.callback(vars.data.data)}vars.data.loaded=true;vars.data.changed=true;if(vars.dev)d3plus.console.timeEnd('loading data from "'+vars.data.fetch+'"');d3plus.forms.data(vars);setTimeout(function(){vars.ui.draw()},vars.timing*1.5)})};d3plus.forms.radio=function(vars,styles,timing){vars.container.transition().duration(timing).style("background-color",styles.secondary).style("padding",styles.stroke+"px").style("margin",styles.margin+"px");var button_style=d3plus.utils.copy(styles);button_style.icon=false;button_style.display="inline-block";button_style.border="none";button_style.width=false;button_style.margin=0;button_style.stroke=0;var text=d3plus.forms.value(vars.text,["button"]);if(!text){text="text"}var button=d3plus.ui(button_style).type("button").text(text).data(vars.data.array).parent(vars.container).id(vars.id+"_radios").callback(vars.ui.value).highlight(vars.focus).enable().draw()};d3plus.forms.value=function(obj,arr){if(typeof obj=="object"&&arr){var ret=false;for(var i=0;i<arr.length;i++){if(arr[i]in obj){ret=obj[arr[i]];break}}if(ret){return ret}}else if(typeof obj!="object"){return obj}else{return false}};d3plus.info.error=function(vars){var error=vars.svg.selectAll("g#error").data(["error"]);error.enter().append("g").attr("id","error").attr("opacity",0).append("text").attr("x",vars.width.value/2).attr("font-size","30px").attr("fill","#888").attr("text-anchor","middle").attr("font-family",vars.style.font.family).style("font-weight",vars.style.font.weight).style(vars.style.info).attr("y",function(){var height=d3.select(this).node().getBBox().height;return vars.height.value/2-height/2});error.transition().duration(vars.style.timing.transitions).attr("opacity",1);error.select("text").transition().duration(vars.style.timing.transitions).attr("x",vars.width.value/2).each(function(d){if(vars.internal_error){d3plus.utils.wordwrap({text:vars.format(vars.internal_error,"error"),parent:this,width:vars.width.value-20,height:vars.height.value-20,resize:false})}}).attr("y",function(){var height=d3.select(this).node().getBBox().height;return vars.height.value/2-height/2}).attr("opacity",function(){return vars.internal_error?1:0})};d3plus.info.legend=function(vars){var key_display=true,square_size=0,key=vars.color.key||vars.id.key;if(!vars.small&&vars.legend.value&&key&&vars.data.pool.length){if(vars.dev.value)d3plus.console.group("Calculating Legend");if(!vars.color_scale&&vars.data.keys[key]!="number"){if(vars.dev.value)d3plus.console.time("determining color groups");var color_groups={},placed=[];vars.data.pool.forEach(function(d){if(placed.indexOf(d[vars.id.key])<0){var color=d3plus.variable.color(vars,d[vars.id.key]);if(!color_groups[color]){color_groups[color]=[]}color_groups[color].push(d);placed.push(d[vars.id.key])}});if(vars.dev.value)d3plus.console.timeEnd("determining color groups");if(vars.dev.value)d3plus.console.time("grouping colors");var colors=[];for(color in color_groups){var obj={color:color,icon_depth:vars.id.nesting[vars.depth.value]};if(vars.depth.value>0){for(var i=vars.depth.value-1;i>=0;i--){var parents=d3plus.utils.uniques(color_groups[color],vars.id.nesting[i]);if(parents.length==1){if(!obj.name){var name=d3plus.variable.text(vars,parents[0],i);if(name){obj.name=name}}if(!obj.icon){var icon=d3plus.variable.value(vars,parents[0],vars.icon.key,vars.id.nesting[i]);if(icon){obj.icon=icon;obj.icon_depth=vars.id.nesting[i]}}}if(obj.name&&obj.icon){break}}}else{for(d in color_groups[color]){if(!obj.name){var name=d3plus.variable.text(vars,color_groups[color][d],vars.depth.value);if(name){obj.name=name}}if(!obj.icon){var icon=d3plus.variable.value(vars,color_groups[color][d],vars.icon.key);if(icon){obj.icon=icon}}if(obj.name&&obj.icon){break}}}colors.push(obj)}if(vars.dev.value)d3plus.console.timeEnd("grouping colors");var available_width=vars.width.value;square_size=vars.style.legend.size;var key_width=square_size*colors.length+vars.style.legend.padding*(colors.length+1);if(square_size instanceof Array){if(vars.dev.value)d3plus.console.time("calculating size");for(var i=square_size[1];i>=square_size[0];i--){key_width=i*colors.length+vars.style.legend.padding*(colors.length+1);if(available_width>=key_width){square_size=i;break}}if(vars.dev.value)d3plus.console.timeEnd("calculating size")}else if(typeof square_size!="number"&&square_size!==false){square_size=30}if(available_width<key_width||colors.length==1){key_display=false}else{key_width-=vars.style.legend.padding*2;if(vars.dev.value)d3plus.console.time("sorting colors");var sort=vars.legend.order.sort.value;colors.sort(function(a,b){if(vars.legend.order.value=="color"){var a_value=a.color,b_value=b.color;a_value=d3.rgb(a_value).hsl();b_value=d3.rgb(b_value).hsl();if(a_value.s==0)a_value=361;else a_value=a_value.h;if(b_value.s==0)b_value=361;else b_value=b_value.h}else if(vars.legend.order.value=="alpha"){var a_value=a.name[0],b_value=b.name[0]}if(a_value<b_value)return sort=="asc"?-1:1;if(a_value>b_value)return sort=="asc"?1:-1});if(vars.dev.value)d3plus.console.timeEnd("sorting colors");if(vars.style.legend.align=="start"){var start_x=vars.style.legend.padding}else if(vars.style.legend.align=="end"){var start_x=available_width-vars.style.legend.padding-key_width}else{var start_x=available_width/2-key_width/2}vars.g.key.selectAll("g.d3plus_scale").transition().duration(vars.style.timing.transitions).attr("opacity",0).remove();var keys=vars.g.key.selectAll("g.d3plus_color").data(colors,function(d){return d.url?d.color+"_"+d.url:d.color});function position(group){group.attr("transform",function(g,i){var x=start_x+i*(vars.style.legend.padding+square_size);return"translate("+x+","+vars.style.legend.padding+")"})}var key_enter=keys.enter().append("g").attr("class","d3plus_color").attr("opacity",0).call(position);function style(rect){rect.attr("width",square_size).attr("height",square_size).attr("fill",function(g){d3.select(this.parentNode).selectAll("text").remove();if(g.icon){var short_url=d3plus.utils.strip(g.icon+"_"+g.color);var pattern=vars.defs.selectAll("pattern#"+short_url).data([short_url]);if(typeof vars.icon.style.value=="string"){var icon_style=vars.icon.style.value}else if(typeof vars.icon.style.value=="object"&&vars.icon.style.value[g.icon_depth]){var icon_style=vars.icon.style.value[g.icon_depth]}else{var icon_style="default"}var color=icon_style=="knockout"?g.color:"none";pattern.select("rect").transition().duration(vars.style.timing.transitions).attr("fill",color).attr("width",square_size).attr("height",square_size);pattern.select("image").transition().duration(vars.style.timing.transitions).attr("width",square_size).attr("height",square_size);var pattern_enter=pattern.enter().append("pattern").attr("id",short_url).attr("width",square_size).attr("height",square_size);pattern_enter.append("rect").attr("fill",color).attr("width",square_size).attr("height",square_size);pattern_enter.append("image").attr("xlink:href",g.icon).attr("width",square_size).attr("height",square_size).each(function(d){d3plus.utils.dataurl(g.icon,function(base64){pattern.select("image").attr("xlink:href",base64)})});return"url(#"+short_url+")"}else{d3.select(this.parentNode).append("text").style("font-weight",vars.style.font.weight).attr("font-family",vars.style.font.family).attr("text-anchor","start").attr("fill",d3plus.color.text(g.color)).attr("x",0).attr("y",0).each(function(t){if(g.name){d3plus.utils.wordwrap({text:g.name,parent:this,width:square_size-vars.style.legend.padding*2,height:square_size-vars.style.legend.padding*2,resize:true})}}).attr("y",function(t){var h=this.getBBox().height,diff=parseFloat(d3.select(this).style("font-size"),10)/5;return square_size/2-h/2-diff/2}).selectAll("tspan").attr("x",function(t){var w=this.getComputedTextLength();return square_size/2-w/2});return g.color}})}key_enter.append("rect").attr("class","d3plus_color").call(style);keys.order().on(d3plus.evt.over,function(d,i){d3.select(this).style("cursor","pointer");if(d.name){d3.select(this).style("cursor","pointer");var x=start_x+i*(vars.style.legend.padding+square_size),y=d3.transform(d3.select(this.parentNode).attr("transform")).translate[1];x+=square_size/2;y+=vars.style.legend.padding+square_size/2;if(typeof vars.icon.style.value=="string"){var icon_style=vars.icon.style.value}else if(typeof vars.icon.style.value=="object"&&vars.icon.style.value[d.icon_depth]){var icon_style=vars.icon.style.value[d.icon_depth]}else{var icon_style="default"}d3plus.tooltip.create({align:"top center",arrow:true,background:vars.style.tooltip.background,fontcolor:vars.style.tooltip.font.color,fontfamily:vars.style.tooltip.font.family,fontweight:vars.style.tooltip.font.weight,color:d.color,icon:d.icon,id:"legend",offset:square_size/2-vars.style.legend.padding,parent:vars.parent,style:icon_style,title:d.name[0],x:x,y:y,width:"auto"})}}).on(d3plus.evt.out,function(d){d3plus.tooltip.remove("legend")}).transition().duration(vars.style.timing.transitions).attr("opacity",1).call(position);keys.selectAll("rect.d3plus_color").transition().duration(vars.style.timing.transitions).call(style);keys.exit().transition().duration(vars.style.timing.transitions).attr("opacity",0).remove()}}else if(vars.color_scale){if(vars.dev.value)d3plus.console.time("drawing color scale");vars.g.key.selectAll("g.d3plus_color").transition().duration(vars.style.timing.transitions).attr("opacity",0).remove();var values=vars.color_scale.domain(),colors=vars.color_scale.range();if(values.length<=2){values=d3plus.utils.buckets(values,6)}var scale=vars.g.key.selectAll("g.d3plus_scale").data(["scale"]);scale.enter().append("g").attr("class","d3plus_scale").attr("opacity",0);var heatmap=vars.defs.selectAll("#d3plus_legend_heatmap").data(["heatmap"]);heatmap.enter().append("linearGradient").attr("id","d3plus_legend_heatmap").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("spreadMethod","pad");var stops=heatmap.selectAll("stop").data(d3.range(0,colors.length));stops.enter().append("stop").attr("stop-opacity",1);stops.attr("offset",function(i){return Math.round(i/(colors.length-1)*100)+"%"}).attr("stop-color",function(i){return colors[i]});stops.exit().remove();var gradient=scale.selectAll("rect#gradient").data(["gradient"]);gradient.enter().append("rect").attr("id","gradient").attr("x",function(d){if(vars.style.legend.align=="middle"){return vars.width.value/2}else if(vars.style.legend.align=="end"){return vars.width.value}else{return 0}}).attr("y",vars.style.legend.padding).attr("width",0).attr("height",vars.style.legend.gradient.height).attr("stroke",vars.style.legend.tick.color).attr("stroke-width",1).style("fill","url(#d3plus_legend_heatmap)");var text=scale.selectAll("text.d3plus_tick").data(d3.range(0,values.length));text.enter().append("text").attr("class","d3plus_tick").attr("x",function(d){if(vars.style.legend.align=="middle"){return vars.width.value/2}else if(vars.style.legend.align=="end"){return vars.width.value}else{return 0}}).attr("y",function(d){return this.getBBox().height+vars.style.legend.gradient.height+vars.style.legend.padding*2});var label_width=0;text.order().style("font-weight",vars.style.legend.tick.weight).attr("font-family",vars.style.legend.tick.family).attr("font-size",vars.style.legend.tick.size).attr("text-anchor",vars.style.legend.tick.align).attr("fill",vars.style.legend.tick.color).text(function(d){return vars.format(values[d],key)}).attr("y",function(d){return this.getBBox().height+vars.style.legend.gradient.height+vars.style.legend.padding*2}).each(function(d){var w=this.offsetWidth;if(w>label_width)label_width=w});label_width+=vars.style.labels.padding*2;var key_width=label_width*(values.length-1);if(key_width+label_width<vars.width.value){if(key_width+label_width<vars.width.value/2){key_width=vars.width.value/2;label_width=key_width/values.length;key_width-=label_width}if(vars.style.legend.align=="start"){var start_x=vars.style.legend.padding}else if(vars.style.legend.align=="end"){var start_x=vars.width.value-vars.style.legend.padding-key_width}else{var start_x=vars.width.value/2-key_width/2}text.transition().duration(vars.style.timing.transitions).attr("x",function(d){return start_x+label_width*d});text.exit().transition().duration(vars.style.timing.transitions).attr("opacity",0).remove();var ticks=scale.selectAll("rect.d3plus_tick").data(d3.range(0,values.length));ticks.enter().append("rect").attr("class","d3plus_tick").attr("x",function(d){if(vars.style.legend.align=="middle"){return vars.width.value/2}else if(vars.style.legend.align=="end"){return vars.width.value}else{return 0}}).attr("y",vars.style.legend.padding).attr("width",0).attr("height",vars.style.legend.padding+vars.style.legend.gradient.height).attr("fill",vars.style.legend.tick.color);ticks.transition().duration(vars.style.timing.transitions).attr("x",function(d){var mod=d==0?1:0;return start_x+label_width*d-mod}).attr("y",vars.style.legend.padding).attr("width",1).attr("height",vars.style.legend.padding+vars.style.legend.gradient.height).attr("fill",vars.style.legend.tick.color);ticks.exit().transition().duration(vars.style.timing.transitions).attr("width",0).remove();gradient.transition().duration(vars.style.timing.transitions).attr("x",function(d){if(vars.style.legend.align=="middle"){return vars.width.value/2-key_width/2}else if(vars.style.legend.align=="end"){return vars.width.value-key_width-vars.style.legend.padding}else{return vars.style.legend.padding}}).attr("y",vars.style.legend.padding).attr("width",key_width).attr("height",vars.style.legend.gradient.height);scale.transition().duration(vars.style.timing.transitions).attr("opacity",1);if(vars.dev.value)d3plus.console.timeEnd("drawing color scale")}else{key_display=false}}else{key_display=false}}else{key_display=false}if(vars.legend.value&&key&&key_display){if(vars.dev.value)d3plus.console.time("positioning legend");if(square_size){var key_height=square_size}else{var key_box=vars.g.key.node().getBBox(),key_height=key_box.height+key_box.y}vars.margin.bottom+=key_height+vars.style.legend.padding*2;vars.g.key.transition().duration(vars.style.timing.transitions).attr("transform","translate(0,"+(vars.height.value-vars.margin.bottom)+")");if(vars.dev.value)d3plus.console.timeEnd("positioning legend")}else{if(vars.dev.value)d3plus.console.time("hiding legend");vars.g.key.transition().duration(vars.style.timing.transitions).attr("transform","translate(0,"+vars.height.value+")");if(vars.dev.value)d3plus.console.timeEnd("hiding legend")}if(vars.legend.value&&key&&vars.dev.value){d3plus.console.groupEnd()}};d3plus.info.timeline=function(vars){var years=vars.data.time;if(!vars.small&&years&&years.length>1&&vars.timeline.value){if(vars.time.key==vars.x.key&&vars.x.scale.value=="continuous"||vars.time.key==vars.y.key&&vars.y.scale.value=="continuous"){var min_required=2}else{var min_required=1}if(vars.time.solo.value.length){var init=d3.extent(vars.time.solo.value)}else{var init=d3.extent(years)}var min=years[0],max=years[years.length-1],start=init[0],end=init[1],year_ticks=[],steps=[];years.forEach(function(y,i){if(i!=0)steps.push(y-years[i-1])});var step=d3.min(steps),total=step*years.length;years=[];for(var i=min;i<=max;i+=step){years.push(i);year_ticks.push(d3.time.year(new Date(parseInt(i),0,1)))}year_ticks.push(d3.time.year(new Date(parseInt(max+step),0,1)));var brushend=function(){if(d3.event.sourceEvent!==null){var extent0=brush.extent(),min_val=d3plus.utils.closest(year_ticks,d3.time.year.round(extent0[0])),max_val=d3plus.utils.closest(year_ticks,d3.time.year.round(extent0[1]));if(min_val==max_val){min_val=d3plus.utils.closest(year_ticks,d3.time.year.floor(extent0[0]))}var min_index=year_ticks.indexOf(min_val),max_index=year_ticks.indexOf(max_val);if(max_index-min_index>=min_required){var extent=[min_val,max_val]}else if(min_index+min_required<=years.length){var extent=[min_val,year_ticks[min_index+min_required]]}else{var extent=[min_val];for(var i=1;i<=min_required;i++){if(min_index+i<=years.length){extent.push(year_ticks[min_index+i])}else{extent.unshift(year_ticks[min_index-(min_index+i-years.length)])}}extent=[extent[0],extent[extent.length-1]]}d3.select(this).transition().call(brush.extent(extent)).each("end",function(d){var new_years=d3.range(extent[0].getFullYear(),extent[1].getFullYear());new_years=new_years.filter(function(d){return years.indexOf(d)>=0});vars.viz.time({solo:new_years});if(!vars.autodraw){vars.viz.draw()}})}else{return}};var background=vars.g.timeline.selectAll("rect.d3plus_timeline_background").data(["background"]);background.enter().append("rect").attr("class","d3plus_timeline_background");var labels=vars.g.timeline.selectAll("g#labels").data(["labels"]);labels.enter().append("g").attr("id","labels");var text=labels.selectAll("text").data(years,function(d,i){return i});text.enter().append("text").attr("y",0).attr("dy",0).attr("x",function(d){if(vars.style.timeline.align=="middle"){return vars.width.value/2}else if(vars.style.timeline.align=="end"){return vars.width.value}else{return 0}}).attr("y",function(d){var diff=diff=parseFloat(d3.select(this).style("font-size"),10)/5;var y=vars.style.timeline.padding+vars.style.timeline.height/2+this.getBBox().height/2-diff;return y});var year_width=0,year_height=0,height=vars.style.timeline.height+vars.style.timeline.padding;text.order().style("font-weight",vars.style.timeline.tick.weight).attr("font-family",vars.style.timeline.tick.family).attr("font-size",vars.style.timeline.tick.size).attr("text-anchor",vars.style.timeline.tick.align).attr("opacity",0).text(function(d){return d}).each(function(d){var w=this.getBBox().width,h=this.getBBox().height;if(w>year_width)year_width=w;if(h>year_height)year_height=h});var label_width=year_width+vars.style.timeline.padding*2,timeline_width=label_width*years.length,available_width=vars.width.value-vars.style.timeline.padding*2,step=1;if(timeline_width>available_width){timeline_width=available_width;step=Math.ceil(label_width/(timeline_width/years.length));label_width=timeline_width/years.length;for(step;step<years.length-1;step++){if((years.length-1)%step==0){break}}height+=year_height}if(vars.style.timeline.align=="start"){var start_x=vars.style.timeline.padding}else if(vars.style.timeline.align=="end"){var start_x=vars.width.value-vars.style.timeline.padding-timeline_width}else{var start_x=vars.width.value/2-timeline_width/2}text.text(function(d,i){return i%step==0?d:""}).attr("opacity",1);text.transition().duration(vars.style.timing.transitions).attr("fill",function(d){if(d>=init[0]&&d<=init[1]){var color1=vars.style.timeline.background,color2=vars.style.timeline.brush.color,opacity=vars.style.timeline.brush.opacity;mixed=d3plus.color.mix(color2,color1,opacity);return d3plus.color.text(mixed)}return d3plus.color.text(vars.style.timeline.background)}).attr("x",function(d,i){return start_x+label_width*i+label_width/2}).attr("y",function(d){var diff=diff=parseFloat(d3.select(this).style("font-size"),10)/5;var y=vars.style.timeline.padding+vars.style.timeline.height/2+this.getBBox().height/2-diff;if(step>1){y+=year_height+vars.style.timeline.padding}return y});text.exit().transition().duration(vars.style.timing.transitions).attr("opacity",0).remove();background.transition().duration(vars.style.timing.transitions).attr("width",timeline_width).attr("height",vars.style.timeline.height).attr("x",start_x).attr("y",vars.style.timeline.padding).attr("fill",vars.style.timeline.background);var x=d3.time.scale().domain(d3.extent(year_ticks)).range([0,timeline_width]);var brush=d3.svg.brush().x(x).extent([year_ticks[years.indexOf(start)],year_ticks[years.indexOf(end)+1]]).on("brushend",brushend);var ticks=vars.g.timeline.selectAll("g#ticks").data(["ticks"]);ticks.enter().append("g").attr("id","ticks").attr("transform","translate("+start_x+","+vars.style.timeline.padding+")");ticks.transition().duration(vars.style.timing.transitions).attr("transform","translate("+start_x+","+vars.style.timeline.padding+")").call(d3.svg.axis().scale(x).orient("top").ticks(function(){return year_ticks}).tickFormat("").tickSize(-vars.style.timeline.height).tickPadding(0)).selectAll("path").attr("fill","none");ticks.selectAll("line").transition().duration(vars.style.timing.transitions).attr("stroke",vars.style.timeline.tick.color).attr("shape-rendering",vars.style.rendering);var brush_group=vars.g.timeline.selectAll("g#brush").data(["brush"]);brush_group.enter().append("g").attr("id","brush").attr("transform","translate("+start_x+","+vars.style.timeline.padding+")").attr("opacity",0);brush_group.attr("transform","translate("+start_x+","+vars.style.timeline.padding+")").attr("opacity",1).call(brush);brush_group.selectAll("rect.background, rect.extent").attr("height",vars.style.timeline.height);brush_group.selectAll("rect.background").transition().duration(vars.style.timing.transitions).attr("stroke",vars.style.timeline.tick.color).attr("stroke-width",1).style("visibility","visible").attr("fill","none").attr("shape-rendering",vars.style.rendering);brush_group.selectAll("rect.extent").transition().duration(vars.style.timing.transitions).attr("fill",vars.style.timeline.brush.color).attr("fill-opacity",vars.style.timeline.brush.opacity);brush_group.selectAll("g.resize").on(d3plus.evt.over,function(){d3.select(this).select("rect").transition().duration(vars.style.timing.mouseevents).attr("fill",vars.style.timeline.handles.hover)}).on(d3plus.evt.out,function(){d3.select(this).select("rect").transition().duration(vars.style.timing.mouseevents).attr("fill",vars.style.timeline.handles.color)}).select("rect").transition().duration(vars.style.timing.transitions).attr("fill",vars.style.timeline.handles.color).attr("stroke",vars.style.timeline.tick.color).attr("stroke-width",1).attr("x",-vars.style.timeline.handles.size/2).attr("y",-1).attr("width",vars.style.timeline.handles.size).attr("height",vars.style.timeline.height+2).style("visibility","visible");if(vars.margin.bottom==0){vars.margin.bottom+=vars.style.timeline.padding}vars.margin.bottom+=height;vars.g.timeline.transition().duration(vars.style.timing.transitions).attr("transform","translate(0,"+(vars.height.value-vars.margin.bottom)+")")
}else{vars.g.timeline.transition().duration(vars.style.timing.transitions).attr("transform","translate(0,"+vars.height.value+")")}};d3plus.info.titles=function(vars){if(!vars.data.app||!vars.title.total.value){vars.data.total=null}else{if(vars.dev.value)d3plus.console.group("Calculating Total Value");if(vars.dev.value)d3plus.console.time(vars.size.key);if(vars.focus.value&&typeof vars.data.app=="object"){if(vars.data.app[vars.focus.value])vars.data.total=d3plus.variable.value(vars,vars.data.app[vars.focus.value],vars.size.key);else{vars.data.total=null}}else{vars.data.total=d3.sum(vars.data.pool,function(d){return d3plus.variable.value(vars,d,vars.size.key)})}if(vars.dev.value)d3plus.console.timeEnd(vars.size.key);if(vars.dev.value)d3plus.console.groupEnd()}vars.margin.top=0;var title_offset=0;if(vars.width.value<=vars.width.small||vars.height.value<=vars.height.small){vars.small=true;vars.graph.margin={top:0,right:0,bottom:0,left:0};vars.graph.width=vars.app_width;make_title(null,"title");make_title(null,"sub_title");make_title(null,"total_bar");update_footer(null)}else{if(vars.dev.value)d3plus.console.log("Drawing Titles");vars.small=false;vars.graph.margin={top:10,right:10,bottom:40,left:40};vars.graph.width=vars.app_width-vars.graph.margin.left-vars.graph.margin.right;make_title(vars.title.value,"title");make_title(vars.title.sub.value,"sub_title");if(vars.data.app&&!vars.error.value){make_title(vars.data.total,"total_bar")}else{make_title(null,"total_bar")}if(vars.margin.top>0){vars.margin.top+=3;if(vars.style.title.height&&vars.margin.top<vars.style.title.height){title_offset=(vars.style.title.height-vars.margin.top)/2;vars.margin.top=vars.style.title.height}}update_footer(vars.footer)}vars.g.titles.transition().duration(vars.style.timing.transitions).attr("transform","translate(0,"+title_offset+")");function make_title(t,type){var font_size=type=="title"?18:13,title_position={x:vars.width.value/2,y:vars.margin.top};if(type=="total_bar"&&t){title=vars.format(t,vars.size.key);vars.title.total.value.prefix?title=vars.title.total.value.prefix+title:null;vars.title.total.value.suffix?title=title+vars.title.total.value.suffix:null;if((vars.mute.length||vars.solo.length)&&vars.type.value!="rings"){var overall_total=d3.sum(vars.data.value,function(d){if(vars.time.solo.value.length>0){var match=vars.time.solo.value.indexOf(d3plus.variable.value(vars,d,vars.time.key))>=0}else if(vars.time.mute.value.length>0){var match=vars.time.solo.value.indexOf(d3plus.variable.value(vars,d,vars.time.key))<0}else{var match=true}if(match){return d3plus.variable.value(vars,d,vars.size.key)}});var pct=t/overall_total*100;ot=vars.format(overall_total,vars.size.key);title+=" ("+vars.format(pct,"share")+"% of "+ot+")"}}else{title=t}if(title){var title_data=title_position;title_data.title=title;title_data=[title_data]}else{var title_data=[]}var total=vars.g.titles.selectAll("g.d3plus_"+type).data(title_data);total.enter().append("g").attr("class","d3plus_"+type).style("opacity",0).append("text").attr("x",function(d){return d.x}).attr("y",function(d){return d.y}).attr("font-size",font_size).attr("fill","#333").attr("text-anchor",vars.style.title.align).attr("font-family",vars.style.font.family).style("font-weight",vars.style.font.weight).each(function(d){var width=vars.style.title.width||vars.width.value;d3plus.utils.wordwrap({text:d.title,parent:this,width:width,height:vars.height.value/8,resize:false})});total.transition().duration(vars.style.timing.transitions).style("opacity",1);d3plus.info.title_update(vars);total.exit().transition().duration(vars.style.timing.transitions).style("opacity",0).remove();if(total.node())vars.margin.top+=total.select("text").node().getBBox().height}function update_footer(footer_text){if(footer_text&&footer_text.value){if(footer_text.value.indexOf("<a href=")==0){var div=document.createElement("div");div.innerHTML=footer_text.value;var t=footer_text.value.split("href=")[1];var link=t.split(t.charAt(0))[1];if(link.charAt(0)!="h"&&link.charAt(0)!="/"){link="http://"+link}var d=[div.getElementsByTagName("a")[0].innerHTML]}else{var d=[footer_text.value]}}else var d=[];var source=vars.g.footer.selectAll("text.d3plus_source").data(d);var padding=3;source.enter().append("text").attr("class","d3plus_source").attr("opacity",0).attr("x",vars.width.value/2+"px").attr("y",padding-1+"px").attr("font-size","10px").attr("fill","#333").attr("text-anchor","middle").attr("font-family",vars.style.font.family).style("font-weight",vars.style.font.weight).each(function(d){d3plus.utils.wordwrap({text:d,parent:this,width:vars.width.value-20,height:vars.height.value/8,resize:false})}).on(d3plus.evt.over,function(){if(link){d3.select(this).style("text-decoration","underline").style("cursor","pointer").style("fill","#000")}}).on(d3plus.evt.out,function(){if(link){d3.select(this).style("text-decoration","none").style("cursor","auto").style("fill","#333")}}).on(d3plus.evt.click,function(){if(link){if(link.charAt(0)!="/")var target="_blank";else var target="_self";window.open(link,target)}});source.attr("opacity",1).attr("x",vars.width.value/2+"px").attr("font-family",vars.style.font.family).style("font-weight",vars.style.font.weight).each(function(d){d3plus.utils.wordwrap({text:d,parent:this,width:vars.width.value-20,height:vars.height.value/8,resize:false})});source.exit().transition().duration(vars.style.timing.transitions).attr("opacity",0).remove();if(d.length){var height=source.node().getBBox().height;vars.margin.bottom=height+padding*2}else{vars.margin.bottom=0}vars.g.footer.transition().duration(vars.style.timing.transitions).attr("transform","translate(0,"+(vars.height.value-vars.margin.bottom)+")")}};d3plus.info.title_update=function(vars){vars.g.titles.selectAll("g").select("text").transition().duration(vars.style.timing.transitions).attr("x",function(d){return d.x}).attr("y",function(d){return d.y}).each(function(d){var width=vars.style.title.width||vars.width.value;d3plus.utils.wordwrap({text:d.title,parent:this,width:width,height:vars.height.value/8,resize:false})}).selectAll("tspan").attr("x",function(d){return d.x})};d3plus.shape.area=function(vars,selection,enter,exit){var area=d3.svg.area().x(function(d){return d.d3plus.x}).y0(function(d){return d.d3plus.y0}).y1(function(d){return d.d3plus.y}).interpolate(vars.shape.interpolate.value);enter.append("path").attr("class","d3plus_data").attr("d",function(d){return area(d.values)}).call(d3plus.shape.style,vars);selection.selectAll("path.d3plus_data").data(function(d){if(vars.labels.value){var areas=[],obj=null,obj2=null,label={w:0,h:0,x:0,y:0};function check_area(area){obj.y=d3.max([obj.y,area.y]);obj.y0=d3.min([obj.y0,area.y0]);obj.x0=area.x;obj.h=obj.y0-obj.y;obj.w=obj.x0-obj.x;var toosmall=obj.h<10||obj.w<30,aspect_old=label.w/label.h,size_old=label.w*label.h,aspect_new=obj.w/obj.h,size_new=obj.w*obj.h;if(!toosmall&&size_old<size_new||!label.w){label={w:obj.w-vars.style.labels.padding*2,h:obj.h-vars.style.labels.padding*2,x:obj.x+obj.w/2,y:obj.y+obj.h/2}}if(obj.h<10){obj=d3plus.utils.copy(area)}}d.values.forEach(function(v,i){if(!obj){obj=d3plus.utils.copy(v.d3plus)}else{var arr=d3plus.utils.buckets([0,1],vars.style.labels.segments+1);arr.shift();arr.pop();arr.forEach(function(n){var test=d3plus.utils.copy(v.d3plus),last=d.values[i-1].d3plus;test.x=last.x+(test.x-last.x)*n;test.y=last.y+(test.y-last.y)*n;test.y0=last.y0+(test.y0-last.y0)*n;check_area(test)});check_area(d3plus.utils.copy(v.d3plus))}});if(label.w>=20&&label.h>=10){d.d3plus_label=label}}return[d]}).transition().duration(vars.style.timing.transitions).attr("d",function(d){return area(d.values)}).call(d3plus.shape.style,vars);var mouses=selection.selectAll("path.d3plus_mouse").data(function(d){return[d]});mouses.enter().append("path").attr("class","d3plus_mouse").attr("opacity",0).attr("stroke",1).attr("d",function(d){return area(d.values)});mouses.data(function(d){return[d]}).on(d3plus.evt.over,function(d){if(!vars.frozen){d3.select(this).style("cursor","pointer");var mouse=d3.event[vars.continuous_axis];positions=d3plus.utils.uniques(d.values,function(x){return x.d3plus[vars.continuous_axis]}),closest=d3plus.utils.closest(positions,mouse);d.data=d.values[positions.indexOf(closest)];d.d3plus=d.values[positions.indexOf(closest)].d3plus;d3.select(this.parentNode).selectAll("path.d3plus_data").transition().duration(vars.style.timing.mouseevents).style("opacity",1)}}).on(d3plus.evt.move,function(d){if(!vars.frozen){var mouse=d3.event.x,positions=d3plus.utils.uniques(d.values,function(x){return x.d3plus.x}),closest=d3plus.utils.closest(positions,mouse);d.data=d.values[positions.indexOf(closest)];d.d3plus=d.values[positions.indexOf(closest)].d3plus}}).on(d3plus.evt.out,function(d){if(!vars.frozen){d3.select(this.parentNode).selectAll("path.d3plus_data").transition().duration(vars.style.timing.mouseevents).style("opacity",vars.style.data.opacity);delete d.d3plus}}).transition().duration(vars.style.timing.transitions).attr("d",function(d){return area(d.values)})};d3plus.shape.color=function(d,vars){var shape=d.d3plus?d.d3plus.shapeType:vars.shape.value;if(vars.shape.value=="line"){if(shape=="circle"){return d3plus.variable.color(vars,d)}else{return"none"}}else if(vars.shape.value=="area"||shape=="active"){return d3plus.variable.color(vars,d)}else if(shape=="temp"){return"url(#d3plus_hatch_"+d.d3plus.id+")"}else if(shape=="active"){return d3plus.variable.color(vars,d)}if(d.d3plus.static){return d3plus.color.lighter(d3plus.variable.color(vars,d))}var active=vars.active.key?d3plus.variable.value(vars,d,vars.active.key):d.d3plus.active,temp=vars.temp.key?d3plus.variable.value(vars,d,vars.temp.key):d.d3plus.temp,total=vars.total.key?d3plus.variable.value(vars,d,vars.total.key):d.d3plus.total;if(!vars.active.key&&!vars.temp.key||active&&total&&active==total&&!temp||active&&!total){return d3plus.variable.color(vars,d)}else if(vars.active.spotlight.value){return"#eee"}else{return d3plus.color.lighter(d3plus.variable.color(vars,d))}};d3plus.shape.coordinates=function(vars,selection,enter,exit){var projection=d3.geo[vars.coords.projection.value]();var clip=d3.geo.clipExtent().extent([[0,0],[vars.app_width,vars.app_height]]);if(!vars.zoom.scale){vars.zoom.scale=1}vars.zoom.area=1/vars.zoom.scale/vars.zoom.scale;var path=d3.geo.path().projection(projection);enter.append("path").attr("id",function(d){return d.id}).attr("class","d3plus_data").attr("d",path).call(d3plus.shape.style,vars);selection.selectAll("path.d3plus_data").on(d3plus.evt.over,function(d){if(!vars.frozen){d3.select(this).attr("opacity",1)}}).on(d3plus.evt.out,function(d){if(!vars.frozen){d3.select(this).attr("opacity",vars.style.data.opacity)}}).transition().duration(vars.style.timing.transitions).call(d3plus.shape.style,vars);if(vars.coords.changed||vars.width.changed||vars.height.changed){if(vars.viewport==vars.bounds){vars.viewport=false}vars.bounds=false;selection.each(function(d){var b=path.bounds(d);if(!vars.bounds){vars.bounds=b}else{if(vars.bounds[0][0]>b[0][0]){vars.bounds[0][0]=b[0][0]}if(vars.bounds[0][1]>b[0][1]){vars.bounds[0][1]=b[0][1]}if(vars.bounds[1][0]<b[1][0]){vars.bounds[1][0]=b[1][0]}if(vars.bounds[1][1]<b[1][1]){vars.bounds[1][1]=b[1][1]}}})}if(!vars.viewport){d3plus.zoom.reset(vars)}};d3plus.shape.donut=function(vars,selection,enter,exit,transform){if(!vars.arcs){vars.arcs={donut:{},active:{},temp:{}}}var arc=d3.svg.arc().startAngle(0).endAngle(function(d){var a=vars.arcs[d.d3plus.shapeType][d.d3plus.id].a;return a>Math.PI*2?Math.PI*2:a}).innerRadius(function(d){if(shape=="donut"&&!d.d3plus.static){var r=vars.arcs[d.d3plus.shapeType][d.d3plus.id].r;return r*vars.style.data.donut.size}else{return 0}}).outerRadius(function(d){var r=vars.arcs[d.d3plus.shapeType][d.d3plus.id].r;if(d.d3plus.shapeType!="donut")return r*2;else return r});function size(path,mod,rad,ang){if(!mod)var mod=0;if(typeof rad!="number")var rad=undefined;if(typeof ang!="number")var ang=undefined;path.attrTween("d",function(d){if(rad==undefined)var r=d.d3plus.r?d.d3plus.r:d3.max([d.d3plus.width,d.d3plus.height]);else var r=rad;if(ang==undefined)var a=d.d3plus.a[d.d3plus.shapeType];else var a=ang;if(!vars.arcs[d.d3plus.shapeType][d.d3plus.id]){vars.arcs[d.d3plus.shapeType][d.d3plus.id]={r:0};vars.arcs[d.d3plus.shapeType][d.d3plus.id].a=d.d3plus.shapeType=="donut"?Math.PI*2:0}var radius=d3.interpolate(vars.arcs[d.d3plus.shapeType][d.d3plus.id].r,r+mod),angle=d3.interpolate(vars.arcs[d.d3plus.shapeType][d.d3plus.id].a,a);return function(t){vars.arcs[d.d3plus.shapeType][d.d3plus.id].r=radius(t);vars.arcs[d.d3plus.shapeType][d.d3plus.id].a=angle(t);return arc(d)}})}enter.append("path").attr("class","d3plus_data").transition().duration(0).call(size,0,0).call(d3plus.shape.style,vars);selection.selectAll("path.d3plus_data").data(function(d){return[d]}).transition().duration(vars.style.timing.transitions).call(size).call(d3plus.shape.style,vars);exit.selectAll("path.d3plus_data").transition().duration(vars.style.timing.transitions).call(size,0,0).each("end",function(d){delete vars.arcs[d.d3plus.shapeType][d.d3plus.id]});var mouses=selection.selectAll("rect.d3plus_mouse").data(function(d){return!d.d3plus.static?[d]:[]});mouses.enter().append("rect").attr("class","d3plus_mouse").attr("x",0).attr("y",0).attr("width",0).attr("height",0).attr("opacity",0);mouses.data(function(d){return!d.d3plus.static?[d]:[]}).on(d3plus.evt.over,function(d){if(!vars.frozen){d3.select(this).style("cursor","pointer");d3.select(this.parentNode).selectAll("path.d3plus_data").transition().duration(vars.style.timing.mouseevents).attr("opacity",1);d3.select(this.parentNode).transition().duration(vars.style.timing.mouseevents).call(transform,true)}}).on(d3plus.evt.out,function(d){if(!vars.frozen){d3.select(this.parentNode).selectAll("path.d3plus_data").transition().duration(vars.style.timing.mouseevents).attr("opacity",vars.style.data.opacity);d3.select(this.parentNode).transition().duration(vars.style.timing.mouseevents).call(transform)}}).transition().duration(vars.style.timing.transitions).attr("x",function(d){var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width;return-w/2-3}).attr("y",function(d){var h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;return-h/2-3}).attr("width",function(d){var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width;return w+6}).attr("height",function(d){var h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;return h+6}).attr("rx",function(d){var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width;return(w+6)/2}).attr("ry",function(d){var h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;return(h+6)/2}).attr("shape-rendering","auto")};d3plus.shape.draw=function(vars,data){var shape_lookup={area:"area",circle:"rect",donut:"donut",line:"line",square:"rect",coordinates:"coordinates"};var shapes={};data.forEach(function(d){if(!d.d3plus){var s=shape_lookup[vars.shape.value]}else if(!d.d3plus.shape){var s=shape_lookup[vars.shape.value];d.d3plus.shapeType=s}else{var s=d.d3plus.shape;d.d3plus.shapeType=s}if(!shapes[s]){shapes[s]=[]}shapes[s].push(d)});function id(d){var depth=d.d3plus.depth?d.d3plus.depth:vars.depth.value;d.d3plus.id="";vars.id.nesting.forEach(function(n,i){if(i<=depth){d.d3plus.id+=d3plus.variable.value(vars,d,n);d.d3plus.id+="_"}});d.d3plus.id+=depth+"_"+shape;vars.axes.values.forEach(function(axis){if(vars[axis].scale.value=="continuous"){d.d3plus.id+="_"+d3plus.variable.value(vars,d,vars[axis].key)}});d.d3plus.id=d3plus.utils.strip(d.d3plus.id);return d}function transform(g,grow){var scales=d3plus.apps[vars.type.value].scale;if(grow&&scales&&scales[vars.shape.value]){var scale=scales[vars.shape.value]}else if(grow&&scales&&typeof scales=="number"){var scale=scales}else{var scale=1}g.attr("transform",function(d){if(["line","area","coordinates"].indexOf(shape)<0){return"translate("+d.d3plus.x+","+d.d3plus.y+")scale("+scale+")"}else{return"scale("+scale+")"}})}for(shape in shape_lookup){if(!(shape_lookup[shape]in shapes)){vars.g.data.selectAll("g."+shape_lookup[shape]).transition().duration(vars.style.timing.transitions).attr("opacity",0).remove()}}var labels=[],shares=[];for(shape in shapes){if(vars.dev.value)d3plus.console.group('Drawing "'+shape+'" groups');if(vars.dev.value)d3plus.console.time("filtering out small shapes");var filtered_shapes=shapes[shape].filter(function(s){if(s.d3plus){if("width"in s.d3plus&&s.d3plus.width<1){return false}if("height"in s.d3plus&&s.d3plus.height<1){return false}if("r"in s.d3plus&&s.d3plus.r<.5){return false}}else if(s.values){var small=true;s.values.forEach(function(v){if(!("y0"in v.d3plus)){small=false}else if(small&&"y0"in v.d3plus&&v.d3plus.y0-v.d3plus.y>=1){small=false}});if(small){return false}}return true});if(vars.dev.value){d3plus.console.timeEnd("filtering out small shapes");var removed=shapes[shape].length-filtered_shapes.length,percent=d3.round(removed/shapes[shape].length,2);console.log("removed "+removed+" out of "+shapes[shape].length+" shapes ("+percent*100+"% reduction)")}var selection=vars.g.data.selectAll("g.d3plus_"+shape).data(filtered_shapes,function(d){if(shape=="coordinates"){if(!d.d3plus){d.d3plus={}}return d.id}if(d.values){d.values.forEach(function(v){v=id(v);v.d3plus.shapeType="circle"})}else{d=id(d);if(!d.d3plus.a){d.d3plus.a={donut:Math.PI*2};var active=vars.active.key?d.d3plus[vars.active.key]:d.d3plus.active,temp=vars.temp.key?d.d3plus[vars.temp.key]:d.d3plus.temp,total=vars.total.key?d.d3plus[vars.total.key]:d.d3plus.total;if(total){if(active){d.d3plus.a.active=active/total*Math.PI*2}else{d.d3plus.a.active=0}if(temp){d.d3plus.a.temp=temp/total*Math.PI*2+d.d3plus.a.active}else{d.d3plus.a.temp=0}}}}return d.d3plus?d.d3plus.id:d[vars.id.key]});var enter=selection.enter().append("g").attr("class","d3plus_"+shape).attr("opacity",0).call(transform);selection.order().transition().duration(vars.style.timing.transitions).call(transform).attr("opacity",1);var exit=selection.exit().transition().duration(vars.style.timing.transitions).attr("opacity",0).remove();if(vars.dev.value)d3plus.console.time("shapes");d3plus.shape[shape](vars,selection,enter,exit,transform);if(vars.dev.value)d3plus.console.timeEnd("shapes");if(["rect","donut"].indexOf(shape)>=0){d3plus.shape.fill(vars,selection,enter,exit,transform)}if(vars.dev.value)d3plus.console.time("labels");d3plus.shape.labels(vars,selection);if(vars.dev.value)d3plus.console.timeEnd("labels");if(vars.dev.value)d3plus.console.groupEnd()}function links(d){var link_count=vars.g.links.selectAll("line, path").size();if(d){vars.g.links.selectAll("g").each(function(l){var id=d[vars.id.key],source=l.source[vars.id.key],target=l.target[vars.id.key];if(source==id||target==id){vars.g.link_focus.node().appendChild(this.cloneNode(true))}});var marker=vars.links.arrows.value?"url(#d3plus_link_marker_highlight)":"none";vars.g.link_focus.attr("opacity",0).selectAll("line, path").style("stroke",vars.style.highlight.primary).attr("marker-start",function(){return vars.links.arrows.direction.value=="source"?marker:"none"}).attr("marker-end",function(){return vars.links.arrows.direction.value=="target"?marker:"none"});vars.g.link_focus.transition().duration(vars.style.timing.mouseevents).attr("opacity",1);if(link_count<vars.links.large){vars.g.links.transition().duration(vars.style.timing.mouseevents).attr("opacity",.5)}}else{vars.g.link_focus.transition().duration(vars.style.timing.mouseevents).attr("opacity",0).transition().selectAll("*").remove();if(link_count<vars.links.large){vars.g.links.transition().duration(vars.style.timing.mouseevents).attr("opacity",1)}}}vars.g.data.selectAll("g").on(d3plus.evt.over,function(d){if(!vars.frozen&&(!d.d3plus||!d.d3plus.static)){d3.select(this).style("cursor","pointer");if(!vars.small){vars.covered=false;var tooltip_data=d.data?d.data:d;d3plus.tooltip.app({vars:vars,data:tooltip_data});if(typeof vars.mouse=="function"){vars.mouse(d)}else if(vars.mouse.over){vars.mouse.over(d)}}links(d)}}).on(d3plus.evt.move,function(d){if(!vars.frozen&&(!d.d3plus||!d.d3plus.static)){if(!vars.small){vars.covered=false;if(["area","line"].indexOf(vars.shape.value)>=0||d3plus.apps[vars.type.value].tooltip=="follow"){var tooltip_data=d.data?d.data:d;d3plus.tooltip.app({vars:vars,data:tooltip_data})}if(typeof vars.mouse=="function"){vars.mouse(d)}else if(vars.mouse.move){vars.mouse.move(d)}}}}).on(d3plus.evt.out,function(d){if(!vars.frozen&&(!d.d3plus||!d.d3plus.static)){if(!vars.small){if(!vars.covered){d3plus.tooltip.remove(vars.type.value)}if(typeof vars.mouse=="function"){vars.mouse(d)}else if(vars.mouse.out){vars.mouse.out(d)}}links()}}).on(d3plus.evt.click,function(d){if(!vars.frozen&&(!d.d3plus||!d.d3plus.static)){if(!vars.small){links();var tooltip_data=d.data?d.data:d;d3plus.tooltip.app({vars:vars,data:tooltip_data});if(typeof vars.mouse=="function"){vars.mouse(d)}else if(vars.mouse.click){vars.mouse.click(d)}}}})};d3plus.shape.fill=function(vars,selection,enter,exit){function init(nodes){nodes.attr("x",0).attr("y",0).attr("width",0).attr("height",0)}function update(nodes,mod){if(!mod)var mod=0;nodes.attr("x",function(d){var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width;return-w/2-mod/2}).attr("y",function(d){var h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;return-h/2-mod/2}).attr("width",function(d){var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width;return w+mod}).attr("height",function(d){var h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;return h+mod}).attr("rx",function(d){var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width;var rounded=["circle","donut"].indexOf(vars.shape.value)>=0;return rounded?(w+mod)/2:0}).attr("ry",function(d){var h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;var rounded=["circle","donut"].indexOf(vars.shape.value)>=0;return rounded?(h+mod)/2:0}).attr("shape-rendering",function(d){if(["square"].indexOf(vars.shape.value)>=0){return vars.style.rendering}else{return"auto"}})}if(!vars.arcs){vars.arcs={donut:{},active:{},temp:{}}}var arc=d3.svg.arc().startAngle(0).endAngle(function(d){var a=vars.arcs[d.d3plus.shapeType][d.d3plus.id].a;return a>Math.PI*2?Math.PI*2:a}).innerRadius(function(d){if(shape=="donut"&&!d.d3plus.static){var r=vars.arcs[d.d3plus.shapeType][d.d3plus.id].r;return r*vars.style.data.donut.size}else{return 0}}).outerRadius(function(d){var r=vars.arcs[d.d3plus.shapeType][d.d3plus.id].r;if(d.d3plus.shapeType!="donut")return r*2;else return r});function size(path,mod,rad,ang){if(!mod)var mod=0;if(typeof rad!="number")var rad=undefined;if(typeof ang!="number")var ang=undefined;path.attrTween("d",function(d){if(rad==undefined)var r=d.d3plus.r?d.d3plus.r:d3.max([d.d3plus.width,d.d3plus.height]);else var r=rad;if(ang==undefined)var a=d.d3plus.a[d.d3plus.shapeType];else var a=ang;if(!vars.arcs[d.d3plus.shapeType][d.d3plus.id]){vars.arcs[d.d3plus.shapeType][d.d3plus.id]={r:0};vars.arcs[d.d3plus.shapeType][d.d3plus.id].a=d.d3plus.shapeType=="donut"?Math.PI*2:0}var radius=d3.interpolate(vars.arcs[d.d3plus.shapeType][d.d3plus.id].r,r+mod),angle=d3.interpolate(vars.arcs[d.d3plus.shapeType][d.d3plus.id].a,a);return function(t){vars.arcs[d.d3plus.shapeType][d.d3plus.id].r=radius(t);vars.arcs[d.d3plus.shapeType][d.d3plus.id].a=angle(t);return arc(d)}})}selection.each(function(d){var active=vars.active.key?d.d3plus[vars.active.key]:d.d3plus.active,temp=vars.temp.key?d.d3plus[vars.temp.key]:d.d3plus.temp,total=vars.total.key?d.d3plus[vars.total.key]:d.d3plus.total,group=d3.select(this),color=d3plus.variable.color(vars,d);var fill_data=[],hatch_data=[];if(total&&d3plus.apps[vars.type.value].fill){if(temp){var copy=d3plus.utils.copy(d);copy.d3plus.shapeType="temp";fill_data.push(copy);hatch_data=["temp"]}if(active&&(active<total||temp)){var copy=d3plus.utils.copy(d);copy.d3plus.shapeType="active";fill_data.push(copy)}}var pattern=vars.defs.selectAll("pattern#d3plus_hatch_"+d.d3plus.id).data(hatch_data);pattern.selectAll("rect").transition().duration(vars.style.timing.transitions).style("fill",color);pattern.selectAll("line").transition().duration(vars.style.timing.transitions).style("stroke",color);var pattern_enter=pattern.enter().append("pattern").attr("id","d3plus_hatch_"+d.d3plus.id).attr("patternUnits","userSpaceOnUse").attr("x","0").attr("y","0").attr("width","10").attr("height","10").append("g");pattern_enter.append("rect").attr("x","0").attr("y","0").attr("width","10").attr("height","10").attr("fill",color).attr("fill-opacity",.25);function hatch_lines(l){l.attr("stroke",color).attr("stroke-width",1).attr("shape-rendering",vars.style.rendering)}pattern_enter.append("line").attr("x1","0").attr("x2","10").attr("y1","0").attr("y2","10").call(hatch_lines);pattern_enter.append("line").attr("x1","-1").attr("x2","1").attr("y1","9").attr("y2","11").call(hatch_lines);pattern_enter.append("line").attr("x1","9").attr("x2","11").attr("y1","-1").attr("y2","1").call(hatch_lines);var clip_data=fill_data.length?[d]:[];var clip=group.selectAll("#d3plus_clip_"+d.d3plus.id).data(clip_data);clip.enter().insert("clipPath",".d3plus_mouse").attr("id","d3plus_clip_"+d.d3plus.id).append("rect").attr("class","d3plus_clipping").call(init);clip.selectAll("rect").transition().duration(vars.style.timing.transitions).call(update);clip.exit().transition().delay(vars.style.timing.transitions).remove();var fills=group.selectAll("path.d3plus_fill").data(fill_data);fills.transition().duration(vars.style.timing.transitions).call(d3plus.shape.style,vars).call(size);fills.enter().insert("path","rect.d3plus_mouse").attr("class","d3plus_fill").attr("clip-path","url(#d3plus_clip_"+d.d3plus.id+")").transition().duration(0).call(size,0,undefined,0).call(d3plus.shape.style,vars).transition().duration(vars.style.timing.transitions).call(size);fills.exit().transition().duration(vars.style.timing.transitions).call(size,0,undefined,0).remove()})};d3plus.shape.labels=function(vars,selection){remove=function(text){text.transition().duration(vars.style.timing.transitions).attr("opacity",0).remove()};style=function(text,wrap){function x_pos(t){var align=t.anchor||vars.style.labels.align,tspan=this.tagName=="tspan",share=tspan?this.parentNode.className.baseVal=="d3plus_share":this.className.baseVal=="d3plus_share",width=d3.select(this).node().getComputedTextLength();if(align=="middle"||share){var pos=t.x-width/2}else if(align=="end"&&!d3plus.rtl||align=="start"&&d3plus.rtl){var pos=t.x+t.w/2-width}else{var pos=t.x-t.w/2}if(tspan){var t_width=this.getComputedTextLength();if(align=="middle"){if(d3plus.rtl){pos-=(width-t_width)/2}else{pos+=(width-t_width)/2}}else if(align=="end"){if(d3plus.rtl){pos-=width-t_width}else{pos+=width-t_width}}}if(d3plus.rtl){pos+=width}return pos}function y_pos(t){if(d3.select(this).select("tspan").empty()){return 0}else{var align=vars.style.labels.align,height=d3.select(this).node().getBBox().height,diff=parseFloat(d3.select(this).style("font-size"),10)/5;if(this.className.baseVal=="d3plus_share"){var data=d3.select(this.parentNode).datum();var pheight=data.d3plus.r?data.d3plus.r*2:data.d3plus.height;if(align=="end"){var y=t.y-pheight/2+diff/2}else{var y=t.y+pheight/2-height-diff/2}}else{if(align=="middle"||t.valign=="center"){var y=t.y-height/2-diff/2}else if(align=="end"){var y=t.y+t.h/2-height+diff/2}else{var y=t.y-t.h/2-diff}}return y}}text.style("font-weight",vars.style.font.weight).attr("font-family",vars.style.font.family).attr("text-anchor","start").attr("fill",function(t){if(t.color){return t.color}else{var d=d3.select(this.parentNode).datum();return d3plus.color.text(d3plus.shape.color(d,vars))}}).attr("x",x_pos).attr("y",y_pos).attr("transform",function(t){var a=t.angle||0,x=t.translate&&t.translate.x||0,y=t.translate&&t.translate.y||0;return"rotate("+a+","+x+","+y+")"}).each(function(t){if(wrap){if(t.text){d3plus.utils.wordwrap({text:vars.format(t.text*100,"share")+"%",parent:this,width:t.w,height:t.h,resize:t.resize,font_max:70})}else{if(vars.style.labels.align!="middle"){var height=t.h-t.share}else{var height=t.h}d3plus.utils.wordwrap({text:t.names,parent:this,width:t.w,height:height,resize:t.resize})}}}).attr("x",x_pos).attr("y",y_pos).attr("transform",function(t){var a=t.angle||0,x=t.translate&&t.translate.x||0,y=t.translate&&t.translate.y||0;return"rotate("+a+","+x+","+y+")"}).selectAll("tspan").attr("x",x_pos)};if(vars.labels.value){selection.each(function(d){var disabled=d.d3plus&&"label"in d.d3plus&&!d.d3plus.label,stat=d.d3plus&&"static"in d.d3plus&&d.d3plus.static;label=d.d3plus_label,share=d.d3plus_share,names=label&&label.names?label.names:d3plus.variable.text(vars,d),group=d3.select(this),share_size=0,fill=d3plus.apps[vars.type.value].fill;if(["line","area"].indexOf(vars.shape.value)>=0){var background=true}else{var active=vars.active.key?d.d3plus[vars.active.key]:d.d3plus.active,temp=vars.temp.key?d.d3plus[vars.temp.key]:d.d3plus.temp,total=vars.total.key?d.d3plus[vars.total.key]:d.d3plus.total,background=!temp&&!active||active==total}if(!disabled&&(background||!fill)&&!stat){if(share&&share.w>=20&&share.h>=10&&d.d3plus.share&&vars.style.labels.align!="middle"){share.text=d.d3plus.share;if(!("resize"in share)){share.resize=true}var text=group.selectAll("text.d3plus_share").data([share],function(t){return t.w+""+t.h+""+t.text});text.transition().duration(vars.style.timing.transitions/2).call(style,true);text.enter().insert("text",".d3plus_mouse").attr("class","d3plus_share").attr("opacity",0).call(style,true);text.transition().duration(vars.style.timing.transitions/2).delay(vars.style.timing.transitions/2).attr("opacity",.5);share_size=text.node().getBBox().height;text.exit().call(remove)}else{group.selectAll("text.d3plus_share").call(remove)}if(label&&label.w>=20&&label.h>=10&&names.length){label.names=names;if(!("resize"in label)){label.resize=true}label.share=share_size;var text=group.selectAll("text.d3plus_label").data([label],function(t){return t.w+"_"+t.h+"_"+t.x+"_"+t.y+"_"+t.names.join("_")});text.transition().duration(vars.style.timing.transitions/2).call(style,true);text.enter().insert("text",".d3plus_mouse").attr("font-size",vars.style.labels.font.size).attr("class","d3plus_label").attr("opacity",0).call(style,true);text.transition().duration(vars.style.timing.transitions/2).delay(vars.style.timing.transitions/2).attr("opacity",1).call(style,false);text.exit().call(remove);if(text.size()==0||text.html()==""){delete d.d3plus_label;text.remove()}else{if(label.background){var background_data=["background"];var bounds=text.node().getBBox();bounds.width+=vars.style.labels.padding;bounds.height+=vars.style.labels.padding;bounds.x-=vars.style.labels.padding/2;bounds.y-=vars.style.labels.padding/2}else{var background_data=[],bounds={}}var bg=group.selectAll("rect.d3plus_label_bg").data(background_data);function bg_style(elem){var color=vars.style.background=="transparent"?"#ffffff":vars.style.background,fill=label.background===true?color:label.background,a=label.angle||0,x=label.translate?bounds.x+bounds.width/2:0,y=label.translate?bounds.y+bounds.height/2:0,transform="rotate("+a+","+x+","+y+")";elem.attr("fill",fill).attr(bounds).attr("transform",transform)}bg.enter().insert("rect",".d3plus_label").attr("class","d3plus_label_bg").attr("opacity",0).call(bg_style);bg.transition().duration(vars.style.timing.transitions).attr("opacity",.5).call(bg_style);bg.exit().transition().duration(vars.style.timing.transitions).attr("opacity",0).remove()}}else{delete d.d3plus_label;group.selectAll("text.d3plus_label, rect.d3plus_label_bg").call(remove)}}else{delete d.d3plus_label;group.selectAll("text.d3plus_label, rect.d3plus_label_bg").call(remove)}})}else{selection.selectAll("text.d3plus_label, rect.d3plus_label_bg").call(remove)}};d3plus.shape.line=function(vars,selection,enter,exit){var line=d3.svg.line().x(function(d){return d.d3plus.x}).y(function(d){return d.d3plus.y}).interpolate(vars.shape.interpolate.value);var hitarea=vars.style.data.stroke.width;if(hitarea<30){hitarea=30}selection.each(function(d){var step=false,segments=[],nodes=[],temp=d3plus.utils.copy(d),group=d3.select(this);temp.values=[];d.values.forEach(function(v,i,arr){nodes.push(v);var k=v[vars[vars.continuous_axis].key],index=vars.tickValues[vars.continuous_axis].indexOf(k);
if(step===false){step=index}if(i+step==index){temp.values.push(v);temp.key+="_"+segments.length}else{if(i>0){segments.push(temp);temp=d3plus.utils.copy(d);temp.values=[]}temp.values.push(v);temp.key+="_"+segments.length;step++}if(i==arr.length-1){segments.push(temp)}});var paths=group.selectAll("path.d3plus_line").data(segments,function(d){return d.key});paths.enter().append("path").attr("class","d3plus_line").attr("d",function(d){return line(d.values)}).call(d3plus.shape.style,vars);paths.transition().duration(vars.style.timing.transitions).attr("d",function(l){return line(l.values)}).call(d3plus.shape.style,vars);var rects=group.selectAll("rect.d3plus_anchor").data(nodes,function(d){return d.d3plus.id});rects.enter().append("rect").attr("class","d3plus_anchor").attr("id",function(d){return d.d3plus.id}).call(init).call(d3plus.shape.style,vars);rects.transition().duration(vars.style.timing.transitions).call(update).call(d3plus.shape.style,vars);rects.exit().transition().duration(vars.style.timing.transitions).call(init).remove();var mouse=group.selectAll("path.d3plus_mouse").data(segments,function(d){return d.key});mouse.enter().append("path").attr("class","d3plus_mouse").attr("d",function(l){return line(l.values)}).style("stroke","black").style("stroke-width",hitarea).style("fill","none").style("stroke-linecap","round").attr("opacity",0);mouse.on(d3plus.evt.over,function(m){if(!vars.frozen){d3.select(this).style("cursor","pointer");var mouse=d3.event[vars.continuous_axis];positions=d3plus.utils.uniques(d.values,function(x){return x.d3plus[vars.continuous_axis]}),closest=d3plus.utils.closest(positions,mouse);var parent_data=d3.select(this.parentNode).datum();parent_data.data=d.values[positions.indexOf(closest)];parent_data.d3plus=d.values[positions.indexOf(closest)].d3plus;d3.select(this.parentNode).selectAll("path.d3plus_line").transition().duration(vars.style.timing.mouseevents).style("stroke-width",vars.style.data.stroke.width*2);d3.select(this.parentNode).selectAll("rect").transition().duration(vars.style.timing.mouseevents).style("stroke-width",vars.style.data.stroke.width*2).call(update,2)}}).on(d3plus.evt.move,function(d){if(!vars.frozen){var mouse=d3.event.x,positions=d3plus.utils.uniques(d.values,function(x){return x.d3plus.x}),closest=d3plus.utils.closest(positions,mouse);var parent_data=d3.select(this.parentNode).datum();parent_data.data=d.values[positions.indexOf(closest)];parent_data.d3plus=d.values[positions.indexOf(closest)].d3plus}}).on(d3plus.evt.out,function(d){if(!vars.frozen){d3.select(this.parentNode).selectAll("path.d3plus_line").transition().duration(vars.style.timing.mouseevents).style("stroke-width",vars.style.data.stroke.width);d3.select(this.parentNode).selectAll("rect").transition().duration(vars.style.timing.mouseevents).style("stroke-width",vars.style.data.stroke.width).call(update);var parent_data=d3.select(this.parentNode).datum();delete parent_data.data;delete parent_data.d3plus}}).transition().duration(vars.style.timing.transitions).attr("d",function(l){return line(l.values)}).style("stroke-width",hitarea);mouse.exit().remove()});function init(n){n.attr("x",function(d){return d.d3plus.x}).attr("y",function(d){return d.d3plus.y}).attr("width",0).attr("height",0)}function update(n,mod){if(!mod)var mod=0;n.attr("x",function(d){var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width;return d.d3plus.x-(w/2+mod/2)}).attr("y",function(d){var h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;return d.d3plus.y-(h/2+mod/2)}).attr("width",function(d){var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width;return w+mod}).attr("height",function(d){var h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;return h+mod}).attr("rx",function(d){var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width;return(w+mod)/2}).attr("ry",function(d){var h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;return(h+mod)/2})}};d3plus.shape.links=function(vars,links){if(!links)var links=[];function init(l){var opacity=vars.style.links.opacity==1?vars.style.links.opacity:0;l.attr("opacity",opacity).style("stroke-width",0).style("stroke",vars.style.background).style("fill","none")}function style(l){var marker=vars.links.arrows.value?"url(#d3plus_link_marker_default)":"none";l.style("stroke-width",vars.style.links.width).style("stroke",vars.style.links.color).attr("opacity",vars.style.links.opacity).attr("marker-start",function(){return vars.links.arrows.direction.value=="source"?marker:"none"}).attr("marker-end",function(){return vars.links.arrows.direction.value=="target"?marker:"none"})}function line(l){l.attr("x1",function(d){return d.source.d3plus.x}).attr("y1",function(d){return d.source.d3plus.y}).attr("x2",function(d){return d.target.d3plus.x}).attr("y2",function(d){return d.target.d3plus.y})}var diagonal=d3.svg.diagonal(),radial=d3.svg.diagonal().projection(function(d){var r=d.y,a=d.x;return[r*Math.cos(a),r*Math.sin(a)]});function spline(l){l.attr("d",function(d){if(d.source.d3plus.r){var x1=d.source.d3plus.a,y1=d.source.d3plus.r,x2=d.target.d3plus.a,y2=d.target.d3plus.r;return radial({source:{x:x1,y:y1},target:{x:x2,y:y2}})}else{var x1=d.source.d3plus.x,y1=d.source.d3plus.y,x2=d.target.d3plus.x,y2=d.target.d3plus.y;return diagonal({source:{x:x1,y:y1},target:{x:x2,y:y2}})}}).attr("transform",function(d){if(d.d3plus&&d.d3plus.translate){var x=d.d3plus.translate.x||0;var y=d.d3plus.translate.y||0;return"translate("+x+","+y+")"}else{"translate(0,0)"}})}function label(d){if(!d.d3plus){d.d3plus={}}delete d.d3plus_label;if(vars.g.links.selectAll("line, path").size()<vars.links.large&&vars.links.label&&d[vars.links.label]){if("spline"in d.d3plus){var length=this.getTotalLength(),center=this.getPointAtLength(length/2),prev=this.getPointAtLength(length/2-length*.1),next=this.getPointAtLength(length/2+length*.1),radians=Math.atan2(next.y-prev.y,next.x-prev.x),angle=radians*(180/Math.PI),bounding=this.parentNode.getBBox(),width=length*.8,x=d.d3plus.translate.x+center.x,y=d.d3plus.translate.y+center.y,translate={x:d.d3plus.translate.x+center.x,y:d.d3plus.translate.y+center.y}}else{var bounds=this.getBBox();start={x:d.source.d3plus.x,y:d.source.d3plus.y},end={x:d.target.d3plus.x,y:d.target.d3plus.y},xdiff=end.x-start.x,ydiff=end.y-start.y,center={x:end.x-xdiff/2,y:end.y-ydiff/2},radians=Math.atan2(ydiff,xdiff),angle=radians*(180/Math.PI),length=Math.sqrt(xdiff*xdiff+ydiff*ydiff),width=length-vars.style.labels.padding*2,x=center.x,y=center.y,translate={x:center.x,y:center.y}}if(vars.links.arrows.value){var m=typeof vars.links.arrows.value=="number"?typeof vars.links.arrows.value=="number":8;width-=m*2}if(angle<-90||angle>90){angle-=180}d.d3plus_label={x:x,y:y,translate:translate,w:width,h:15,angle:angle,anchor:"middle",valign:"center",color:d3plus.color.legible(vars.style.links.color),resize:false,names:[vars.format(d[vars.links.label])],background:true}}d3plus.shape.labels(vars,d3.select(this.parentNode))}var marker_data=vars.links.arrows.value?["default","highlight"]:[];var marker=vars.defs.selectAll(".d3plus_link_marker").data(marker_data);var m=typeof vars.links.arrows.value=="number"?vars.links.arrows.value:10;var marker_style=function(path){path.attr("d",function(){if(vars.links.arrows.direction.value=="target"){return"M -"+m*.75+",-"+m/2+" L 0,0 L -"+m*.75+","+m/2+" L -"+m*.75+",-"+m/2}else{return"M "+m*.75+",-"+m/2+" L 0,0 L "+m*.75+","+m/2+" L "+m*.75+",-"+m/2}}).attr("fill",function(d){if(d=="default"){return vars.style.links.color}else{return vars.style.highlight.primary}})};marker.enter().append("marker").attr("id",function(d){return"d3plus_link_marker_"+d}).attr("class","d3plus_link_marker").attr("orient","auto").attr("markerWidth",10).attr("markerHeight",10).style("overflow","visible").append("path").attr("opacity",0).call(marker_style);marker.select("path").transition().duration(vars.style.timing.transitions).attr("opacity",1).call(marker_style);marker.exit().transition().duration(vars.style.timing.transitions).attr("opacity",0).remove();var line_data=links.filter(function(l){return!l.d3plus||l.d3plus&&!("spline"in l.d3plus)});var lines=vars.g.links.selectAll("g.d3plus_link_line").data(line_data,function(d){return d.source[vars.id.key]+"_"+d.target[vars.id.key]});lines.selectAll("text.d3plus_label, rect.d3plus_label_bg").transition().duration(vars.style.timing.transitions/2).attr("opacity",0).remove();lines.selectAll("line").transition().duration(vars.style.timing.transitions).call(line).call(style).each("end",label);lines.enter().append("g").attr("class","d3plus_link_line").append("line").call(line).call(init).transition().duration(vars.style.timing.transitions).call(style).each("end",label);lines.exit().transition().duration(vars.style.timing.transitions).attr("opacity",0).remove();var spline_data=links.filter(function(l){return l.d3plus&&l.d3plus.spline});var splines=vars.g.links.selectAll("g.d3plus_link_path").data(spline_data,function(d){return d.source[vars.id.key]+"_"+d.target[vars.id.key]});splines.selectAll("text.d3plus_label, rect.d3plus_label_bg").transition().duration(vars.style.timing.transitions/2).attr("opacity",0).remove();splines.selectAll("path").transition().duration(vars.style.timing.transitions).call(spline).call(style).each("end",label);splines.enter().append("g").attr("class","d3plus_link_path").append("path").call(spline).call(init).transition().duration(vars.style.timing.transitions).call(style).each("end",label);splines.exit().transition().duration(vars.style.timing.transitions).attr("opacity",0).remove()};d3plus.shape.rect=function(vars,selection,enter,exit,transform){function init(nodes){nodes.attr("x",0).attr("y",0).attr("width",0).attr("height",0)}function update(nodes,mod){if(!mod)var mod=0;nodes.attr("x",function(d){var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width;return-w/2-mod/2}).attr("y",function(d){var h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;return-h/2-mod/2}).attr("width",function(d){var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width;return w+mod}).attr("height",function(d){var h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;return h+mod}).attr("rx",function(d){var rounded=vars.shape.value=="circle";var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width;return rounded?(w+mod+2)/2:0}).attr("ry",function(d){var rounded=vars.shape.value=="circle";var h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;return rounded?(h+mod+2)/2:0}).attr("shape-rendering",function(d){if(vars.shape.value=="square"){return vars.style.rendering}else{return"auto"}})}enter.append("rect").attr("class","d3plus_data").call(init).call(d3plus.shape.style,vars);selection.selectAll("rect.d3plus_data").data(function(d){if(vars.labels.value&&!d.d3plus.label){d.d3plus_label={w:0,h:0,x:0,y:0};var w=d.d3plus.r?d.d3plus.r*2:d.d3plus.width,h=d.d3plus.r?d.d3plus.r*2:d.d3plus.height;if(vars.shape.value=="square"){w-=vars.style.labels.padding*2;h-=vars.style.labels.padding*2;d.d3plus_share={w:w,h:h/4,x:0,y:0};d.d3plus_label.w=w;d.d3plus_label.h=h}else{d.d3plus_label.w=Math.sqrt(Math.pow(w,2)*.75)-vars.style.labels.padding;d.d3plus_label.h=Math.sqrt(Math.pow(h,2)*.75)-vars.style.labels.padding}if(d.d3plus_label.w<20&&d.d3plus_label.h<10){delete d.d3plus_label}}else if(d.d3plus.label){d.d3plus_label=d.d3plus.label}return[d]}).transition().duration(vars.style.timing.transitions).call(update).call(d3plus.shape.style,vars);exit.selectAll("rect.d3plus_data").transition().duration(vars.style.timing.transitions).call(init);var mouses=selection.selectAll("rect.d3plus_mouse").data(function(d){return!d.d3plus.static?[d]:[]});mouses.enter().append("rect").attr("class","d3plus_mouse").call(init).attr("opacity",0);mouses.data(function(d){return!d.d3plus.static?[d]:[]}).on(d3plus.evt.over,function(d){if(!vars.frozen){d3.select(this).style("cursor","pointer");d3.select(this.parentNode).selectAll(".d3plus_data").transition().duration(vars.style.timing.mouseevents).attr("opacity",1);d3.select(this.parentNode).transition().duration(vars.style.timing.mouseevents).call(transform,true)}}).on(d3plus.evt.out,function(d){if(!vars.frozen){d3.select(this.parentNode).selectAll(".d3plus_data").transition().duration(vars.style.timing.mouseevents).attr("opacity",vars.style.data.opacity);d3.select(this.parentNode).transition().duration(vars.style.timing.mouseevents).call(transform)}}).transition().duration(vars.style.timing.transitions).call(update,6)};d3plus.shape.style=function(nodes,vars){nodes.style("fill",function(d){if(d.d3plus&&d.d3plus.spline){return"none"}else{return d3plus.shape.color(d,vars)}}).style("stroke",function(d){var color=d3plus.variable.color(vars,d);return d3plus.color.legible(color)}).style("stroke-width",vars.style.data.stroke.width).attr("opacity",vars.style.data.opacity).attr("vector-effect","non-scaling-stroke")};d3plus.styles.default={background:"#ffffff",color:{heatmap:["#00008f","#003fff","#00efff","#ffdf00","#ff3000","#7f0000"],missing:"#eeeeee",range:["#ff0000","#888888","#00ff00"]},data:{donut:{size:.35},opacity:.9,stroke:{width:1}},font:{family:"sans-serif",weight:"normal"},group:{background:true},info:{"font-size":20},labels:{align:"middle",padding:7,segments:2,font:{family:"sans-serif",weight:"normal",size:10}},legend:{align:"middle",gradient:{height:10},label:{color:"#444",family:"sans-serif",weight:"normal",size:12},padding:5,size:[10,30],tick:{align:"middle",color:"#444",family:"sans-serif",weight:"normal",size:10}},links:{color:"#dedede",opacity:1,width:1},highlight:{primary:"#cc0000",secondary:"#ffdddd"},rendering:"crispEdges",ticks:{color:"#ccc",font:{color:"#888",size:12},width:1},timeline:{align:"middle",background:"#eeeeee",brush:{color:"#444",opacity:.2},handles:{color:"#888",hover:"#aaa",size:3},height:20,label:{color:"#444",family:"sans-serif",weight:"normal",size:12},padding:5,tick:{align:"middle",color:"#444",family:"sans-serif",weight:"normal",size:10}},timing:{mouseevents:60,transitions:600},title:{align:"middle",height:null,width:null},tooltip:{anchor:"top center",background:"white",curtain:{color:"#ffffff",opacity:.8},font:{color:"#333",family:"sans-serif",size:"12px",weight:"normal"},width:200}};d3plus.tooltip.app=function(params){var vars=params.vars,d=params.data,ex=params.ex,mouse=params.mouseevents?params.mouseevents:false,arrow=params.arrow?params.arrow:true,id=d3plus.variable.value(vars,d,vars.id.key);if(d3.event.type=="click"&&(vars.html.value||vars.tooltip.value.long)){var fullscreen=true,arrow=false,mouse=true,length="long",footer=vars.footer.value;vars.covered=true}else{var fullscreen=false,align=vars.style.tooltip.anchor,length="short",footer=vars.footer_text()}if(params.x){var x=params.x}else if(d3plus.apps[vars.type.value].tooltip=="follow"){var x=d3.mouse(vars.parent.node())[0]}else{var x=d.d3plus.x+vars.margin.left}if(params.y){var y=params.y}else if(d3plus.apps[vars.type.value].tooltip=="follow"){var y=d3.mouse(vars.parent.node())[1]}else{var y=d.d3plus.y+vars.margin.top}if(params.offset){var offset=params.offset}else if(d3plus.apps[vars.type.value].tooltip=="follow"){var offset=3}else{var offset=d.d3plus.r?d.d3plus.r:d.d3plus.height/2}function make_tooltip(html){var active=vars.active.key?d3plus.variable.value(vars,d,vars.active.key):d.d3plus.active,temp=vars.temp.key?d3plus.variable.value(vars,d,vars.temp.key):d.d3plus.temp,total=vars.total.key?d3plus.variable.value(vars,d,vars.total.key):d.d3plus.total;if(typeof active=="number"&&active>0&&total){if(!ex)ex={};var label=vars.active.key||"active";ex[label]=active+"/"+total+" ("+vars.format(active/total*100,"share")+"%)"}if(typeof temp=="number"&&temp>0&&total){if(!ex)ex={};var label=vars.temp.key||"temp";ex[label]=temp+"/"+total+" ("+vars.format(temp/total*100,"share")+"%)"}if(d.d3plus.share){if(!ex)ex={};ex.share=vars.format(d.d3plus.share*100,"share")+"%"}var icon=d3plus.variable.value(vars,d,vars.icon.key),title=d3plus.variable.value(vars,d,vars.text.key),tooltip_data=d3plus.tooltip.data(vars,d,length,ex);if(tooltip_data.length>0||!d.d3plus_label){if(!title){title=id}var depth=d.d3plus&&"depth"in d.d3plus?vars.id.nesting[d.d3plus.depth]:vars.id.key;if(typeof vars.icon.style.value=="string"){var icon_style=vars.icon.style.value}else if(typeof vars.icon.style.value=="object"&&vars.icon.style.value[depth]){var icon_style=vars.icon.style.value[depth]}else{var icon_style="default"}if(!fullscreen&&tooltip_data.length==0){var width="auto"}else{var width=vars.style.tooltip.width}d3plus.tooltip.create({align:align,arrow:arrow,background:vars.style.tooltip.background,curtain:vars.style.tooltip.curtain.color,curtainopacity:vars.style.tooltip.curtain.opacity,fontcolor:vars.style.tooltip.font.color,fontfamily:vars.style.tooltip.font.family,fontsize:vars.style.tooltip.font.size,fontweight:vars.style.tooltip.font.weight,data:tooltip_data,color:d3plus.variable.color(vars,d),footer:footer,fullscreen:fullscreen,html:html,icon:icon,id:vars.type.value,max_width:vars.style.tooltip.width,mouseevents:mouse,offset:offset,parent:vars.parent,style:icon_style,title:title,width:width,x:x,y:y})}}if(fullscreen){if(typeof vars.html.value=="string"){make_tooltip(vars.html.value)}else if(typeof vars.html.value=="function"){make_tooltip(vars.html.value(id))}else if(vars.html.value&&typeof vars.html.value=="object"&&vars.html.value.url){d3.json(vars.html.value.url,function(data){var html=vars.html.value.callback?vars.html.value.callback(data):data;make_tooltip(html)})}else{make_tooltip("")}}else{make_tooltip("")}};d3plus.tooltip.arrow=function(arrow){arrow.style("bottom",function(d){if(d.anchor.y!="center"&&!d.flip)return"-5px";else return"auto"}).style("top",function(d){if(d.anchor.y!="center"&&d.flip)return"-5px";else if(d.anchor.y=="center")return"50%";else return"auto"}).style("left",function(d){if(d.anchor.y=="center"&&d.flip)return"-5px";else if(d.anchor.y!="center")return"50%";else return"auto"}).style("right",function(d){if(d.anchor.y=="center"&&!d.flip)return"-5px";else return"auto"}).style("margin-left",function(d){if(d.anchor.y=="center"){return"auto"}else{if(d.anchor.x=="right"){var arrow_x=-d.width/2+d.arrow_offset/2}else if(d.anchor.x=="left"){var arrow_x=d.width/2-d.arrow_offset*2-5}else{var arrow_x=-5}if(d.cx-d.width/2-5<arrow_x){arrow_x=d.cx-d.width/2-5;if(arrow_x<2-d.width/2)arrow_x=2-d.width/2}else if(-(d.limit[0]-d.cx-d.width/2+5)>arrow_x){var arrow_x=-(d.limit[0]-d.cx-d.width/2+5);if(arrow_x>d.width/2-11)arrow_x=d.width/2-11}return arrow_x+"px"}}).style("margin-top",function(d){if(d.anchor.y!="center"){return"auto"}else{if(d.anchor.y=="bottom"){var arrow_y=-d.height/2+d.arrow_offset/2-1}else if(d.anchor.y=="top"){var arrow_y=d.height/2-d.arrow_offset*2-2}else{var arrow_y=-9}if(d.cy-d.height/2-d.arrow_offset<arrow_y){arrow_y=d.cy-d.height/2-d.arrow_offset;if(arrow_y<4-d.height/2)arrow_y=4-d.height/2}else if(-(d.limit[1]-d.cy-d.height/2+d.arrow_offset)>arrow_y){var arrow_y=-(d.limit[1]-d.cy-d.height/2+d.arrow_offset);if(arrow_y>d.height/2-22)arrow_y=d.height/2-22}return arrow_y+"px"}})};d3plus.tooltip.create=function(params){var default_width=params.fullscreen?250:200;params.width=params.width||default_width;params.max_width=params.max_width||386;params.id=params.id||"default";params.size=params.fullscreen||params.html?"large":"small";params.offset=params.offset||0;params.arrow_offset=params.arrow?8:0;params.x=params.x||0;params.y=params.y||0;params.color=params.color||"#333";params.parent=params.parent||d3.select("body");params.curtain=params.curtain||"#fff";params.curtainopacity=params.curtainopacity||.8;params.background=params.background||"#fff";params.fontcolor=params.fontcolor||"#333";params.fontfamily=params.fontfamily||"sans-serif";params.fontweight=params.fontweight||"normal";params.fontsize=params.fontsize||"12px";params.style=params.style||"default";params.zindex=params.size=="small"?2e3:500;if(!params.iconsize){params.iconsize=params.size=="small"?22:50}params.limit=[parseFloat(params.parent.style("width"),10),parseFloat(params.parent.style("height"),10)];var close_descriptions=function(){d3.selectAll("div.d3plus_tooltip_data_desc").style("height","0px");d3.selectAll("div.d3plus_tooltip_data_help").style("background-color","#ccc")};d3plus.tooltip.remove(params.id);params.anchor={};if(params.fullscreen){params.anchor.x="center";params.anchor.y="center";params.x=params.parent?params.parent.node().offsetWidth/2:window.innerWidth/2;params.y=params.parent?params.parent.node().offsetHeight/2:window.innerHeight/2}else if(params.align){var a=params.align.split(" ");params.anchor.y=a[0];if(a[1])params.anchor.x=a[1];else params.anchor.x="center"}else{params.anchor.x="center";params.anchor.y="top"}var title_width=params.width-30;if(params.fullscreen){var curtain=params.parent.append("div").attr("id","d3plus_tooltip_curtain_"+params.id).attr("class","d3plus_tooltip_curtain").style("background-color",params.curtain).style("opacity",params.curtainopacity).style("position","absolute").style("z-index",499).style("top","0px").style("right","0px").style("bottom","0px").style("left","0px").on(d3plus.evt.click,function(){d3plus.tooltip.remove(params.id)})}var tooltip=params.parent.append("div").datum(params).attr("id","d3plus_tooltip_id_"+params.id).attr("class","d3plus_tooltip d3plus_tooltip_"+params.size).style("color",params.fontcolor).style("font-family",params.fontfamily).style("font-weight",params.fontweight).style("font-size",params.fontsize).style("position","absolute").style("z-index",params.zindex).on(d3plus.evt.out,function(){close_descriptions()});if(params.max_height){tooltip.style("max-height",params.max_height+"px")}if(params.fixed){tooltip.style("z-index",500);params.mouseevents=true}else{tooltip.style("z-index",2e3)}var container=tooltip.append("div").datum(params).attr("class","d3plus_tooltip_container").style("background-color",params.background);if(params.fullscreen&&params.html){w=params.parent?params.parent.node().offsetWidth*.75:window.innerWidth*.75;h=params.parent?params.parent.node().offsetHeight*.75:window.innerHeight*.75;container.style("width",w+"px").style("height",h+"px");var body=container.append("div").attr("class","d3plus_tooltip_body").style("display","inline-block").style("z-index",1).style("width",params.width+"px")}else{if(params.width=="auto"){var w="auto";container.style("max-width",params.max_width+"px")}else var w=params.width-14+"px";var body=container.style("width",w)}if(params.title||params.icon){var header=body.append("div").attr("class","d3plus_tooltip_header").style("position","relative").style("z-index",1)}if(params.fullscreen){var close=tooltip.append("div").attr("class","d3plus_tooltip_close").style("background-color",params.color).style("color",d3plus.color.text(params.color)).style("position","absolute").html("&times;").on(d3plus.evt.click,function(){d3plus.tooltip.remove(params.id)})}if(!params.mouseevents){tooltip.style("pointer-events","none")}else if(params.mouseevents!==true){var oldout=d3.select(params.mouseevents).on(d3plus.evt.out);var newout=function(){var target=d3.event.toElement||d3.event.relatedTarget;if(target){var c=typeof target.className=="string"?target.className:target.className.baseVal;var istooltip=c.indexOf("d3plus_tooltip")==0}else{var istooltip=false}if(!target||!ischild(tooltip.node(),target)&&!ischild(params.mouseevents,target)&&!istooltip){oldout(d3.select(params.mouseevents).datum());close_descriptions();d3.select(params.mouseevents).on(d3plus.evt.out,oldout)}};var ischild=function(parent,child){var node=child.parentNode;while(node!=null){if(node==parent){return true}node=node.parentNode}return false};d3.select(params.mouseevents).on(d3plus.evt.out,newout);tooltip.on(d3plus.evt.out,newout);var move_event=d3.select(params.mouseevents).on(d3plus.evt.move);if(move_event){tooltip.on(d3plus.evt.move,move_event)}}if(params.arrow){var arrow=tooltip.append("div").attr("class","d3plus_tooltip_arrow").style("background-color",params.background).style("position","absolute")}if(params.icon){var title_icon=header.append("div").attr("class","d3plus_tooltip_icon").style("width",params.iconsize+"px").style("height",params.iconsize+"px").style("z-index",1).style("background-position","50%").style("background-size","100%").style("background-image","url("+params.icon+")").style("display","inline-block");if(params.style=="knockout"){title_icon.style("background-color",params.color)}title_width-=title_icon.node().offsetWidth}if(params.title){var mw=params.max_width-6;if(params.icon)mw-=params.iconsize+6;mw+="px";var title=header.append("div").attr("class","d3plus_tooltip_title").style("max-width",mw).style("vertical-align","top").style("width",title_width+"px").style("display","inline-block").style("overflow","hidden").style("text-overflow","ellipsis").style("word-wrap","break-word").style("z-index",1).text(params.title)}if(params.description){var description=body.append("div").attr("class","d3plus_tooltip_description").text(params.description)}if(params.data||params.html&&!params.fullscreen){var data_container=body.append("div").attr("class","d3plus_tooltip_data_container")}if(params.data){var val_width=0,val_heights={};var last_group=null;params.data.forEach(function(d,i){if(d.group){if(last_group!=d.group){last_group=d.group;data_container.append("div").attr("class","d3plus_tooltip_data_title").text(d.group)}}var block=data_container.append("div").attr("class","d3plus_tooltip_data_block").datum(d);if(d.highlight){block.style("color",d3plus.color.legible(params.color))}var name=block.append("div").attr("class","d3plus_tooltip_data_name").html(d.name).on(d3plus.evt.out,function(){d3.event.stopPropagation()});var val=block.append("div").attr("class","d3plus_tooltip_data_value").text(d.value).on(d3plus.evt.out,function(){d3.event.stopPropagation()});if(d3plus.rtl){val.style("left","6px")}else{val.style("right","6px")}if(params.mouseevents&&d.desc){var desc=block.append("div").attr("class","d3plus_tooltip_data_desc").text(d.desc).on(d3plus.evt.out,function(){d3.event.stopPropagation()});var dh=desc.node().offsetHeight;desc.style("height","0px");var help=name.append("div").attr("class","d3plus_tooltip_data_help").text("?").on(d3plus.evt.over,function(){var c=d3.select(this.parentNode.parentNode).style("color");d3.select(this).style("background-color",c);desc.style("height",dh+"px")}).on(d3plus.evt.out,function(){d3.event.stopPropagation()});name.style("cursor","pointer").on(d3plus.evt.over,function(){close_descriptions();var c=d3.select(this.parentNode).style("color");help.style("background-color",c);desc.style("height",dh+"px")});block.on(d3plus.evt.out,function(){d3.event.stopPropagation();close_descriptions()})}var w=parseFloat(val.style("width"),10);if(w>params.width/2)w=params.width/2;if(w>val_width)val_width=w;if(i!=params.data.length-1){if(d.group&&d.group==params.data[i+1].group||!d.group&&!params.data[i+1].group)data_container.append("div").attr("class","d3plus_tooltip_data_seperator")}});data_container.selectAll(".d3plus_tooltip_data_name").style("width",function(){var w=parseFloat(d3.select(this.parentNode).style("width"),10);return w-val_width-30+"px"});data_container.selectAll(".d3plus_tooltip_data_value").style("width",val_width+"px").each(function(d){var h=parseFloat(d3.select(this).style("height"),10);val_heights[d.name]=h});data_container.selectAll(".d3plus_tooltip_data_name").style("min-height",function(d){return val_heights[d.name]+"px"})}if(params.html&&!params.fullscreen){data_container.append("div").html(params.html)}var footer=body.append("div").attr("class","d3plus_tooltip_footer");if(params.footer){footer.html(params.footer)}params.height=tooltip.node().offsetHeight;if(params.html&&params.fullscreen){var h=params.height-12;var w=tooltip.node().offsetWidth-params.width-44;container.append("div").attr("class","d3plus_tooltip_html").style("width",w+"px").style("height",h+"px").html(params.html)}params.width=tooltip.node().offsetWidth;if(params.anchor.y!="center")params.height+=params.arrow_offset;else params.width+=params.arrow_offset;if(params.data||!params.fullscreen&&params.html){if(!params.fullscreen&&params.html){var parent_height=params.parent.node().offsetHeight;var limit=params.fixed?parent_height-params.y-10:parent_height-10;var h=params.height<limit?params.height:limit}else{var h=params.height}h-=parseFloat(container.style("padding-top"),10);h-=parseFloat(container.style("padding-bottom"),10);if(header){h-=header.node().offsetHeight;h-=parseFloat(header.style("padding-top"),10);h-=parseFloat(header.style("padding-bottom"),10)}if(footer){h-=footer.node().offsetHeight;h-=parseFloat(footer.style("padding-top"),10);h-=parseFloat(footer.style("padding-bottom"),10)}data_container.style("max-height",h+"px")}params.height=tooltip.node().offsetHeight;d3plus.tooltip.move(params.x,params.y,params.id)};d3plus.tooltip.data=function(vars,id,length,extras){if(!length)var length="long";if(length=="long"){var other_length="short"}else{var other_length="long"}var extra_data={};if(extras&&typeof extras=="string")extras=[extras];else if(extras&&typeof extras=="object"){extra_data=d3plus.utils.merge(extra_data,extras);var extras=[];for(k in extra_data){extras.push(k)}}else if(!extras)var extras=[];var tooltip_highlights=[];if(vars.tooltip.value instanceof Array){var a=vars.tooltip.value}else if(typeof vars.tooltip.value=="string"){var a=[vars.tooltip.value]}else{if(vars.tooltip.value[vars.id.nesting[vars.depth.value]]){var a=vars.tooltip.value[vars.id.nesting[vars.depth.value]]}else{var a=vars.tooltip.value}if(!(a instanceof Array)){if(a[length]){a=a[length]}else if(a[other_length]){a=[]}else{a=d3plus.utils.merge({"":[]},a)}}if(typeof a=="string"){a=[a]}else if(!(a instanceof Array)){a=d3plus.utils.merge({"":[]},a)}}function format_key(key,group){if(vars.attrs.value[group])var id_var=group;else var id_var=null;if(group)group=vars.format(group);var value=extra_data[key]||d3plus.variable.value(vars,id,key,id_var);if(value!==false&&value!==null){var name=vars.format(key),h=tooltip_highlights.indexOf(key)>=0;var val=vars.format(value,key);var obj={name:name,value:val,highlight:h,group:group};if(vars.descs[key])obj.desc=vars.descs[key];if(val)tooltip_data.push(obj)}}var tooltip_data=[];if(a instanceof Array){extras.forEach(function(e){if(a.indexOf(e)<0)a.push(e)});a.forEach(function(t){format_key(t)})}else{if(vars.id.nesting.length&&vars.depth.value<vars.id.nesting.length-1){var a=d3plus.utils.copy(a);vars.id.nesting.forEach(function(n,i){if(i>vars.depth.value&&a[n])delete a[n]})}if(vars.tooltip.value.long&&typeof vars.tooltip.value.long=="object"){var placed=[];for(group in vars.tooltip.value.long){extras.forEach(function(e){if(vars.tooltip.value.long[group].indexOf(e)>=0&&(a[group]&&a[group].indexOf(e)<0||!a[group])){if(!a[group])a[group]=[];a[group].push(e);placed.push(e)}else if(a[group]&&a[group].indexOf(e)>=0){placed.push(e)}})}extras.forEach(function(e){if(placed.indexOf(e)<0){if(!a[""])a[""]=[];a[""].push(e)}})}else{var present=[];for(group in a){extras.forEach(function(e){if(a[group]instanceof Array&&a[group].indexOf(e)>=0){present.push(e)}else if(typeof a[group]=="string"&&a[group]==e){present.push(e)}})}if(present.length!=extras.length){if(!a[""])a[""]=[];extras.forEach(function(e){if(present.indexOf(e)<0){a[""].push(e)}})}}if(a[""]){a[""].forEach(function(t){format_key(t,"")});delete a[""]}for(group in a){if(a[group]instanceof Array){a[group].forEach(function(t){format_key(t,group)})}else if(typeof a[group]=="string"){format_key(a[group],group)}}}return tooltip_data};d3plus.tooltip.move=function(x,y,id){if(!id)var tooltip=d3.select("div#d3plus_tooltip_id_default");else var tooltip=d3.select("div#d3plus_tooltip_id_"+id);if(tooltip.node()){var d=tooltip.datum();d.cx=x;d.cy=y;if(!d.fixed){if(d.anchor.y!="center"){if(d.anchor.x=="right"){d.x=d.cx-d.arrow_offset-4}else if(d.anchor.x=="center"){d.x=d.cx-d.width/2}else if(d.anchor.x=="left"){d.x=d.cx-d.width+d.arrow_offset+2}if(d.anchor.y=="bottom"){d.flip=d.cy+d.height+d.offset<=d.limit[1]}else if(d.anchor.y=="top"){d.flip=d.cy-d.height-d.offset<0}if(d.flip){d.y=d.cy+d.offset+d.arrow_offset}else{d.y=d.cy-d.height-d.offset-d.arrow_offset}}else{d.y=d.cy-d.height/2;if(d.anchor.x=="right"){d.flip=d.cx+d.width+d.offset<=d.limit[0]
}else if(d.anchor.x=="left"){d.flip=d.cx-d.width-d.offset<0}if(d.anchor.x=="center"){d.flip=false;d.x=d.cx-d.width/2}else if(d.flip){d.x=d.cx+d.offset+d.arrow_offset}else{d.x=d.cx-d.width-d.offset}}if(d.x<0){d.x=0}else if(d.x+d.width>d.limit[0]){d.x=d.limit[0]-d.width}if(d.y<0){d.y=0}else if(d.y+d.height>d.limit[1]){d.y=d.limit[1]-d.height}}tooltip.style("top",d.y+"px").style("left",d.x+"px");if(d.arrow){tooltip.selectAll(".d3plus_tooltip_arrow").call(d3plus.tooltip.arrow)}}};d3plus.tooltip.remove=function(id){if(id){d3.selectAll("div#d3plus_tooltip_curtain_"+id).remove();d3.selectAll("div#d3plus_tooltip_id_"+id).remove()}else{d3.selectAll("div#d3plus_tooltip_curtain").remove();d3.selectAll("div.d3plus_tooltip").remove()}};d3plus.color.scale=d3.scale.category20();d3plus.color.random=function(x){var rand_int=x||Math.floor(Math.random()*20);return d3plus.color.scale(rand_int)};d3plus.color.darker=function(color,increment){var c=d3.hsl(color);if(!increment){var increment=.2}c.l-=increment;if(c.l<0){c.l=0}return c.toString()};d3plus.color.legible=function(color){var hsl=d3.hsl(color);if(hsl.s>.9)hsl.s=.9;if(hsl.l>.4)hsl.l=.4;return hsl.toString()};d3plus.color.lighter=function(color,increment){var c=d3.hsl(color);if(!increment){var increment=.1}c.l+=increment;c.s-=increment/2;if(c.l>1){c.l=1}if(c.s<0){c.s=0}return c.toString()};d3plus.color.mix=function(c1,c2,o1,o2){if(!o1)var o1=1;if(!o2)var o2=1;c1=d3.rgb(c1);c2=d3.rgb(c2);var r=(o1*c1.r+o2*c2.r-o1*o2*c2.r)/(o1+o2-o1*o2),g=(o1*c1.g+o2*c2.g-o1*o2*c2.g)/(o1+o2-o1*o2),b=(o1*c1.b+o2*c2.b-o1*o2*c2.b)/(o1+o2-o1*o2);return d3.rgb(r,g,b).toString()};d3plus.color.text=function(color){var hsl=d3.hsl(color),light="#ffffff",dark="#444444";if(hsl.l>.65)return dark;else if(hsl.l<.49)return light;return hsl.h>35&&hsl.s>=.3?dark:light};d3plus.utils.buckets=function(arr,buckets){var return_arr=[],step=1/(buckets-1)*(arr[1]-arr[0]),i=step;for(var i=arr[0];i<=arr[1];i=i+step){return_arr.push(i)}if(return_arr.length<buckets){return_arr[buckets-1]=arr[1]}if(return_arr[return_arr.length-1]<arr[1]){return_arr[return_arr.length-1]=arr[1]}return return_arr};d3plus.utils.closest=function(arr,value){var closest=arr[0];arr.forEach(function(p){if(Math.abs(value-p)<Math.abs(value-closest)){closest=p}});return closest};d3plus.utils.copy=function(obj){return d3plus.utils.merge(obj)};d3plus.utils.dataurl=function(url,callback){var img=new Image;img.src=url;img.crossOrigin="Anonymous";img.onload=function(){var canvas=document.createElement("canvas");canvas.width=this.width;canvas.height=this.height;var ctx=canvas.getContext("2d");ctx.drawImage(this,0,0);callback.call(this,canvas.toDataURL("image/png"));canvas=null}};d3plus.utils.merge=function(obj1,obj2){var obj3={};function copy_object(obj,ret){for(var a in obj){if(typeof obj[a]!="undefined"){if(typeof obj[a]=="object"&&!(obj[a]instanceof Array)&&obj[a]!==null){if(typeof ret[a]!="object")ret[a]={};copy_object(obj[a],ret[a])}else if(typeof ret[a]!=typeof obj[a]){ret[a]=obj[a]}else{ret[a]=obj[a]}}}}if(obj1)copy_object(obj1,obj3);if(obj2)copy_object(obj2,obj3);return obj3};d3plus.utils.strip=function(str){var removed=["!","@","#","$","%","^","&","*","(",")","[","]","{","}",".",",","/","\\","|","'",'"',";",":","<",">","?","=","+"];return str.replace(/[^A-Za-z0-9\-_]/g,function(chr){if(" "==chr){return"_"}else if(removed.indexOf(chr)>=0){return""}var diacritics=[[/[\300-\306]/g,"A"],[/[\340-\346]/g,"a"],[/[\310-\313]/g,"E"],[/[\350-\353]/g,"e"],[/[\314-\317]/g,"I"],[/[\354-\357]/g,"i"],[/[\322-\330]/g,"O"],[/[\362-\370]/g,"o"],[/[\331-\334]/g,"U"],[/[\371-\374]/g,"u"],[/[\321]/g,"N"],[/[\361]/g,"n"],[/[\307]/g,"C"],[/[\347]/g,"c"]];var ret="";for(d in diacritics){if(diacritics[d][0].test(chr)){ret=diacritics[d][1];break}}return ret})};d3plus.utils.uniques=function(data,value){var type=null;return d3.nest().key(function(d){if(typeof value=="string"){if(!type)type=typeof d[value];return d[value]}else if(typeof value=="function"){if(!type)type=typeof value(d);return value(d)}else{return d}}).entries(data).reduce(function(a,b){var val=b.key;if(type=="number")val=parseFloat(val);return a.concat(val)},[]).sort(function(a,b){return a-b})};d3plus.variable.value=function(vars,id,variable,id_var,agg){if(!id_var){if(variable&&typeof variable=="object"){if(variable[vars.id.key]){var id_var=vars.id.key}else{var id_var=Object.keys(variable)[0]}variable=variable[id_var]}else{var id_var=vars.id.key}}if(variable&&typeof variable=="function"){return variable(id)}function filter_array(arr){return arr.filter(function(d){return d[id_var]==id})[0]}var value_array=[];function check_children(obj){if(obj.children){obj.children.forEach(function(c){check_children(c)})}else if(obj[variable]){value_array.push(obj[variable])}}if(typeof id=="object"&&typeof id[variable]!="undefined"){return id[variable]}else if(typeof id=="object"&&id.children){if(!agg){var agg="sum";if(typeof vars.aggs.value=="string"){agg=vars.aggs.value}else if(vars.aggs.value[variable]){agg=vars.aggs.value[variable]}}check_children(id);if(value_array.length){if(typeof agg=="string"){return d3[agg](value_array)}else if(typeof agg=="function"){return agg(value_array)}}var dat=id;id=dat[id_var]}else{if(typeof id=="object"){var dat=id;id=id[id_var]}if(id_var==vars.id.key){if(vars.data.app instanceof Array){var dat=filter_array(vars.data.app)}else if(typeof vars.data.app=="object"&&vars.data.app!==null){var dat=vars.data.app[id]}}if(dat&&typeof dat[variable]!="undefined")return dat[variable]}if(vars.attrs.value instanceof Array){var attr=filter_array(vars.attrs.value)}else if(vars.attrs.value[id_var]){if(vars.attrs.value[id_var]instanceof Array){var attr=filter_array(vars.attrs.value[id_var])}else{var attr=vars.attrs.value[id_var][id]}}else{var attr=vars.attrs.value[id]}if(attr&&typeof attr[variable]!="undefined")return attr[variable];return null};d3plus.variable.color=function(vars,id,level){function get_random(c){if(typeof c=="object"){c=vars.color.key?d3plus.variable.value(vars,c,vars.color.key):c[vars.id.key]}return d3plus.color.random(c)}function validate_color(c){if(c.indexOf("#")==0&&[4,7].indexOf(c.length)>=0)return true;else return false}if(!vars.color.key){return get_random(id)}else{var color=d3plus.variable.value(vars,id,vars.color.key,level);if(!color&&typeof vars.color_scale=="function"){color=vars.style.color.missing}else if(!color){return get_random(id)}if(typeof color=="string"){var true_color=validate_color(color);return true_color?color:get_random(color)}else return vars.color_scale(color)}};d3plus.variable.text=function(vars,obj,depth){if(typeof depth!="number")var depth=vars.depth.value;if(vars.text.array&&typeof vars.text.array=="object"){if(vars.text.array[vars.id.nesting[depth]]){var text_keys=vars.text.array[vars.id.nesting[depth]]}else{var text_keys=vars.text.array[Object.keys(vars.text.array)[0]]}}else{var text_keys=[];if(vars.text.key)text_keys.push(vars.text.key);text_keys.push(vars.id.nesting[depth])}if(typeof text_keys=="string"){text_keys=[text_keys]}var names=[];text_keys.forEach(function(t){var name=d3plus.variable.value(vars,obj,t,vars.id.nesting[depth]);if(name)names.push(name)});return names};d3plus.utils.wordwrap=function(params){var parent=params.parent,width=params.width?params.width:2e4,height=params.height?params.height:2e4,resize=params.resize,font_max=params.font_max?params.font_max:40,font_min=params.font_min?params.font_min:9,text_array=params.text.slice(0),split=["-","/",";",":","%","&"],regex=new RegExp("[^\\s\\"+split.join("\\")+"]+\\"+split.join("?\\")+"?","g"),current_text="";if(text_array instanceof Array){current_text=String(text_array.shift())}else{current_text=String(text_array)}wrap();function wrap(){var words=current_text.match(regex);if(resize){var size=font_max;size=Math.floor(size);d3.select(parent).attr("font-size",size);d3.select(parent).selectAll("tspan").remove();for(var i=0;i<words.length;i++){if(words.length==1)var t=words[i];else var t=words[i]+"...";d3.select(parent).append("tspan").attr("x",0).text(t)}if(parent.getBBox().width>width)size=size*(width/parent.getBBox().width);if(size<font_min){d3.select(parent).selectAll("tspan").remove();if(typeof text_array=="string"||text_array.length==0)return;else{current_text=String(text_array.shift());wrap()}return}size=Math.floor(size);d3.select(parent).attr("font-size",size);flow();if(parent.childNodes.length*parent.getBBox().height>height){var temp_size=size*(height/(parent.childNodes.length*parent.getBBox().height));if(temp_size<font_min)size=font_min;else size=temp_size;size=Math.floor(size);d3.select(parent).attr("font-size",size)}else finish()}flow();truncate();finish();function flow(){d3.select(parent).selectAll("tspan").remove();var x_pos=parent.getAttribute("x");var tspan=d3.select(parent).append("tspan").attr("x",x_pos).text(words[0]);for(var i=1;i<words.length;i++){var current=tspan.text(),last_char=current.slice(-1),next_char=current_text.charAt(current_text.indexOf(current)+current.length);joiner=next_char==" "?" ":"";tspan.text(current+joiner+words[i]);if(tspan.node().getComputedTextLength()>width){tspan.text(current);tspan=d3.select(parent).append("tspan").attr("x",x_pos).text(words[i])}}}function truncate(){var cut=false;while(parent.childNodes.length*parent.getBBox().height>height&&parent.lastChild&&!cut){parent.removeChild(parent.lastChild);if(parent.childNodes.length*parent.getBBox().height<height&&parent.lastChild)cut=true}if(cut){tspan=parent.lastChild;words=d3.select(tspan).text().match(/[^\s-]+-?/g);var last_char=words[words.length-1].charAt(words[words.length-1].length-1);if(last_char==","||last_char==";"||last_char==":")words[words.length-1]=words[words.length-1].substr(0,words[words.length-1].length-1);d3.select(tspan).text(words.join(" ")+"...");if(tspan.getComputedTextLength()>width){if(words.length>1)words.pop(words.length-1);last_char=words[words.length-1].charAt(words[words.length-1].length-1);if(last_char==","||last_char==";"||last_char==":")words[words.length-1].substr(0,words[words.length-1].length-2);d3.select(tspan).text(words.join(" ")+"...")}}}}function finish(){d3.select(parent).selectAll("tspan").attr("dy",d3.select(parent).style("font-size"));return}};d3plus.zoom.bounds=function(vars,b){vars.viewport=b;if(vars.coords.fit.value=="auto"){var aspect=Math.max((b[1][0]-b[0][0])/vars.app_width,(b[1][1]-b[0][1])/vars.app_height)}else{var w=vars.coords.fit.value=="width"?b[1][0]-b[0][0]:b[1][1]-b[0][1],aspect=w/vars["app_"+vars.coords.fit.value]}var min=d3.min([vars.app_width,vars.app_height]);vars.zoom.scale=(min-vars.coords.padding*2)/min/aspect;var translate=[-(b[1][0]+b[0][0])/2,-(b[1][1]+b[0][1])/2];vars.zoom.translate=translate;vars.g.zoom.attr("transform","translate("+[vars.app_width/2,vars.app_height/2]+")"+"scale("+vars.zoom.scale+")"+"translate("+vars.zoom.translate[0]+","+vars.zoom.translate[1]+")")};d3plus.zoom.controls=function(){d3.select("#d3plus.utilsts.zoom_controls").remove();if(!vars.small){var zoom_enter=vars.parent.append("div").attr("id","d3plus.utilsts.zoom_controls").style("top",vars.margin.top+5+"px");zoom_enter.append("div").attr("id","zoom_in").attr("unselectable","on").on(d3plus.evt.click,function(){vars.zoom("in")}).text("+");zoom_enter.append("div").attr("id","zoom_out").attr("unselectable","on").on(d3plus.evt.click,function(){vars.zoom("out")}).text("-");zoom_enter.append("div").attr("id","zoom_reset").attr("unselectable","on").on(d3plus.evt.click,function(){vars.zoom("reset");vars.update()}).html("&#8634;")}};d3plus.zoom.reset=function(vars){d3plus.zoom.bounds(vars,vars.bounds)}})();